<!DOCTYPE html>
<html lang="pt-PT" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionKrono - Gest√£o de Eventos</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VisionKrono">
    <meta name="description" content="Sistema de gest√£o de eventos VisionKrono">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="kromi-design-system.css">
        <link rel="stylesheet" href="kromi-layout-fixes.css">
        <script src="kromi-sidebar-toggle.js"></script>
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <style>
        /* Layout with Sidebar Structure */
        .layout-with-sidebar {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
        }
        
        /* Sidebar styles */
        .layout-with-sidebar .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1050;
            overflow-y: auto;
            transition: transform var(--transition-slow);
        }
        
        /* Header styles */
        .layout-with-sidebar .header {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 1040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-5);
            transition: left var(--transition-slow);
        }
        
        /* Main content area */
        .layout-with-sidebar .main {
            margin-left: 280px;
            margin-top: 60px;
            width: calc(100% - 280px);
            min-height: calc(100vh - 60px);
            transition: margin-left var(--transition-slow), width var(--transition-slow);
        }
        
        /* Mobile adjustments */
        @media (max-width: 1024px) {
            body {
                overflow-x: hidden;
            }
            
            .layout-with-sidebar .sidebar {
                transform: translateX(-100%);
            }
            
            .layout-with-sidebar .sidebar.sidebar-open {
                transform: translateX(0);
            }
            
            .layout-with-sidebar .header {
                left: 0;
            }
            
            .layout-with-sidebar .main {
                margin-left: 0 !important;
                margin-top: 60px !important;
                width: 100% !important;
                min-height: calc(100vh - 60px) !important;
                padding-bottom: 80px !important;
            }
            
            /* Ensure content fills the screen */
            #mainContent {
                min-height: calc(100vh - 60px - 80px);
                padding: var(--spacing-4);
            }
            
            #menuToggle {
                display: block !important;
            }
            
            .app-bottom-nav {
                display: flex !important;
            }
        }
        
        /* Events specific styles */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .event-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        /* Sidebar toggle functionality */
        .sidebar-hidden {
            transform: translateX(-100%) !important;
        }
        
        .main-expanded {
            margin-left: 0 !important;
            width: 100% !important;
        }
        
        .header-expanded {
            left: 0 !important;
        }
        
        /* Mobile menu button */
        #menuToggle {
            display: none;
        }
        
        @media (max-width: 768px) {
            #menuToggle {
                display: flex !important;
            }
        }
        
        .event-card h3 {
            margin: 0 0 var(--spacing-2) 0;
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .event-card .event-date {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-3);
        }
        
        .event-card .event-status {
            display: inline-block;
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: var(--spacing-3);
        }
        
        .event-card .event-status.active {
            background: var(--success);
            color: white;
        }
        
        .event-card .event-status.inactive {
            background: var(--muted);
            color: white;
        }
        
        .event-metrics {
            display: flex;
            gap: var(--spacing-4);
            margin-top: var(--spacing-3);
        }
        
        .event-metric {
            text-align: center;
        }
        
        .event-metric .number {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--primary);
        }
        
        .event-metric .label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .stat-card .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--spacing-2);
        }
        
        .stat-card .stat-label {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="layout-with-sidebar">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div style="padding: var(--spacing-5); border-bottom: 1px solid var(--border-color);">
                <h1 style="font-size: var(--font-size-xl); color: var(--primary); font-weight: 600; margin: 0;">
                    üè† Eventos
                </h1>
            </div>
            
            <div class="nav-menu" style="padding: var(--spacing-4);" id="navigationMenu">
                <!-- Ser√° preenchido por navigation.js -->
            </div>
            
            <!-- Events Info Panel -->
            <div id="eventsInfoPanel" style="padding: var(--spacing-4); border-top: 1px solid var(--border-color);">
                <div class="nav-category">Sistema</div>
                <div id="currentEventsInfo" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                    Gest√£o central de eventos VisionKrono
                </div>
            </div>
        </nav>
        
        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: var(--spacing-4);">
                <button class="btn btn-icon btn-secondary" id="menuToggle" onclick="toggleSidebar()">
                    <i>‚ò∞</i>
                </button>
                <h2 id="pageTitle" style="font-size: var(--font-size-2xl); font-weight: 600; margin: 0;">
                    üè† Eventos
                </h2>
            </div>
            <div style="display: flex; gap: var(--spacing-2);" id="headerActions">
                <button class="btn btn-sm btn-primary" id="newEventBtn">
                    <i>‚ûï</i> Novo Evento
                </button>
                <button class="btn btn-sm btn-secondary" id="refreshBtn">
                    <i>üîÑ</i> Atualizar
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main">
            <div style="flex: 1; overflow-y: auto; padding: var(--spacing-5);" id="mainContent">
                
                <!-- Estat√≠sticas gerais -->
                <section class="stats-section" style="margin-bottom: var(--spacing-6);">
                    <h2 style="font-size: var(--font-size-xl); font-weight: 600; margin-bottom: var(--spacing-4); color: var(--text-primary);">
                        üìä Estat√≠sticas Gerais
                    </h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalEvents">0</div>
                            <div class="stat-label">Eventos Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalDevices">0</div>
                            <div class="stat-label">Dispositivos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalDetections">0</div>
                            <div class="stat-label">Total Detec√ß√µes</div>
                        </div>
                    </div>
                </section>
                
                <!-- Lista de eventos -->
                <section class="events-section">
                    <h2 style="font-size: var(--font-size-xl); font-weight: 600; margin-bottom: var(--spacing-4); color: var(--text-primary);">
                        üìÖ Eventos
                    </h2>
                    <div class="events-grid" id="eventsGrid">
                        <div class="loading" style="text-align: center; padding: var(--spacing-8); color: var(--text-secondary);">
                            Carregando eventos...
                        </div>
                    </div>
                </section>
            </div>
        </main>
        
        <!-- Modal para criar/editar evento -->
        <div id="eventModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Novo Evento</h2>
                    <button id="closeModalBtn" class="close-btn">&times;</button>
                </div>
                
                <div class="modal-body">
                    <form id="eventForm">
                        <div class="form-group">
                            <label for="eventName">Nome do Evento *</label>
                            <input type="text" id="eventName" required placeholder="Ex: Maratona do Porto 2025">
                        </div>
                        
                        <div class="form-group">
                            <label for="eventDescription">Descri√ß√£o</label>
                            <textarea id="eventDescription" placeholder="Descri√ß√£o do evento..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventDate">Data do Evento</label>
                                <input type="date" id="eventDate">
                            </div>
                            
                            <div class="form-group">
                                <label for="eventLocation">Localiza√ß√£o</label>
                                <input type="text" id="eventLocation" placeholder="Porto, Portugal">
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="cancelBtn" class="btn secondary">Cancelar</button>
                            <button type="submit" class="btn primary">Criar Evento</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Modal de detalhes do evento -->
        <div id="eventDetailsModal" class="modal" style="display: none;">
            <div class="modal-content large">
                <div class="modal-header">
                    <h2 id="eventDetailsTitle">Detalhes do Evento</h2>
                    <button id="closeDetailsBtn" class="close-btn">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div id="eventDetailsContent">
                        <!-- Conte√∫do ser√° preenchido dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- Fim .layout-with-sidebar -->
    
    <!-- Scripts -->
    <script src="navigation.js"></script>
    <script src="supabase.js"></script>
    
    <!-- Events Logic -->
    <script>
        // Global variables
        let events = [];
        
        // Fun√ß√£o para alternar sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('.main');
            const header = document.querySelector('.header');
            
            if (sidebar && main && header) {
                sidebar.classList.toggle('sidebar-hidden');
                main.classList.toggle('main-expanded');
                header.classList.toggle('header-expanded');
                
                console.log('üîÑ Sidebar alternado:', sidebar.classList.contains('sidebar-hidden') ? 'Oculto' : 'Vis√≠vel');
            }
        }
        
        // Verificar se √© mobile e mostrar bot√£o de menu
        function checkMobileMenu() {
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle && window.innerWidth <= 768) {
                menuToggle.style.display = 'flex';
            } else if (menuToggle) {
                menuToggle.style.display = 'none';
            }
        }
        
        // Event listener para redimensionamento
        window.addEventListener('resize', checkMobileMenu);
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inicializando p√°gina de eventos...');
            
            // Check mobile menu visibility
            checkMobileMenu();
            
            // Initialize Supabase first
            if (window.supabaseClient) {
                console.log('üîë Inicializando Supabase...');
                await window.supabaseClient.init();
                console.log('‚úÖ Supabase inicializado:', window.supabaseClient.isConnected);
            } else {
                console.error('‚ùå window.supabaseClient n√£o encontrado');
            }
            
            // Initialize navigation
            if (window.Navigation) {
                window.Navigation.init('events');
                console.log('‚úÖ Navega√ß√£o inicializada');
            }
            
            // Configurar event listeners
            setupEventListeners();
            setupMenuToggle();
            
            // Carregar dados
            loadEvents();
            loadStats();
        });
        
        function setupEventListeners() {
            // Bot√£o novo evento
            const newEventBtn = document.getElementById('newEventBtn');
            if (newEventBtn) {
                newEventBtn.addEventListener('click', showNewEventModal);
            }
            
            // Bot√£o atualizar
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    loadEvents();
                    loadStats();
                });
            }
            
            // Modal eventos
            const eventModal = document.getElementById('eventModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', hideEventModal);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideEventModal);
            }
            
            // Formul√°rio de evento
            const eventForm = document.getElementById('eventForm');
            if (eventForm) {
                eventForm.addEventListener('submit', handleEventSubmit);
            }
            
            // Modal detalhes
            const eventDetailsModal = document.getElementById('eventDetailsModal');
            const closeDetailsBtn = document.getElementById('closeDetailsBtn');
            
            if (closeDetailsBtn) {
                closeDetailsBtn.addEventListener('click', hideEventDetailsModal);
            }
        }
        
        function setupMenuToggle() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('sidebar-open');
                });
            }
        }
        
        async function loadEvents() {
            try {
                console.log('üìã Carregando eventos...');
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('‚ùå Supabase n√£o dispon√≠vel');
                    return;
                }
                
                const { data: eventsData, error } = await window.supabaseClient.supabase
                    .from('events')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar eventos:', error);
                    return;
                }
                
                console.log('‚úÖ Eventos carregados:', eventsData?.length || 0);
                events = eventsData || [];
                renderEvents();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar eventos:', error);
            }
        }
        
        function renderEvents() {
            const eventsGrid = document.getElementById('eventsGrid');
            if (!eventsGrid) return;
            
            if (events.length === 0) {
                eventsGrid.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-8); color: var(--text-secondary);">
                        Nenhum evento encontrado.<br>
                        <button class="btn btn-primary" onclick="showNewEventModal()" style="margin-top: var(--spacing-3);">
                            <i>‚ûï</i> Criar Primeiro Evento
                        </button>
                    </div>
                `;
                return;
            }
            
            eventsGrid.innerHTML = events.map(event => `
                <div class="event-card" data-event-id="${event.id}">
                    <h3>${event.name}</h3>
                    <div class="event-date">${event.event_date ? new Date(event.event_date).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</div>
                    <div class="event-status ${event.status === 'active' ? 'active' : 'inactive'}">
                        ${event.status === 'active' ? 'ATIVO' : 'INATIVO'}
                    </div>
                    <div class="event-metrics">
                        <div class="event-metric">
                            <div class="number">1</div>
                            <div class="label">Dispositivos</div>
                        </div>
                        <div class="event-metric">
                            <div class="number">1</div>
                            <div class="label">Detec√ß√µes</div>
                        </div>
                        <div class="event-metric">
                            <div class="number">2</div>
                            <div class="label">Participantes</div>
                        </div>
                    </div>
                    <div style="margin-top: var(--spacing-3); text-align: center; color: var(--text-secondary); font-size: var(--font-size-xs);">
                        Clique para abrir o evento
                    </div>
                </div>
            `).join('');
            
            // Adicionar event listeners para os cards
            document.querySelectorAll('.event-card').forEach(card => {
                card.addEventListener('click', function() {
                    const eventId = this.getAttribute('data-event-id');
                    console.log('üñ±Ô∏è Card clicado:', eventId);
                    openEvent(eventId);
                });
            });
        }
        
        async function loadStats() {
            try {
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    return;
                }
                
                // Carregar estat√≠sticas
                const [eventsResult, devicesResult, detectionsResult] = await Promise.all([
                    window.supabaseClient.supabase.from('events').select('*', { count: 'exact', head: true }),
                    window.supabaseClient.supabase.from('devices').select('*', { count: 'exact', head: true }),
                    window.supabaseClient.supabase.from('detections').select('*', { count: 'exact', head: true })
                ]);
                
                const totalEvents = eventsResult.count || 0;
                const totalDevices = devicesResult.count || 0;
                const totalDetections = detectionsResult.count || 0;
                
                // Atualizar UI
                const totalEventsEl = document.getElementById('totalEvents');
                const totalDevicesEl = document.getElementById('totalDevices');
                const totalDetectionsEl = document.getElementById('totalDetections');
                
                if (totalEventsEl) totalEventsEl.textContent = totalEvents;
                if (totalDevicesEl) totalDevicesEl.textContent = totalDevices;
                if (totalDetectionsEl) totalDetectionsEl.textContent = totalDetections;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
            }
        }
        
        function showNewEventModal() {
            const modal = document.getElementById('eventModal');
            const modalTitle = document.getElementById('modalTitle');
            const eventForm = document.getElementById('eventForm');
            
            if (modalTitle) modalTitle.textContent = 'Novo Evento';
            if (eventForm) eventForm.reset();
            if (modal) modal.style.display = 'block';
        }
        
        function hideEventModal() {
            const modal = document.getElementById('eventModal');
            if (modal) modal.style.display = 'none';
        }
        
        function showEventDetails(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            const modal = document.getElementById('eventDetailsModal');
            const modalTitle = document.getElementById('eventDetailsTitle');
            const modalContent = document.getElementById('eventDetailsContent');
            
            if (modalTitle) modalTitle.textContent = event.name;
            if (modalContent) {
                modalContent.innerHTML = `
                    <div style="margin-bottom: var(--spacing-4);">
                        <strong>Nome:</strong> ${event.name}<br>
                        <strong>Data:</strong> ${event.event_date ? new Date(event.event_date).toLocaleDateString('pt-PT') : 'N√£o definida'}<br>
                        <strong>Localiza√ß√£o:</strong> ${event.location || 'N√£o definida'}<br>
                        <strong>Status:</strong> ${event.status === 'active' ? 'Ativo' : 'Inativo'}<br>
                        <strong>Descri√ß√£o:</strong> ${event.description || 'Sem descri√ß√£o'}
                    </div>
                    <div style="display: flex; gap: var(--spacing-2);">
                        <button class="btn btn-primary" onclick="openEvent('${event.id}')">
                            <i>üöÄ</i> Abrir Evento
                        </button>
                        <button class="btn btn-secondary" onclick="editEvent('${event.id}')">
                            <i>‚úèÔ∏è</i> Editar
                        </button>
                    </div>
                `;
            }
            if (modal) modal.style.display = 'block';
        }
        
        function hideEventDetailsModal() {
            const modal = document.getElementById('eventDetailsModal');
            if (modal) modal.style.display = 'none';
        }
        
        function openEvent(eventId) {
            console.log('üöÄ Abrindo evento:', eventId);
            console.log('üìã Eventos dispon√≠veis:', events);
            
            if (!events || events.length === 0) {
                console.error('‚ùå Lista de eventos vazia ou n√£o carregada');
                alert('Eventos ainda n√£o foram carregados. Tente novamente em alguns segundos.');
                return;
            }
            
            const event = events.find(e => e.id === eventId);
            if (!event) {
                console.error('‚ùå Evento n√£o encontrado:', eventId);
                console.log('üîç Eventos dispon√≠veis:', events.map(e => ({ id: e.id, name: e.name })));
                return;
            }
            
            console.log('‚úÖ Evento encontrado:', event.name);
            
            const eventName = encodeURIComponent(event.name || 'Evento');
            const url = `/config?event=${eventId}&eventName=${eventName}`;
            
            console.log('üîó Navegando para:', url);
            
            try {
                window.location.href = url;
            } catch (error) {
                console.error('‚ùå Erro ao navegar:', error);
                alert('Erro ao navegar para o evento. Verifique o console para mais detalhes.');
            }
        }
        
        function editEvent(eventId) {
            // Implementar edi√ß√£o de evento
            console.log('Editar evento:', eventId);
        }
        
        async function handleEventSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const eventData = {
                name: formData.get('eventName'),
                description: formData.get('eventDescription'),
                event_date: formData.get('eventDate'),
                location: formData.get('eventLocation'),
                status: 'active'
            };
            
            try {
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.error('‚ùå Supabase n√£o dispon√≠vel');
                    return;
                }
                
                const { data, error } = await window.supabaseClient.supabase
                    .from('events')
                    .insert([eventData])
                    .select();
                
                if (error) {
                    console.error('‚ùå Erro ao criar evento:', error);
                    return;
                }
                
                console.log('‚úÖ Evento criado:', data);
                hideEventModal();
                loadEvents();
                loadStats();
                
            } catch (error) {
                console.error('‚ùå Erro ao criar evento:', error);
            }
        }
    </script>
</body>
</html>
