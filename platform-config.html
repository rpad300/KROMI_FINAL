<!DOCTYPE html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VisionKrono">
    <meta name="description" content="Configurações da Plataforma VisionKrono">
    
    <title>Configurações da Plataforma - VisionKrono</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="kromi-design-system.css">
    <link rel="stylesheet" href="kromi-layout-fixes.css">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <style>
        /* Layout with Sidebar Structure */
        .layout-with-sidebar {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
        }
        
        /* Sidebar styles */
        .layout-with-sidebar .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1050;
            overflow-y: auto;
            transition: transform var(--transition-slow);
        }
        
        /* Header styles */
        .layout-with-sidebar .header {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 1040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-5);
            transition: left var(--transition-slow);
        }
        
        /* Main content area */
        .layout-with-sidebar .main {
            margin-left: 280px;
            margin-top: 60px;
            width: calc(100% - 280px);
            min-height: calc(100vh - 60px);
            transition: margin-left var(--transition-slow), width var(--transition-slow);
        }
        
        /* Mobile adjustments */
        @media (max-width: 1024px) {
            body {
                overflow-x: hidden;
            }
            
            .layout-with-sidebar .sidebar {
                transform: translateX(-100%);
            }
            
            .layout-with-sidebar .sidebar.sidebar-open {
                transform: translateX(0);
            }
            
            .layout-with-sidebar .header {
                left: 0;
            }
            
            .layout-with-sidebar .main {
                margin-left: 0 !important;
                margin-top: 60px !important;
                width: 100% !important;
                min-height: calc(100vh - 60px) !important;
                padding-bottom: 80px !important;
            }
        }
        
        /* Estilos específicos para configurações da plataforma */
        .config-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            border: 1px solid var(--border-color);
        }
        
        .config-section h3 {
            margin: 0 0 var(--spacing-4) 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .api-key-input {
            position: relative;
        }
        
        .api-key-input input {
            padding-right: 3rem;
        }
        
        .api-key-toggle {
            position: absolute;
            right: var(--spacing-3);
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: var(--font-size-lg);
            padding: var(--spacing-1);
        }
        
        .api-key-toggle:hover {
            color: var(--text-primary);
        }
        
        .processor-control-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            margin-bottom: var(--spacing-4);
            transition: all 0.2s ease;
        }
        
        .processor-control-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }
        
        .processor-control-card.selected {
            border-color: var(--primary-color);
            background: var(--primary-color-light);
        }
        
        .processor-control-card h4 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
            font-size: var(--font-size-md);
            font-weight: 600;
        }
        
        .processor-control-card p {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-3);
        }
        
        .processor-control-options {
            display: flex;
            gap: var(--spacing-2);
            flex-wrap: wrap;
        }
        
        .processor-control-options button {
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .processor-control-options button:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .processor-control-options button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .event-processor-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
        }
        
        .event-processor-item {
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .event-processor-item:last-child {
            border-bottom: none;
        }
        
        .event-processor-info {
            flex: 1;
        }
        
        .event-processor-info h5 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-1);
            font-size: var(--font-size-sm);
            font-weight: 600;
        }
        
        .event-processor-info p {
            color: var(--text-secondary);
            font-size: var(--font-size-xs);
            margin: 0;
        }
        
        .event-processor-controls {
            display: flex;
            gap: var(--spacing-2);
            align-items: center;
        }
        
        .processor-badge {
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .processor-badge.gemini {
            background: var(--success-color-light);
            color: var(--success-color);
        }
        
        .processor-badge.google-vision {
            background: var(--info-color-light);
            color: var(--info-color);
        }
        
        .processor-badge.ocr {
            background: var(--warning-color-light);
            color: var(--warning-color);
        }
        
        .processor-badge.hybrid {
            background: var(--primary-color-light);
            color: var(--primary-color);
        }
        
        .processor-badge.manual {
            background: var(--text-secondary-light);
            color: var(--text-secondary);
        }
        
        .processor-badge.inherited {
            background: var(--border-color);
            color: var(--text-secondary);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-1);
            font-size: var(--font-size-xs);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-sm);
        }
        
        .status-indicator.success {
            background: var(--success-color-light);
            color: var(--success-color);
        }
        
        .status-indicator.warning {
            background: var(--warning-color-light);
            color: var(--warning-color);
        }
        
        .status-indicator.error {
            background: var(--error-color-light);
            color: var(--error-color);
        }
        
        .save-indicator {
            position: fixed;
            top: var(--spacing-4);
            right: var(--spacing-4);
            background: var(--success-color);
            color: white;
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .save-indicator.show {
            transform: translateX(0);
        }
        
        .encryption-info {
            background: var(--info-color-light);
            border: 1px solid var(--info-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .encryption-info h4 {
            color: var(--info-color);
            margin-bottom: var(--spacing-2);
            font-size: var(--font-size-sm);
            font-weight: 600;
        }
        
        .encryption-info p {
            color: var(--text-secondary);
            font-size: var(--font-size-xs);
            margin: 0;
        }
        
        /* API Status Indicators */
        .api-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            margin-top: var(--spacing-2);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-1);
            font-size: var(--font-size-xs);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-sm);
            font-weight: 500;
        }
        
        .status-indicator.success {
            background: var(--success-color-light);
            color: var(--success-color);
        }
        
        .status-indicator.error {
            background: var(--error-color-light);
            color: var(--error-color);
        }
        
        .status-indicator.loading {
            background: var(--warning-color-light);
            color: var(--warning-color);
        }
        
        .api-test-button {
            margin-top: var(--spacing-3);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Logo styles */
        .logo-icon {
            font-size: 24px;
            margin-right: var(--spacing-2);
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: var(--text-primary);
            margin: 0;
            font-size: var(--font-size-lg);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-2);
            border-radius: var(--radius-sm);
        }
        
        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: var(--spacing-6);
        }
        
        .modal-footer {
            padding: var(--spacing-6);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-3);
        }
        
        /* Processor dropdown styles */
        .processor-config-dropdown {
            margin-right: var(--spacing-3);
        }
        
        .processor-select {
            min-width: 200px;
            font-size: var(--font-size-sm);
            padding: var(--spacing-2) var(--spacing-3);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
        }
        
        .processor-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color-light);
        }
        
        .processor-select option {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="layout-with-sidebar">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div style="padding: var(--spacing-5); border-bottom: 1px solid var(--border-color);">
                <h1 style="font-size: var(--font-size-xl); color: var(--primary); font-weight: 600; margin: 0;">
                    ⚙️ Configurações
                </h1>
            </div>
            
            <div class="nav-menu" style="padding: var(--spacing-4);" id="navigationMenu">
                <!-- Será preenchido por navigation.js -->
            </div>
            
            <!-- Platform Info Panel -->
            <div id="platformInfoPanel" style="padding: var(--spacing-4); border-top: 1px solid var(--border-color);">
                <div class="nav-category">Plataforma</div>
                <div id="currentPlatformInfo" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                    Configurações globais da plataforma VisionKrono
                </div>
            </div>
        </nav>

        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: var(--spacing-4);">
                <button class="btn btn-icon btn-secondary" id="menuToggle" style="display: none;">
                    <i>☰</i>
                </button>
                <h2 id="pageTitle" style="font-size: var(--font-size-2xl); font-weight: 600; margin: 0;">
                    ⚙️ Configurações da Plataforma
                </h2>
            </div>
            <div style="display: flex; gap: var(--spacing-2);" id="headerActions">
                <button class="btn btn-sm btn-primary" onclick="testAllApis()">
                    <i>🔍</i> Testar APIs
                </button>
                <button class="btn btn-sm btn-secondary" onclick="saveApiConfigurations()">
                    <i>💾</i> Salvar
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <div style="flex: 1; overflow-y: auto; padding: var(--spacing-5);" id="mainContent">
            <!-- Informações de Encriptação -->
            <div class="encryption-info">
                <h4>🔒 Segurança das Configurações</h4>
                <p>Todas as chaves de API são armazenadas de forma encriptada na base de dados. As configurações substituem completamente o sistema de arquivos .env.</p>
            </div>

            <!-- Configurações de API -->
            <div class="config-section">
                <h3>🔑 Configurações de API</h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
                    Configure todas as chaves de API necessárias para o funcionamento da plataforma.
                </p>
                
                <form id="apiConfigForm" onsubmit="return false;">
                <div class="form-group">
                    <label class="form-label">Google Gemini API Key</label>
                    <div class="api-key-input">
                        <input type="password" id="geminiApiKey" class="form-input" placeholder="Digite sua chave da API Gemini">
                        <button type="button" class="api-key-toggle" onclick="togglePasswordVisibility('geminiApiKey')">👁️</button>
                    </div>
                    <small class="form-help">Chave para processamento com IA Gemini</small>
                    <div class="api-status" id="geminiStatus">
                        <span class="status-indicator loading">
                            <span class="loading-spinner"></span>
                            Verificando...
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Google Vision API Key</label>
                    <div class="api-key-input">
                        <input type="password" id="googleVisionApiKey" class="form-input" placeholder="Digite sua chave da API Google Vision">
                        <button type="button" class="api-key-toggle" onclick="togglePasswordVisibility('googleVisionApiKey')">👁️</button>
                    </div>
                    <small class="form-help">Chave para processamento com Google Vision</small>
                    <div class="api-status" id="googleVisionStatus">
                        <span class="status-indicator loading">
                            <span class="loading-spinner"></span>
                            Verificando...
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Supabase URL</label>
                    <input type="text" id="supabaseUrl" class="form-input" placeholder="https://your-project.supabase.co">
                    <small class="form-help">URL do seu projeto Supabase</small>
                    <div class="api-status" id="supabaseUrlStatus">
                        <span class="status-indicator loading">
                            <span class="loading-spinner"></span>
                            Verificando...
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Supabase Anon Key</label>
                    <div class="api-key-input">
                        <input type="password" id="supabaseAnonKey" class="form-input" placeholder="Digite sua chave anônima do Supabase">
                        <button type="button" class="api-key-toggle" onclick="togglePasswordVisibility('supabaseAnonKey')">👁️</button>
                    </div>
                    <small class="form-help">Chave anônima do Supabase</small>
                    <div class="api-status" id="supabaseAnonStatus">
                        <span class="status-indicator loading">
                            <span class="loading-spinner"></span>
                            Verificando...
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Supabase Service Role Key</label>
                    <div class="api-key-input">
                        <input type="password" id="supabaseServiceKey" class="form-input" placeholder="Digite sua chave de serviço do Supabase">
                        <button type="button" class="api-key-toggle" onclick="togglePasswordVisibility('supabaseServiceKey')">👁️</button>
                    </div>
                    <small class="form-help">Chave de serviço do Supabase (para operações administrativas)</small>
                    <div class="api-status" id="supabaseServiceStatus">
                        <span class="status-indicator loading">
                            <span class="loading-spinner"></span>
                            Verificando...
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-primary" onclick="saveApiConfigurations()">
                        <i>💾</i> Salvar Configurações de API
                    </button>
                </div>
                </form>
            </div>

            <!-- Configurações Globais de Processador -->
            <div class="config-section">
                <h3>🤖 Configurações Globais de Processador</h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
                    Configure o comportamento padrão dos processadores para toda a plataforma.
                </p>
                
                <div class="processor-control-card" id="globalProcessorCard">
                    <h4>🎯 Controle Global de Processador</h4>
                    <p>Escolha como os processadores devem ser controlados globalmente:</p>
                    
                    <div class="processor-control-options">
                        <button id="allowEventOverride" class="active" onclick="setGlobalProcessorControl('allow_override')">
                            📋 Permitir Configuração por Evento
                        </button>
                        <button id="forceGlobalProcessor" onclick="setGlobalProcessorControl('force_global')">
                            🔒 Forçar Processador Global
                        </button>
                    </div>
                </div>
                
                <div class="processor-control-card" id="defaultProcessorCard">
                    <h4>⚙️ Processador Padrão</h4>
                    <p>Configure o processador padrão quando eventos não têm configuração específica:</p>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Processador Padrão</label>
                        <select id="defaultProcessorType" class="form-select">
                            <option value="gemini">🤖 Gemini AI</option>
                            <option value="google-vision">👁️ Google Vision</option>
                            <option value="ocr">📄 OCR Tradicional</option>
                            <option value="hybrid">🔄 Sistema Híbrido</option>
                            <option value="manual">✋ Processamento Manual</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Velocidade Padrão</label>
                        <select id="defaultProcessorSpeed" class="form-select">
                            <option value="fast">⚡ Rápido</option>
                            <option value="balanced">⚖️ Equilibrado</option>
                            <option value="accurate">🎯 Preciso</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confiança Padrão: <span id="defaultConfidenceValue">70%</span></label>
                        <input type="range" id="defaultProcessorConfidence" class="form-range" min="0.1" max="1.0" step="0.1" value="0.7">
                    </div>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-primary" onclick="saveGlobalProcessorSettings()">
                        <i>💾</i> Salvar Configurações Globais
                    </button>
                </div>
            </div>

            <!-- Configurações por Evento -->
            <div class="config-section">
                <h3>📋 Configurações por Evento</h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
                    Configure processadores específicos para cada evento individual.
                </p>
                
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="loadEventProcessorSettings()">
                        <i>🔄</i> Atualizar Lista de Eventos
                    </button>
                </div>
                
                <div id="eventProcessorList" class="event-processor-list">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Indicador de Salvamento -->
    <div id="saveIndicator" class="save-indicator">
        <i>✅</i> Configurações salvas com sucesso!
    </div>

    <!-- Scripts -->
    <script src="navigation.js"></script>
    <script src="supabase.js"></script>
    <script>
        let currentGlobalControl = 'allow_override';
        let eventProcessorSettings = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔧 Inicializando página de configurações da plataforma...');
            
            // Initialize Supabase first
            if (window.supabaseClient) {
                console.log('🔑 Inicializando Supabase...');
                await window.supabaseClient.init();
                console.log('✅ Supabase inicializado:', window.supabaseClient.isConnected);
            } else {
                console.error('❌ window.supabaseClient não encontrado');
            }
            
            // Initialize navigation
            if (window.Navigation) {
                window.Navigation.init('platform-config');
                console.log('✅ Navegação inicializada');
            }
            
            // Configurar event listeners
            setupEventListeners();
            setupMenuToggle();
            
            // Aguardar inicialização do Supabase
            setTimeout(() => {
                if (window.supabaseClient && window.supabaseClient.supabase) {
                    console.log('✅ Supabase client disponível, carregando configurações...');
                    loadApiConfigurations();
                    loadGlobalProcessorSettings();
                    loadEventProcessorSettings();
                    
                    // Testar APIs após carregar configurações
                    setTimeout(() => {
                        testAllApis();
                    }, 1000);
                } else {
                    console.log('⚠️ Supabase client não disponível, usando configurações padrão');
                    loadDefaultConfigurations();
                    // Testar APIs com configurações padrão
                    setTimeout(() => {
                        testAllApis();
                    }, 1000);
                }
            }, 500);
        });

        function setupEventListeners() {
            // Range de confiança
            const confidenceRange = document.getElementById('defaultProcessorConfidence');
            const confidenceValue = document.getElementById('defaultConfidenceValue');
            
            if (confidenceRange && confidenceValue) {
                confidenceRange.addEventListener('input', function() {
                    confidenceValue.textContent = Math.round(this.value * 100) + '%';
                });
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        async function loadApiConfigurations() {
            try {
                console.log('📥 Carregando configurações de API...');
                
                // Verificar se Supabase está disponível
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('⚠️ Supabase não disponível, usando configurações padrão');
                    loadDefaultConfigurations();
                    return;
                }
                
                const { data, error } = await window.supabaseClient.supabase.rpc('get_platform_config', {
                    config_key_param: null
                });
                
                if (error) {
                    console.error('❌ Erro ao carregar configurações:', error);
                    // Se não conseguir carregar da base de dados, usar valores padrão do .env
                    loadDefaultConfigurations();
                    return;
                }
                
                // Preencher campos com configurações existentes
                if (data && data.length > 0) {
                    data.forEach(config => {
                        const fieldMap = {
                            'GEMINI_API_KEY': 'geminiApiKey',
                            'GOOGLE_VISION_API_KEY': 'googleVisionApiKey',
                            'SUPABASE_URL': 'supabaseUrl',
                            'SUPABASE_ANON_KEY': 'supabaseAnonKey',
                            'SUPABASE_SERVICE_ROLE_KEY': 'supabaseServiceKey'
                        };
                        
                        const fieldId = fieldMap[config.config_key];
                        if (fieldId) {
                            const input = document.getElementById(fieldId);
                            if (input) {
                                input.value = config.config_value;
                            }
                        }
                    });
                    console.log('✅ Configurações de API carregadas da base de dados');
                } else {
                    console.log('ℹ️ Nenhuma configuração encontrada na base de dados, usando valores padrão');
                    loadDefaultConfigurations();
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar configurações de API:', error);
                loadDefaultConfigurations();
            }
        }
        
        function loadDefaultConfigurations() {
            // Carregar valores padrão do .env ou valores conhecidos
            const defaultConfigs = {
                'supabaseUrl': 'https://mdrvgbztadnluhrrnlob.supabase.co',
                'geminiApiKey': 'AIzaSyASJoaDUnVZLWQHavMWn7nmFR3qYbUdDQA',
                'googleVisionApiKey': 'AIzaSyBHR5jz1iVxlcoE8oDbbT3u6Y391FJ4Uds',
                'supabaseAnonKey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kcnZnYnp0YWRubHVocnJubG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5OTQ1MDUsImV4cCI6MjA3NjU3MDUwNX0.x2po57tZOQ443NLVURBWDIYQnYbJ4D6O45FlZ5qwmp4',
                'supabaseServiceKey': 'sb_publishable_r5xSTAYcxfVh5zrvZPUafg_Dp-QgsTkG'
            };
            
            Object.entries(defaultConfigs).forEach(([fieldId, value]) => {
                const input = document.getElementById(fieldId);
                if (input && !input.value) {
                    input.value = value;
                }
            });
            
            console.log('✅ Configurações padrão carregadas');
        }

        async function saveApiConfigurations() {
            try {
                console.log('💾 Salvando configurações de API...');
                
                const apiConfigs = [
                    { key: 'GEMINI_API_KEY', value: document.getElementById('geminiApiKey').value },
                    { key: 'GOOGLE_VISION_API_KEY', value: document.getElementById('googleVisionApiKey').value },
                    { key: 'SUPABASE_URL', value: document.getElementById('supabaseUrl').value },
                    { key: 'SUPABASE_ANON_KEY', value: document.getElementById('supabaseAnonKey').value },
                    { key: 'SUPABASE_SERVICE_ROLE_KEY', value: document.getElementById('supabaseServiceKey').value }
                ];
                
                // Salvar cada configuração
                for (const config of apiConfigs) {
                    if (config.value.trim()) {
                        const { error } = await window.supabaseClient.supabase.rpc('set_platform_config', {
                            config_key_param: config.key,
                            config_value_param: config.value,
                            config_type_param: 'api_key',
                            is_encrypted_param: true,
                            description_param: `Chave da API ${config.key}`
                        });
                        
                        if (error) {
                            console.error(`❌ Erro ao salvar ${config.key}:`, error);
                        }
                    }
                }
                
                showSaveIndicator();
                console.log('✅ Configurações de API salvas');
                
                // Testar APIs após salvar
                setTimeout(() => {
                    testAllApis();
                }, 1000);
                
            } catch (error) {
                console.error('❌ Erro ao salvar configurações de API:', error);
            }
        }

        async function loadGlobalProcessorSettings() {
            try {
                console.log('📥 Carregando configurações globais de processador...');
                
                // Verificar se Supabase está disponível
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('⚠️ Supabase não disponível para configurações globais');
                    return;
                }
                
                const { data, error } = await window.supabaseClient.supabase.rpc('get_global_processor_setting', {
                    setting_key_param: null
                });
                
                if (error) {
                    console.error('❌ Erro ao carregar configurações globais:', error);
                    return;
                }
                
                // Aplicar configurações
                data.forEach(setting => {
                    switch (setting.setting_key) {
                        case 'default_processor_type':
                            const typeSelect = document.getElementById('defaultProcessorType');
                            if (typeSelect) typeSelect.value = setting.setting_value;
                            break;
                        case 'default_processor_speed':
                            const speedSelect = document.getElementById('defaultProcessorSpeed');
                            if (speedSelect) speedSelect.value = setting.setting_value;
                            break;
                        case 'default_processor_confidence':
                            const confidenceRange = document.getElementById('defaultProcessorConfidence');
                            const confidenceValue = document.getElementById('defaultConfidenceValue');
                            if (confidenceRange) {
                                confidenceRange.value = setting.setting_value;
                                if (confidenceValue) {
                                    confidenceValue.textContent = Math.round(parseFloat(setting.setting_value) * 100) + '%';
                                }
                            }
                            break;
                        case 'allow_event_override':
                            if (setting.setting_value === 'true') {
                                setGlobalProcessorControl('allow_override');
                            }
                            break;
                        case 'force_global_processor':
                            if (setting.setting_value === 'true') {
                                setGlobalProcessorControl('force_global');
                            }
                            break;
                    }
                });
                
                console.log('✅ Configurações globais carregadas');
                
            } catch (error) {
                console.error('❌ Erro ao carregar configurações globais:', error);
            }
        }

        async function saveGlobalProcessorSettings() {
            try {
                console.log('💾 Salvando configurações globais de processador...');
                
                const settings = [
                    { key: 'default_processor_type', value: document.getElementById('defaultProcessorType').value },
                    { key: 'default_processor_speed', value: document.getElementById('defaultProcessorSpeed').value },
                    { key: 'default_processor_confidence', value: document.getElementById('defaultProcessorConfidence').value },
                    { key: 'allow_event_override', value: currentGlobalControl === 'allow_override' ? 'true' : 'false' },
                    { key: 'force_global_processor', value: currentGlobalControl === 'force_global' ? 'true' : 'false' }
                ];
                
                // Salvar cada configuração
                for (const setting of settings) {
                    const { error } = await window.supabaseClient.supabase.rpc('set_global_processor_setting', {
                        setting_key_param: setting.key,
                        setting_value_param: setting.value,
                        description_param: `Configuração global: ${setting.key}`
                    });
                    
                    if (error) {
                        console.error(`❌ Erro ao salvar ${setting.key}:`, error);
                    }
                }
                
                showSaveIndicator();
                console.log('✅ Configurações globais salvas');
                
            } catch (error) {
                console.error('❌ Erro ao salvar configurações globais:', error);
            }
        }

        function setGlobalProcessorControl(control) {
            currentGlobalControl = control;
            
            // Atualizar botões
            const allowButton = document.getElementById('allowEventOverride');
            const forceButton = document.getElementById('forceGlobalProcessor');
            
            if (control === 'allow_override') {
                allowButton.classList.add('active');
                forceButton.classList.remove('active');
            } else {
                allowButton.classList.remove('active');
                forceButton.classList.add('active');
            }
            
            console.log(`🎯 Controle global alterado para: ${control}`);
        }

        async function loadEventProcessorSettings() {
            try {
                console.log('📥 Carregando configurações de processador por evento...');
                
                // Verificar se Supabase está disponível
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('⚠️ Supabase não disponível para configurações de evento');
                    return;
                }
                
                // Buscar todos os eventos
                const { data: events, error: eventsError } = await window.supabaseClient.supabase
                    .from('events')
                    .select('id, name, created_at')
                    .order('created_at', { ascending: false });
                
                if (eventsError) {
                    console.error('❌ Erro ao carregar eventos:', eventsError);
                    return;
                }
                
                // Buscar configurações de processador para cada evento
                const eventProcessorList = document.getElementById('eventProcessorList');
                eventProcessorList.innerHTML = '';
                
                for (const event of events) {
                    let processorSetting = null;
                    
                    // Tentar carregar da base de dados primeiro
                    try {
                        const { data: processorSettings, error: settingsError } = await window.supabaseClient.supabase.rpc('get_event_processor_setting', {
                            event_id_param: event.id
                        });
                        
                        processorSetting = processorSettings && processorSettings.length > 0 ? processorSettings[0] : null;
                    } catch (error) {
                        console.log(`⚠️ Erro ao carregar configuração do evento ${event.name}, tentando localStorage`);
                    }
                    
                    // Se não encontrou na BD, tentar localStorage
                    if (!processorSetting) {
                        const localConfig = localStorage.getItem(`event_processor_${event.id}`);
                        if (localConfig) {
                            try {
                                const config = JSON.parse(localConfig);
                                processorSetting = {
                                    processor_type: config.processorType,
                                    processor_speed: config.processorSpeed,
                                    processor_confidence: config.processorConfidence,
                                    is_forced: config.processorType !== 'inherited'
                                };
                                console.log(`📂 Configuração carregada do localStorage para ${event.name}`);
                            } catch (error) {
                                console.log(`⚠️ Erro ao carregar configuração local para ${event.name}`);
                            }
                        }
                    }
                    
                    const eventItem = document.createElement('div');
                    eventItem.className = 'event-processor-item';
                    eventItem.innerHTML = `
                        <div class="event-processor-info">
                            <h5>${event.name}</h5>
                            <p>Criado em: ${new Date(event.created_at).toLocaleDateString('pt-PT')}</p>
                        </div>
                        <div class="event-processor-controls">
                            <div class="processor-config-dropdown">
                                <select class="form-select processor-select" onchange="updateEventProcessor('${event.id}', '${event.name}', this.value)">
                                    <option value="inherited" ${(!processorSetting || processorSetting.processor_type === 'inherited') ? 'selected' : ''}>📋 Herdar Global</option>
                                    <option value="gemini" ${(processorSetting && processorSetting.processor_type === 'gemini') ? 'selected' : ''}>🤖 Gemini AI</option>
                                    <option value="google-vision" ${(processorSetting && processorSetting.processor_type === 'google-vision') ? 'selected' : ''}>👁️ Google Vision</option>
                                    <option value="ocr" ${(processorSetting && processorSetting.processor_type === 'ocr') ? 'selected' : ''}>📄 OCR Tradicional</option>
                                    <option value="hybrid" ${(processorSetting && processorSetting.processor_type === 'hybrid') ? 'selected' : ''}>🔄 Sistema Híbrido</option>
                                    <option value="manual" ${(processorSetting && processorSetting.processor_type === 'manual') ? 'selected' : ''}>✋ Processamento Manual</option>
                                </select>
                            </div>
                            <span class="processor-badge ${processorSetting ? processorSetting.processor_type : 'inherited'}">
                                ${getProcessorDisplayName(processorSetting ? processorSetting.processor_type : 'inherited')}
                            </span>
                        </div>
                    `;
                    
                    eventProcessorList.appendChild(eventItem);
                }
                
                console.log('✅ Configurações de evento carregadas');
                
            } catch (error) {
                console.error('❌ Erro ao carregar configurações de evento:', error);
            }
        }

        function getProcessorDisplayName(processorType) {
            const names = {
                'gemini': 'Gemini AI',
                'google-vision': 'Google Vision',
                'ocr': 'OCR Tradicional',
                'hybrid': 'Sistema Híbrido',
                'manual': 'Processamento Manual',
                'inherited': 'Herdado'
            };
            return names[processorType] || processorType;
        }

        function configureEventProcessor(eventId, eventName) {
            console.log(`⚙️ Configurando processador para evento: ${eventName} (${eventId})`);
            
            // Criar modal para configuração do evento
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>⚙️ Configurar Processador: ${eventName}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Tipo de Processador</label>
                            <select id="eventProcessorType" class="form-select">
                                <option value="inherited">📋 Herdar Configuração Global</option>
                                <option value="gemini">🤖 Gemini AI</option>
                                <option value="google-vision">👁️ Google Vision</option>
                                <option value="ocr">📄 OCR Tradicional</option>
                                <option value="hybrid">🔄 Sistema Híbrido</option>
                                <option value="manual">✋ Processamento Manual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Velocidade</label>
                            <select id="eventProcessorSpeed" class="form-select">
                                <option value="fast">⚡ Rápido</option>
                                <option value="balanced">⚖️ Equilibrado</option>
                                <option value="accurate">🎯 Preciso</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confiança: <span id="eventConfidenceValue">70%</span></label>
                            <input type="range" id="eventProcessorConfidence" class="form-range" min="0.1" max="1.0" step="0.1" value="0.7">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveEventProcessorSetting('${eventId}', '${eventName}')">Salvar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Configurar event listener para range
            setTimeout(() => {
                const confidenceRange = document.getElementById('eventProcessorConfidence');
                const confidenceValue = document.getElementById('eventConfidenceValue');
                
                if (confidenceRange && confidenceValue) {
                    confidenceRange.addEventListener('input', function() {
                        confidenceValue.textContent = Math.round(this.value * 100) + '%';
                    });
                }
            }, 100);
        }

        async function saveEventProcessorSetting(eventId, eventName) {
            try {
                console.log(`💾 Salvando configuração do processador para evento: ${eventName}`);
                
                const processorType = document.getElementById('eventProcessorType').value;
                const processorSpeed = document.getElementById('eventProcessorSpeed').value;
                const processorConfidence = document.getElementById('eventProcessorConfidence').value;
                
                console.log(`📋 Configuração: ${processorType} | ${processorSpeed} | ${processorConfidence}`);
                
                // Verificar se Supabase está disponível
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('⚠️ Supabase não disponível, salvando localmente');
                    // Salvar localmente se Supabase não estiver disponível
                    localStorage.setItem(`event_processor_${eventId}`, JSON.stringify({
                        processorType,
                        processorSpeed,
                        processorConfidence: parseFloat(processorConfidence),
                        eventName,
                        timestamp: new Date().toISOString()
                    }));
                    
                    closeModal();
                    showSaveIndicator();
                    console.log('✅ Configuração salva localmente');
                    return;
                }
                
                const { error } = await window.supabaseClient.supabase.rpc('set_event_processor_setting', {
                    event_id_param: eventId,
                    processor_type_param: processorType,
                    processor_speed_param: processorSpeed,
                    processor_confidence_param: parseFloat(processorConfidence),
                    is_forced_param: processorType !== 'inherited'
                });
                
                if (error) {
                    console.error('❌ Erro ao salvar configuração do evento:', error);
                    alert('Erro ao salvar configuração: ' + error.message);
                    return;
                }
                
                closeModal();
                loadEventProcessorSettings();
                showSaveIndicator();
                console.log('✅ Configuração do evento salva');
                
            } catch (error) {
                console.error('❌ Erro ao salvar configuração do evento:', error);
                alert('Erro ao salvar configuração: ' + error.message);
            }
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }
        
        // Função para testar todas as APIs
        async function testAllApis() {
            console.log('🔍 Testando todas as APIs...');
            
            const apis = [
                { id: 'geminiStatus', name: 'Gemini API', key: 'geminiApiKey' },
                { id: 'googleVisionStatus', name: 'Google Vision API', key: 'googleVisionApiKey' },
                { id: 'supabaseUrlStatus', name: 'Supabase URL', key: 'supabaseUrl' },
                { id: 'supabaseAnonStatus', name: 'Supabase Anon Key', key: 'supabaseAnonKey' },
                { id: 'supabaseServiceStatus', name: 'Supabase Service Key', key: 'supabaseServiceKey' }
            ];
            
            for (const api of apis) {
                await testApi(api.id, api.name, api.key);
                // Pequeno delay entre testes
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        // Função para testar uma API específica
        async function testApi(statusId, apiName, keyId) {
            const statusElement = document.getElementById(statusId);
            const keyValue = document.getElementById(keyId).value.trim();
            
            if (!keyValue) {
                updateApiStatus(statusId, 'error', '❌ Não configurado');
                return;
            }
            
            updateApiStatus(statusId, 'loading', '🔄 Testando...');
            
            try {
                let result = { isValid: false, message: '❌ Falha na conexão' };
                
                switch (keyId) {
                    case 'geminiApiKey':
                        result = await testGeminiApi(keyValue);
                        break;
                    case 'googleVisionApiKey':
                        result = await testGoogleVisionApi(keyValue);
                        break;
                    case 'supabaseUrl':
                        result = await testSupabaseUrl(keyValue);
                        break;
                    case 'supabaseAnonKey':
                        result = await testSupabaseAnonKey(keyValue);
                        break;
                    case 'supabaseServiceKey':
                        result = await testSupabaseServiceKey(keyValue);
                        break;
                }
                
                if (result.isValid) {
                    updateApiStatus(statusId, 'success', result.message);
                } else {
                    updateApiStatus(statusId, 'error', result.message);
                }
                
            } catch (error) {
                console.error(`❌ Erro ao testar ${apiName}:`, error);
                updateApiStatus(statusId, 'error', '❌ Erro no teste');
            }
        }
        
        // Função para atualizar o status visual da API
        function updateApiStatus(statusId, status, text) {
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                statusElement.innerHTML = `
                    <span class="status-indicator ${status}">
                        ${text}
                    </span>
                `;
            }
        }
        
        // Funções específicas para testar cada API
        async function testGeminiApi(apiKey) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (response.ok) {
                    return { isValid: true, message: '✅ Gemini API conectada' };
                } else {
                    return { isValid: false, message: '❌ Chave Gemini inválida' };
                }
            } catch (error) {
                return { isValid: false, message: '❌ Erro de conexão Gemini' };
            }
        }
        
        async function testGoogleVisionApi(apiKey) {
            try {
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requests: [] })
                });
                if (response.status !== 400) {
                    return { isValid: true, message: '✅ Google Vision API conectada' };
                } else {
                    return { isValid: false, message: '❌ Chave Google Vision inválida' };
                }
            } catch (error) {
                return { isValid: false, message: '❌ Erro de conexão Google Vision' };
            }
        }
        
        async function testSupabaseUrl(url) {
            try {
                const response = await fetch(`${url}/rest/v1/`, {
                    method: 'GET',
                    headers: { 'apikey': 'test' }
                });
                // 401 é normal (API key inválida), 404 significa URL inválida
                if (response.status !== 404) {
                    return { isValid: true, message: '✅ URL Supabase válida' };
                } else {
                    return { isValid: false, message: '❌ URL Supabase inválida' };
                }
            } catch (error) {
                return { isValid: false, message: '❌ Erro de conexão Supabase' };
            }
        }
        
        async function testSupabaseAnonKey(key) {
            try {
                const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
                if (!supabaseUrl) {
                    return { isValid: false, message: '❌ URL Supabase necessária' };
                }
                
                const response = await fetch(`${supabaseUrl}/rest/v1/`, {
                    method: 'GET',
                    headers: { 'apikey': key }
                });
                // 401 é normal para chave anônima sem permissões específicas
                if (response.status === 401 || response.status === 200) {
                    return { isValid: true, message: '✅ Chave Anônima Supabase válida' };
                } else {
                    return { isValid: false, message: '❌ Chave Anônima Supabase inválida' };
                }
            } catch (error) {
                return { isValid: false, message: '❌ Erro de conexão Supabase Anon' };
            }
        }
        
        async function testSupabaseServiceKey(key) {
            try {
                const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
                if (!supabaseUrl) {
                    return { isValid: false, message: '❌ URL Supabase necessária' };
                }
                
                const response = await fetch(`${supabaseUrl}/rest/v1/`, {
                    method: 'GET',
                    headers: { 'apikey': key }
                });
                // 401 é normal para chave de serviço sem permissões específicas
                if (response.status === 401 || response.status === 200) {
                    return { isValid: true, message: '✅ Chave Service Supabase válida' };
                } else {
                    return { isValid: false, message: '❌ Chave Service Supabase inválida' };
                }
            } catch (error) {
                return { isValid: false, message: '❌ Erro de conexão Supabase Service' };
            }
        }
        
        // Função para atualizar processador do evento via dropdown
        async function updateEventProcessor(eventId, eventName, processorType) {
            try {
                console.log(`🔄 Atualizando processador do evento ${eventName} para: ${processorType}`);
                
                // Configurações padrão para velocidade e confiança
                const defaultSettings = {
                    processorSpeed: 'balanced',
                    processorConfidence: 0.7
                };
                
                // Verificar se Supabase está disponível
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('⚠️ Supabase não disponível, salvando localmente');
                    // Salvar localmente se Supabase não estiver disponível
                    localStorage.setItem(`event_processor_${eventId}`, JSON.stringify({
                        processorType,
                        processorSpeed: defaultSettings.processorSpeed,
                        processorConfidence: defaultSettings.processorConfidence,
                        eventName,
                        timestamp: new Date().toISOString()
                    }));
                    
                    showSaveIndicator();
                    console.log('✅ Configuração salva localmente');
                    return;
                }
                
                const { error } = await window.supabaseClient.supabase.rpc('set_event_processor_setting', {
                    event_id_param: eventId,
                    processor_type_param: processorType,
                    processor_speed_param: defaultSettings.processorSpeed,
                    processor_confidence_param: defaultSettings.processorConfidence,
                    is_forced_param: processorType !== 'inherited'
                });
                
                if (error) {
                    console.error('❌ Erro ao salvar configuração do evento:', error);
                    alert('Erro ao salvar configuração: ' + error.message);
                    return;
                }
                
                showSaveIndicator();
                console.log('✅ Configuração do evento salva');
                
                // Atualizar o badge visualmente
                updateProcessorBadge(eventId, processorType);
                
            } catch (error) {
                console.error('❌ Erro ao salvar configuração do evento:', error);
                alert('Erro ao salvar configuração: ' + error.message);
            }
        }
        
        // Função para atualizar o badge visualmente
        function updateProcessorBadge(eventId, processorType) {
            // Encontrar o item do evento e atualizar o badge
            const eventItems = document.querySelectorAll('.event-processor-item');
            eventItems.forEach(item => {
                const selectElement = item.querySelector('.processor-select');
                if (selectElement && selectElement.onchange.toString().includes(eventId)) {
                    const badge = item.querySelector('.processor-badge');
                    if (badge) {
                        // Remover classes antigas
                        badge.className = 'processor-badge';
                        // Adicionar nova classe
                        badge.classList.add(processorType);
                        // Atualizar texto
                        badge.textContent = getProcessorDisplayName(processorType);
                    }
                }
            });
        }
        
        // Função para controlar o sidebar
        function setupMenuToggle() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('sidebar-open');
                });
            }
        }
    </script>
</body>
</html>
