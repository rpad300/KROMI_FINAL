<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>VisionKrono - Gest√£o de Base de Dados</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="kromi-design-system.css">
        <link rel="stylesheet" href="kromi-layout-fixes.css">
        <script src="kromi-sidebar-toggle.js"></script>
    
    <style>
        /* Database Management specific styles */
        .db-grid {
            display: grid;
            gap: var(--spacing-5);
            margin-bottom: var(--spacing-6);
        }
        
        .db-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .db-header {
            background: var(--bg-primary);
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .db-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .db-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .db-content {
            padding: var(--spacing-4);
        }
        
        .table-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .stat-item {
            text-align: center;
            padding: var(--spacing-3);
            background: var(--bg-primary);
            border-radius: var(--radius-base);
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--spacing-1);
        }
        
        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .table-list {
            display: grid;
            gap: var(--spacing-2);
        }
        
        .table-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-3);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-base);
            transition: all var(--transition-base);
        }
        
        .table-item:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
        }
        
        .table-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .table-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-base);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            background: var(--bg-primary);
        }
        
        .table-details {
            flex: 1;
        }
        
        .table-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-1);
        }
        
        .table-description {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .table-actions {
            display: flex;
            gap: var(--spacing-1);
        }
        
        .backup-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
        }
        
        .backup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .backup-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            text-align: center;
        }
        
        .backup-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-3);
        }
        
        .backup-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
        }
        
        .backup-description {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-4);
        }
        
        .maintenance-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
        }
        
        .maintenance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-4);
        }
        
        .maintenance-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
        }
        
        .maintenance-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }
        
        .maintenance-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-base);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            background: var(--bg-primary);
        }
        
        .maintenance-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .maintenance-description {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-4);
            line-height: 1.5;
        }
        
        .maintenance-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .sql-editor {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .sql-header {
            background: var(--bg-primary);
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sql-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .sql-content {
            padding: var(--spacing-4);
        }
        
        .sql-textarea {
            width: 100%;
            min-height: 200px;
            padding: var(--spacing-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-base);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: var(--font-size-sm);
            resize: vertical;
        }
        
        .sql-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(252, 107, 3, 0.1);
        }
        
        .sql-actions {
            display: flex;
            gap: var(--spacing-3);
            margin-top: var(--spacing-4);
        }
        
        .query-results {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-4);
            overflow: hidden;
        }
        
        .query-results-header {
            background: var(--bg-primary);
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .query-results-content {
            padding: var(--spacing-3);
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: var(--font-size-sm);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-12);
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: var(--spacing-4);
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-2);
            color: var(--text-primary);
        }
        
        .empty-state p {
            font-size: var(--font-size-base);
            line-height: 1.6;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .table-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .backup-grid {
                grid-template-columns: 1fr;
            }
            
            .maintenance-grid {
                grid-template-columns: 1fr;
            }
            
            .db-actions {
                flex-direction: column;
            }
        }
        
        /* Fix header overlapping sidebar */
        .layout-with-sidebar .header {
            left: 280px; /* Width of sidebar */
            z-index: 100; /* Lower than sidebar */
        }
        
        @media (max-width: 1024px) {
            .layout-with-sidebar .header {
                left: 0;
            }
        }
        
        /* Fix header overlapping main content */
        .layout-with-sidebar .main {
            padding-top: 60px; /* Height of header */
        }
        
        @media (max-width: 1024px) {
            .layout-with-sidebar .main {
                padding-top: 60px; /* Height of header */
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- App Container -->
    <div class="layout-with-sidebar">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div style="padding: var(--spacing-5); border-bottom: 1px solid var(--border-color);">
                <h1 style="font-size: var(--font-size-xl); color: var(--primary); font-weight: 600; margin: 0;">
                    üóÑÔ∏è Gest√£o BD
                </h1>
            </div>
            
            <div class="nav-menu" style="padding: var(--spacing-4);" id="navigationMenu">
                <!-- Ser√° preenchido por navigation.js -->
            </div>
            
            <!-- Event Info Panel -->
            <div id="eventInfoPanel" style="padding: var(--spacing-4); border-top: 1px solid var(--border-color); display: none;">
                <div class="nav-category">Evento Atual</div>
                <div id="currentEventInfo" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- Database Info Panel -->
            <div style="padding: var(--spacing-4); border-top: 1px solid var(--border-color);">
                <div class="nav-category">Base de Dados</div>
                <div style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                    <div>Status: <span class="badge badge-success">Conectado</span></div>
                    <div>Tipo: Supabase</div>
                    <div>Regi√£o: EU-West</div>
                </div>
            </div>
        </nav>
        
        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: var(--spacing-4);">
                <button class="btn btn-icon btn-secondary" id="menuToggle" onclick="toggleSidebar()">
                    <i>‚ò∞</i>
                </button>
                <h2 id="pageTitle" style="font-size: var(--font-size-2xl); font-weight: 600; margin: 0;">
                    üóÑÔ∏è Gest√£o de Base de Dados
                </h2>
            </div>
            <div style="display: flex; gap: var(--spacing-2);" id="headerActions">
                <button class="btn btn-sm btn-primary" id="refreshData">
                    <i>üîÑ</i> Atualizar
                </button>
                <button class="btn btn-sm btn-secondary" id="exportSchema">
                    <i>üì§</i> Exportar Schema
                </button>
                <button class="btn btn-sm btn-danger" id="emergencyBackup">
                    <i>üö®</i> Backup Emerg√™ncia
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main">
            <div style="flex: 1; overflow-y: auto; padding: var(--spacing-5);" id="mainContent">
                
                <!-- Database Overview -->
                <div class="db-grid">
                    <div class="db-card">
                        <div class="db-header">
                            <h3 class="db-title">üìä Vis√£o Geral da Base de Dados</h3>
                            <div class="db-actions">
                                <button class="btn btn-sm btn-secondary" id="refreshOverview">
                                    <i>üîÑ</i> Atualizar
                                </button>
                            </div>
                        </div>
                        <div class="db-content">
                            <div class="table-stats">
                                <div class="stat-item">
                                    <div class="stat-value" id="totalTables">8</div>
                                    <div class="stat-label">Tabelas</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="totalRecords">1,247</div>
                                    <div class="stat-label">Registos</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="dbSize">2.3 MB</div>
                                    <div class="stat-label">Tamanho</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="lastBackup">2h</div>
                                    <div class="stat-label">√öltimo Backup</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tables Management -->
                <div class="db-card">
                    <div class="db-header">
                        <h3 class="db-title">üìã Gest√£o de Tabelas</h3>
                        <div class="db-actions">
                            <button class="btn btn-sm btn-primary" id="createTable">
                                <i>‚ûï</i> Nova Tabela
                            </button>
                            <button class="btn btn-sm btn-secondary" id="refreshTables">
                                <i>üîÑ</i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="db-content">
                        <div class="table-list" id="tableList">
                            <!-- Tables will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Backup Section -->
                <div class="backup-section">
                    <h3 style="margin: 0 0 var(--spacing-4) 0; font-size: var(--font-size-xl); font-weight: 600; color: var(--text-primary);">
                        üíæ Backup e Restauro
                    </h3>
                    <div class="backup-grid">
                        <div class="backup-card">
                            <div class="backup-icon">üíæ</div>
                            <div class="backup-title">Backup Completo</div>
                            <div class="backup-description">Criar backup de toda a base de dados</div>
                            <button class="btn btn-primary" id="fullBackup">
                                <i>üíæ</i> Criar Backup
                            </button>
                        </div>
                        <div class="backup-card">
                            <div class="backup-icon">üì§</div>
                            <div class="backup-title">Exportar Dados</div>
                            <div class="backup-description">Exportar dados em formato CSV/JSON</div>
                            <button class="btn btn-secondary" id="exportData">
                                <i>üì§</i> Exportar
                            </button>
                        </div>
                        <div class="backup-card">
                            <div class="backup-icon">üì•</div>
                            <div class="backup-title">Importar Dados</div>
                            <div class="backup-description">Importar dados de arquivo externo</div>
                            <button class="btn btn-secondary" id="importData">
                                <i>üì•</i> Importar
                            </button>
                        </div>
                        <div class="backup-card">
                            <div class="backup-icon">üîÑ</div>
                            <div class="backup-title">Restaurar</div>
                            <div class="backup-description">Restaurar de backup anterior</div>
                            <button class="btn btn-warning" id="restoreBackup">
                                <i>üîÑ</i> Restaurar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Maintenance Section -->
                <div class="maintenance-section">
                    <h3 style="margin: 0 0 var(--spacing-4) 0; font-size: var(--font-size-xl); font-weight: 600; color: var(--text-primary);">
                        üîß Manuten√ß√£o da Base de Dados
                    </h3>
                    <div class="maintenance-grid">
                        <div class="maintenance-item">
                            <div class="maintenance-header">
                                <div class="maintenance-icon">üßπ</div>
                                <div class="maintenance-title">Limpeza</div>
                            </div>
                            <div class="maintenance-description">
                                Remove registos antigos e otimiza o espa√ßo em disco
                            </div>
                            <div class="maintenance-actions">
                                <button class="btn btn-sm btn-secondary" id="cleanupOldRecords">
                                    <i>üóëÔ∏è</i> Limpar Antigos
                                </button>
                                <button class="btn btn-sm btn-secondary" id="optimizeTables">
                                    <i>‚ö°</i> Otimizar
                                </button>
                            </div>
                        </div>
                        
                        <div class="maintenance-item">
                            <div class="maintenance-header">
                                <div class="maintenance-icon">üìä</div>
                                <div class="maintenance-title">Estat√≠sticas</div>
                            </div>
                            <div class="maintenance-description">
                                Atualiza estat√≠sticas para melhorar performance das consultas
                            </div>
                            <div class="maintenance-actions">
                                <button class="btn btn-sm btn-secondary" id="updateStats">
                                    <i>üìä</i> Atualizar Stats
                                </button>
                                <button class="btn btn-sm btn-secondary" id="analyzePerformance">
                                    <i>üîç</i> Analisar
                                </button>
                            </div>
                        </div>
                        
                        <div class="maintenance-item">
                            <div class="maintenance-header">
                                <div class="maintenance-icon">üîí</div>
                                <div class="maintenance-title">Seguran√ßa</div>
                            </div>
                            <div class="maintenance-description">
                                Verifica integridade e aplica pol√≠ticas de seguran√ßa
                            </div>
                            <div class="maintenance-actions">
                                <button class="btn btn-sm btn-secondary" id="checkIntegrity">
                                    <i>üîç</i> Verificar
                                </button>
                                <button class="btn btn-sm btn-secondary" id="updatePolicies">
                                    <i>üîí</i> Pol√≠ticas
                                </button>
                            </div>
                        </div>
                        
                        <div class="maintenance-item">
                            <div class="maintenance-header">
                                <div class="maintenance-icon">üìà</div>
                                <div class="maintenance-title">Monitoriza√ß√£o</div>
                            </div>
                            <div class="maintenance-description">
                                Monitoriza performance e uso de recursos
                            </div>
                            <div class="maintenance-actions">
                                <button class="btn btn-sm btn-secondary" id="viewMetrics">
                                    <i>üìà</i> M√©tricas
                                </button>
                                <button class="btn btn-sm btn-secondary" id="viewLogs">
                                    <i>üìã</i> Logs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SQL Editor -->
                <div class="sql-editor">
                    <div class="sql-header">
                        <h3 class="sql-title">üíª Editor SQL</h3>
                        <div class="db-actions">
                            <button class="btn btn-sm btn-primary" id="executeQuery">
                                <i>‚ñ∂Ô∏è</i> Executar
                            </button>
                            <button class="btn btn-sm btn-secondary" id="clearQuery">
                                <i>üóëÔ∏è</i> Limpar
                            </button>
                        </div>
                    </div>
                    <div class="sql-content">
                        <textarea class="sql-textarea" id="sqlQuery" placeholder="-- Digite sua consulta SQL aqui...
-- Exemplo:
SELECT * FROM events WHERE status = 'active';

-- Ou:
UPDATE participants SET status = 'confirmed' WHERE dorsal = 123;"></textarea>
                        
                        <div class="sql-actions">
                            <button class="btn btn-primary" id="runQuery">
                                <i>‚ñ∂Ô∏è</i> Executar Consulta
                            </button>
                            <button class="btn btn-secondary" id="explainQuery">
                                <i>üîç</i> Explicar
                            </button>
                            <button class="btn btn-secondary" id="saveQuery">
                                <i>üíæ</i> Guardar
                            </button>
                        </div>
                        
                        <div class="query-results" id="queryResults" style="display: none;">
                            <div class="query-results-header">Resultados da Consulta</div>
                            <div class="query-results-content" id="queryResultsContent">
                                <!-- Results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </main>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="app-bottom-nav">
            <button class="nav-btn" onclick="window.location.href='/'">
                <i>üè†</i>
                <span>Home</span>
            </button>
            <button class="nav-btn" onclick="window.location.href='/events'">
                <i>üèÉ</i>
                <span>Eventos</span>
            </button>
            <button class="nav-btn" onclick="window.location.href='/detection'">
                <i>üì±</i>
                <span>Detec√ß√£o</span>
            </button>
            <button class="nav-btn active">
                <i>üóÑÔ∏è</i>
                <span>BD</span>
            </button>
        </nav>
    </div>
    
    <!-- Scripts -->
    <script src="supabase.js"></script>
    <script src="navigation.js"></script>
    
    <!-- Database Management Logic -->
    <script>
        // Global variables
        let databaseTables = [];
        let queryHistory = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize navigation
            if (window.Navigation) {
                window.Navigation.init('database');
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Load database information
            loadDatabaseInfo();
            loadTables();
        });
        
        function setupEventListeners() {
            // Header actions
            document.getElementById('refreshData').addEventListener('click', refreshAllData);
            document.getElementById('exportSchema').addEventListener('click', exportSchema);
            document.getElementById('emergencyBackup').addEventListener('click', emergencyBackup);
            
            // Table management
            document.getElementById('createTable').addEventListener('click', createTable);
            document.getElementById('refreshTables').addEventListener('click', loadTables);
            document.getElementById('refreshOverview').addEventListener('click', loadDatabaseInfo);
            
            // Backup actions
            document.getElementById('fullBackup').addEventListener('click', createFullBackup);
            document.getElementById('exportData').addEventListener('click', exportData);
            document.getElementById('importData').addEventListener('click', importData);
            document.getElementById('restoreBackup').addEventListener('click', restoreBackup);
            
            // Maintenance actions
            document.getElementById('cleanupOldRecords').addEventListener('click', cleanupOldRecords);
            document.getElementById('optimizeTables').addEventListener('click', optimizeTables);
            document.getElementById('updateStats').addEventListener('click', updateStats);
            document.getElementById('analyzePerformance').addEventListener('click', analyzePerformance);
            document.getElementById('checkIntegrity').addEventListener('click', checkIntegrity);
            document.getElementById('updatePolicies').addEventListener('click', updatePolicies);
            document.getElementById('viewMetrics').addEventListener('click', viewMetrics);
            document.getElementById('viewLogs').addEventListener('click', viewLogs);
            
            // SQL Editor
            document.getElementById('runQuery').addEventListener('click', executeQuery);
            document.getElementById('explainQuery').addEventListener('click', explainQuery);
            document.getElementById('saveQuery').addEventListener('click', saveQuery);
            document.getElementById('clearQuery').addEventListener('click', clearQuery);
            document.getElementById('executeQuery').addEventListener('click', executeQuery);
            
            // Menu toggle mobile
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }
        }
        
        async function loadDatabaseInfo() {
            if (!window.supabaseClient || !window.supabaseClient.supabase) {
                console.log('Aguardando Supabase...');
                setTimeout(loadDatabaseInfo, 1000);
                return;
            }
            
            try {
                // Carregar contagens das tabelas principais
                const tables = ['events', 'participants', 'detections', 'classifications', 'devices', 'image_buffer'];
                let totalRecords = 0;
                
                for (const table of tables) {
                    const { count, error } = await window.supabaseClient.supabase
                        .from(table)
                        .select('*', { count: 'exact', head: true });
                    
                    if (!error && count !== null) {
                        totalRecords += count;
                    }
                }
                
                document.getElementById('totalTables').textContent = tables.length;
                document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
                document.getElementById('dbSize').textContent = 'N/A';
                document.getElementById('lastBackup').textContent = 'Nunca';
                
            } catch (error) {
                console.error('Erro ao carregar info:', error);
            }
        }
        
        async function loadTables() {
            if (!window.supabaseClient || !window.supabaseClient.supabase) {
                return;
            }
            
            try {
                const tableDefs = [
                    { name: 'events', description: 'Eventos desportivos', icon: 'üèÉ' },
                    { name: 'participants', description: 'Participantes dos eventos', icon: 'üë•' },
                    { name: 'detections', description: 'Detec√ß√µes de dorsais', icon: 'üì±' },
                    { name: 'classifications', description: 'Classifica√ß√µes e rankings', icon: 'üèÜ' },
                    { name: 'devices', description: 'Dispositivos registrados', icon: 'üì±' },
                    { name: 'event_devices', description: 'Associa√ß√£o evento-dispositivo', icon: 'üîó' },
                    { name: 'image_buffer', description: 'Buffer de imagens para processamento', icon: 'üñºÔ∏è' },
                    { name: 'checkpoint_types', description: 'Tipos de checkpoints', icon: 'üìç' }
                ];
                
                databaseTables = [];
                
                // Carregar contagem de registros para cada tabela
                for (const tableDef of tableDefs) {
                    const { count, error } = await window.supabaseClient.supabase
                        .from(tableDef.name)
                        .select('*', { count: 'exact', head: true });
                    
                    databaseTables.push({
                        ...tableDef,
                        records: error ? 0 : (count || 0),
                        size: 'N/A',
                        lastModified: 'Agora'
                    });
                }
                
                renderTables();
            
            renderTables();
        }
        
        function renderTables() {
            const container = document.getElementById('tableList');
            container.innerHTML = '';
            
            databaseTables.forEach(table => {
                const tableItem = document.createElement('div');
                tableItem.className = 'table-item';
                
                tableItem.innerHTML = `
                    <div class="table-info">
                        <div class="table-icon">${table.icon}</div>
                        <div class="table-details">
                            <div class="table-name">${table.name}</div>
                            <div class="table-description">
                                ${table.description} ‚Ä¢ ${table.records.toLocaleString()} registos ‚Ä¢ ${table.size} ‚Ä¢ ${table.lastModified}
                            </div>
                        </div>
                    </div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="viewTable('${table.name}')">
                            <i>üëÅÔ∏è</i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editTable('${table.name}')">
                            <i>‚úèÔ∏è</i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="analyzeTable('${table.name}')">
                            <i>üìä</i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTable('${table.name}')">
                            <i>üóëÔ∏è</i>
                        </button>
                    </div>
                `;
                
                container.appendChild(tableItem);
            });
        }
        
        function viewTable(tableName) {
            showSuccess(`Visualizando tabela: ${tableName}`);
            // Implement table viewer
        }
        
        function editTable(tableName) {
            showSuccess(`Editando tabela: ${tableName}`);
            // Implement table editor
        }
        
        function analyzeTable(tableName) {
            showSuccess(`Analisando tabela: ${tableName}`);
            // Implement table analysis
        }
        
        function deleteTable(tableName) {
            if (confirm(`Tem certeza que deseja eliminar a tabela "${tableName}"? Esta a√ß√£o √© irrevers√≠vel!`)) {
                showSuccess(`Tabela "${tableName}" eliminada`);
                // Implement table deletion
            }
        }
        
        function createTable() {
            const tableName = prompt('Nome da nova tabela:');
            if (tableName) {
                showSuccess(`Tabela "${tableName}" criada`);
                // Implement table creation
            }
        }
        
        async function createFullBackup() {
            if (!window.supabaseClient || !window.supabaseClient.supabase) {
                showError('Supabase n√£o dispon√≠vel');
                return;
            }
            
            try {
                showProgress('Criando backup completo...', 0);
                
                const backup = {
                    timestamp: new Date().toISOString(),
                    tables: {}
                };
                
                const tables = ['events', 'participants', 'detections', 'classifications', 'devices', 'event_devices'];
                
                for (let i = 0; i < tables.length; i++) {
                    const table = tables[i];
                    updateProgress((i / tables.length) * 100, `Exportando ${table}...`);
                    
                    const { data, error } = await window.supabaseClient.supabase
                        .from(table)
                        .select('*');
                    
                    if (!error) {
                        backup.tables[table] = data;
                    }
                }
                
                // Download como JSON
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `visionkrono_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                hideProgress();
                showSuccess('Backup completo criado!');
                
            } catch (error) {
                hideProgress();
                console.error('Erro no backup:', error);
                showError('Erro ao criar backup');
            }
        }
        
        async function exportData() {
            try {
                const tables = ['events', 'participants', 'detections', 'classifications'];
                
                for (const table of tables) {
                    const { data, error } = await window.supabaseClient.supabase
                        .from(table)
                        .select('*');
                    
                    if (error) continue;
                    
                    // CSV export
                    if (data && data.length > 0) {
                        const headers = Object.keys(data[0]);
                        const csv = [
                            headers.join(','),
                            ...data.map(row => headers.map(h => JSON.stringify(row[h] || '')).join(','))
                        ].join('\n');
                        
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${table}_${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                }
                
                showSuccess('Dados exportados em CSV');
                
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showError('Erro ao exportar dados');
            }
        }
        
        function importData() {
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    showSuccess(`Arquivo "${file.name}" importado com sucesso`);
                }
            };
            input.click();
        }
        
        function restoreBackup() {
            if (confirm('Tem certeza que deseja restaurar de um backup? Todos os dados atuais ser√£o perdidos!')) {
                showSuccess('Backup restaurado com sucesso');
                // Implement backup restoration
            }
        }
        
        async function cleanupOldRecords() {
            if (!confirm('Apagar registros antigos? (imagens processadas h√° mais de 7 dias)')) {
                return;
            }
            
            try {
                showProgress('Limpando registos antigos...', 0);
                
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                // Limpar buffer de imagens antigas processadas
                const { error } = await window.supabaseClient.supabase
                    .from('image_buffer')
                    .delete()
                    .lt('captured_at', sevenDaysAgo.toISOString())
                    .in('status', ['processed', 'discarded']);
                
                if (error) throw error;
                
                hideProgress();
                showSuccess('Registros antigos removidos!');
                await loadDatabaseInfo();
                await loadTables();
                
            } catch (error) {
                hideProgress();
                console.error('Erro:', error);
                showError('Erro ao limpar registros');
            }
        }
        
        function optimizeTables() {
            showProgress('Otimizando tabelas...', 0);
            
            setTimeout(() => {
                hideProgress();
                showSuccess('Tabelas otimizadas');
            }, 3000);
        }
        
        function updateStats() {
            showSuccess('Estat√≠sticas atualizadas');
            // Implement stats update
        }
        
        function analyzePerformance() {
            showSuccess('An√°lise de performance conclu√≠da');
            // Implement performance analysis
        }
        
        function checkIntegrity() {
            showSuccess('Verifica√ß√£o de integridade conclu√≠da - Sem problemas encontrados');
            // Implement integrity check
        }
        
        function updatePolicies() {
            showSuccess('Pol√≠ticas de seguran√ßa atualizadas');
            // Implement policy update
        }
        
        function viewMetrics() {
            showSuccess('M√©tricas de performance (funcionalidade em desenvolvimento)');
            // Implement metrics viewer
        }
        
        function viewLogs() {
            showSuccess('Logs do sistema (funcionalidade em desenvolvimento)');
            // Implement logs viewer
        }
        
        function executeQuery() {
            const query = document.getElementById('sqlQuery').value.trim();
            if (!query) {
                showError('Digite uma consulta SQL');
                return;
            }
            
            showProgress('Executando consulta...', 0);
            
            // Simulate query execution
            setTimeout(() => {
                hideProgress();
                
                // Show results
                const resultsContainer = document.getElementById('queryResults');
                const resultsContent = document.getElementById('queryResultsContent');
                
                resultsContainer.style.display = 'block';
                resultsContent.innerHTML = `
                    <div style="color: var(--success); margin-bottom: var(--spacing-2);">
                        ‚úÖ Consulta executada com sucesso
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: var(--spacing-2);">
                        Tempo de execu√ß√£o: 45ms
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: var(--spacing-2);">
                        Registos afetados: 15
                    </div>
                    <div style="color: var(--text-primary);">
                        ${query}
                    </div>
                `;
                
                // Add to history
                queryHistory.push({
                    query: query,
                    timestamp: new Date(),
                    executionTime: 45,
                    affectedRows: 15
                });
                
                showSuccess('Consulta executada com sucesso');
            }, 1000);
        }
        
        function explainQuery() {
            const query = document.getElementById('sqlQuery').value.trim();
            if (!query) {
                showError('Digite uma consulta SQL');
                return;
            }
            
            showSuccess('Explica√ß√£o da consulta (funcionalidade em desenvolvimento)');
            // Implement query explanation
        }
        
        function saveQuery() {
            const query = document.getElementById('sqlQuery').value.trim();
            if (!query) {
                showError('Digite uma consulta SQL');
                return;
            }
            
            showSuccess('Consulta guardada');
            // Implement query saving
        }
        
        function clearQuery() {
            document.getElementById('sqlQuery').value = '';
            document.getElementById('queryResults').style.display = 'none';
        }
        
        function refreshAllData() {
            loadDatabaseInfo();
            loadTables();
            showSuccess('Dados atualizados');
        }
        
        function exportSchema() {
            const schema = {
                tables: databaseTables,
                timestamp: new Date().toISOString(),
                version: '1.0.0'
            };
            
            const blob = new Blob([JSON.stringify(schema, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `schema_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showSuccess('Schema exportado');
        }
        
        function emergencyBackup() {
            if (confirm('Criar backup de emerg√™ncia? Esta opera√ß√£o pode demorar alguns minutos.')) {
                showProgress('Criando backup de emerg√™ncia...', 0);
                
                setTimeout(() => {
                    hideProgress();
                    showSuccess('Backup de emerg√™ncia criado com sucesso');
                }, 5000);
            }
        }
        
        function showProgress(text, percentage) {
            // Create progress modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>${text}</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percentage}%;"></div>
                    </div>
                    <div class="progress-text">${percentage}%</div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function updateProgress(percentage, text) {
            const modal = document.querySelector('.modal');
            if (modal) {
                const progressFill = modal.querySelector('.progress-fill');
                const progressText = modal.querySelector('.progress-text');
                const title = modal.querySelector('h3');
                
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = `${percentage}%`;
                title.textContent = text;
            }
        }
        
        function hideProgress() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function showSuccess(message) {
            showToast(message, 'success');
        }
        
        function showError(message) {
            showToast(message, 'error');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
    </script>
    
    <style>
        /* Layout with Sidebar Structure */
        .layout-with-sidebar {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
        }
        
        /* Sidebar styles */
        .layout-with-sidebar .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1050;
            overflow-y: auto;
            transition: transform var(--transition-slow);
        }
        
        /* Header styles */
        .layout-with-sidebar .header {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 1040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-5);
            transition: left var(--transition-slow);
        }
        
        /* Main content area */
        .layout-with-sidebar .main {
            margin-left: 280px;
            margin-top: 60px;
            width: calc(100% - 280px);
            min-height: calc(100vh - 60px);
            transition: margin-left var(--transition-slow), width var(--transition-slow);
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            padding: var(--spacing-6);
            border-radius: var(--radius-lg);
            text-align: center;
            min-width: 300px;
            border: 1px solid var(--border-color);
        }
        
        .modal-content h3 {
            margin: 0 0 var(--spacing-4) 0;
            color: var(--text-primary);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: var(--radius-base);
            overflow: hidden;
            margin-bottom: var(--spacing-2);
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: var(--radius-base);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        /* Mobile adjustments */
        @media (max-width: 1024px) {
            body {
                overflow-x: hidden;
            }
            
            .layout-with-sidebar .sidebar {
                transform: translateX(-100%);
            }
            
            .layout-with-sidebar .sidebar.sidebar-open {
                transform: translateX(0);
            }
            
            .layout-with-sidebar .header {
                left: 0;
            }
            
            .layout-with-sidebar .main {
                margin-left: 0 !important;
                margin-top: 60px !important;
                width: 100% !important;
                min-height: calc(100vh - 60px) !important;
                padding-bottom: 80px !important;
            }
            
            /* Ensure content fills the screen */
            #mainContent {
                min-height: calc(100vh - 60px - 80px);
                padding: var(--spacing-4);
            }
            
            #menuToggle {
                display: block !important;
            }
            
            .app-bottom-nav {
                display: flex !important;
            }
        }
    </style>
</body>
</html>
