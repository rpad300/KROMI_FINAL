<!DOCTYPE html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Utilizadores - VisionKrono</title>
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="kromi-design-system.css">
    <link rel="stylesheet" href="kromi-layout-fixes.css">
    <link rel="stylesheet" href="dashboard-styles.css?v=2025102609">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="unified-sidebar-styles.css?v=2025102601">
</head>
<body data-theme="dark" class="layout-with-sidebar">
    <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
    <div class="sidebar" id="sidebar"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1 class="header-title">üë• Gest√£o de Utilizadores</h1>
        </div>
        <div class="header-right">
            <button class="btn btn-sm btn-primary" onclick="showAddUserModal()">
                <span>‚ûï</span>
                Adicionar Utilizador
            </button>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main">
        <div id="mainContent" style="padding: var(--spacing-6);">
                <div class="table-container">
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Perfil</th>
                                <th>Estado</th>
                                <th>√öltimo Acesso</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Adicionar Novo Utilizador</h3>
                <button class="modal-close" onclick="hideAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newUserName">Nome Completo <span class="required">*</span></label>
                            <input type="text" id="newUserName" name="name" placeholder="Jo√£o Silva" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserEmail">Email <span class="required">*</span></label>
                            <input type="email" id="newUserEmail" name="email" placeholder="joao@exemplo.com" autocomplete="email" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserPhone">Telefone</label>
                            <input type="tel" id="newUserPhone" name="phone" placeholder="+351 912 345 678" autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label for="newUserOrganization">Organiza√ß√£o</label>
                            <input type="text" id="newUserOrganization" name="organization" placeholder="Empresa XYZ">
                        </div>
                        <div class="form-group">
                            <label for="newUserRole">Perfil <span class="required">*</span></label>
                            <select id="newUserRole" name="role" required>
                                <option value="user">üë§ Utilizador</option>
                                <option value="moderator">‚öôÔ∏è Moderador</option>
                                <option value="admin">üëë Administrador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newUserStatus">Estado</label>
                            <select id="newUserStatus" name="status">
                                <option value="active">‚úÖ Ativo</option>
                                <option value="inactive">‚è∏Ô∏è Inativo</option>
                                <option value="suspended">üö´ Suspenso</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="newUserPassword">Palavra-passe Tempor√°ria <span class="required">*</span></label>
                            <input type="password" id="newUserPassword" name="password" autocomplete="new-password" minlength="8" required>
                            <span class="helper-text">M√≠nimo 8 caracteres. O utilizador pode alterar ap√≥s primeiro login.</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="hideAddUserModal()">Cancelar</button>
                <button type="submit" form="addUserForm" class="btn-primary">‚ûï Criar Utilizador</button>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Utilizador</h3>
                <button class="modal-close" onclick="hideEditUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="id">
                    <input type="hidden" id="editUserUserId" name="user_id">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editUserName">Nome Completo <span class="required">*</span></label>
                            <input type="text" id="editUserName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserEmail">Email <span class="required">*</span></label>
                            <input type="email" id="editUserEmail" name="email" autocomplete="email" readonly>
                            <span class="helper-text">Email n√£o pode ser alterado</span>
                        </div>
                        <div class="form-group">
                            <label for="editUserPhone">Telefone</label>
                            <input type="tel" id="editUserPhone" name="phone" placeholder="+351 912 345 678" autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label for="editUserOrganization">Organiza√ß√£o</label>
                            <input type="text" id="editUserOrganization" name="organization" placeholder="Empresa XYZ">
                        </div>
                        <div class="form-group">
                            <label for="editUserRole">Perfil <span class="required">*</span></label>
                            <select id="editUserRole" name="role" required>
                                <option value="user">üë§ Utilizador</option>
                                <option value="moderator">‚öôÔ∏è Moderador</option>
                                <option value="admin">üëë Administrador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editUserStatus">Estado</label>
                            <select id="editUserStatus" name="status">
                                <option value="active">‚úÖ Ativo</option>
                                <option value="inactive">‚è∏Ô∏è Inativo</option>
                                <option value="suspended">üö´ Suspenso</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Se√ß√£o de Alterar Password -->
                    <div class="password-section">
                        <div class="password-toggle">
                            <input type="checkbox" id="changePassword">
                            <label for="changePassword">Alterar Palavra-passe</label>
                        </div>
                        <div id="passwordFields" style="display: none;">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="editUserNewPassword">Nova Palavra-passe</label>
                                    <input type="password" id="editUserNewPassword" name="newPassword" autocomplete="new-password" minlength="8">
                                    <span class="helper-text">M√≠nimo 8 caracteres. Deixe em branco para manter password atual.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="hideEditUserModal()">Cancelar</button>
                <button type="submit" form="editUserForm" class="btn-primary">üíæ Guardar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="supabase.js?v=2025102605" defer></script>
    <script src="auth-client.js?v=2025102616" defer></script>
    <script src="auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="navigation-config.js?v=2025102601" defer></script>
    <script src="navigation-service.js?v=2025102601" defer></script>
    <script src="navigation-component.js?v=2025102601" defer></script>
    <script src="navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="universal-route-protection.js?v=2025102618" defer></script>
    
    <script src="user-management.js?v=2025102609" defer></script>
    <script>
        // Toggle password fields
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autentica√ß√£o
            verificarAutenticacao(['admin', 'moderator']).then(autenticado => {
                if (!autenticado) return;
                
                // Carregar utilizadores automaticamente
                if (window.userManagement) {
                    window.userManagement.loadUsersTable();
                }
            });
            
            // Toggle password
            const changePasswordCheckbox = document.getElementById('changePassword');
            const passwordFields = document.getElementById('passwordFields');
            
            if (changePasswordCheckbox && passwordFields) {
                changePasswordCheckbox.addEventListener('change', function() {
                    passwordFields.style.display = this.checked ? 'block' : 'none';
                    const passwordInput = document.getElementById('editUserNewPassword');
                    if (passwordInput) {
                        passwordInput.required = this.checked;
                        if (!this.checked) {
                            passwordInput.value = '';
                        }
                    }
                });
            }
        });
        
        function showAddUserModal() {
            if (window.userManagement) {
                window.userManagement.showAddUserModal();
            }
        }
        
        function hideAddUserModal() {
            if (window.userManagement) {
                window.userManagement.hideAddUserModal();
            }
        }
        
        function showEditUserModal(userId) {
            if (window.userManagement) {
                window.userManagement.showEditUserModal(userId);
            }
        }
        
        function hideEditUserModal() {
            if (window.userManagement) {
                window.userManagement.hideEditUserModal();
            }
        }
        
        function logout() {
            if (window.authSystem) {
                window.authSystem.signOut();
            }
        }
    </script>
</body>
</html>

