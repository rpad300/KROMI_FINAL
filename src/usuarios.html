<!DOCTYPE html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Utilizadores - Kromi.online</title>
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    <link rel="stylesheet" href="/dashboard-styles.css?v=2025102609">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    
    <style>
        /* Tabs Styles */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-border);
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            color: var(--color-primary);
            background: var(--color-bg-secondary);
        }
        
        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .modal-large {
            max-width: 900px;
            max-height: 90vh;
        }
        
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg);
            color: var(--color-text);
            font-family: inherit;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }
    </style>
</head>
<body data-theme="dark" class="layout-with-sidebar">
    <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
    <div class="sidebar" id="sidebar"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1 class="header-title">üë• Gest√£o de Utilizadores</h1>
        </div>
        <div class="header-right">
            <button class="btn btn-sm btn-primary" onclick="showAddUserModal()">
                <span>‚ûï</span>
                Adicionar Utilizador
            </button>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main">
        <div id="mainContent" style="padding: var(--spacing-6);">
            <!-- Search and Filter Bar -->
            <div class="search-filter-bar" style="margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <div class="search-box" style="flex: 1; min-width: 250px;">
                    <input type="text" id="searchUsers" placeholder="üîç Pesquisar por nome ou email..." 
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg); color: var(--color-text);">
                </div>
                <div class="filter-group" style="display: flex; gap: 0.5rem; align-items: center;">
                    <select id="filterRole" style="padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg); color: var(--color-text);">
                        <option value="">Todos os Perfis</option>
                        <option value="admin">üëë Administrador</option>
                        <option value="moderator">‚öôÔ∏è Moderador</option>
                        <option value="user">üë§ Utilizador</option>
                    </select>
                    <select id="filterStatus" style="padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg); color: var(--color-text);">
                        <option value="">Todos os Estados</option>
                        <option value="active">‚úÖ Ativo</option>
                        <option value="inactive">‚è∏Ô∏è Inativo</option>
                        <option value="suspended">üö´ Suspenso</option>
                    </select>
                    <button onclick="window.userManagement.clearFilters()" class="btn btn-sm btn-secondary">
                        üîÑ Limpar
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table" id="usersTable">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Perfil</th>
                            <th>Estado</th>
                            <th>√öltimo Acesso</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    </div>
    
    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Adicionar Novo Utilizador</h3>
                <button class="modal-close" onclick="hideAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newUserName">Nome Completo <span class="required">*</span></label>
                            <input type="text" id="newUserName" name="name" placeholder="Jo√£o Silva" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserEmail">Email <span class="required">*</span></label>
                            <input type="email" id="newUserEmail" name="email" placeholder="joao@exemplo.com" autocomplete="email" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserPhone">Telefone</label>
                            <input type="tel" id="newUserPhone" name="phone" placeholder="+351 912 345 678" autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label for="newUserOrganization">Organiza√ß√£o</label>
                            <input type="text" id="newUserOrganization" name="organization" placeholder="Empresa XYZ">
                        </div>
                        <div class="form-group">
                            <label for="newUserRole">Perfil <span class="required">*</span></label>
                            <select id="newUserRole" name="role" required>
                                <option value="user">üë§ Utilizador</option>
                                <option value="moderator">‚öôÔ∏è Moderador</option>
                                <option value="admin">üëë Administrador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newUserStatus">Estado</label>
                            <select id="newUserStatus" name="status">
                                <option value="active">‚úÖ Ativo</option>
                                <option value="inactive">‚è∏Ô∏è Inativo</option>
                                <option value="suspended">üö´ Suspenso</option>
                            </select>
                        </div>
                        <div class="form-group full-width" style="background: var(--color-bg-secondary); padding: 1rem; border-radius: var(--radius-md); border: 2px solid var(--color-primary);">
                            <p style="color: var(--color-text); font-size: 0.9rem; margin: 0;">
                                <span style="color: var(--color-primary); font-weight: bold;">‚ÑπÔ∏è Informa√ß√£o:</span><br>
                                A password ser√° gerada automaticamente e mostrada ap√≥s a cria√ß√£o do utilizador.<br>
                                O utilizador ser√° obrigado a trocar a password no primeiro login.
                            </p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="hideAddUserModal()">Cancelar</button>
                <button type="submit" form="addUserForm" class="btn-primary">‚ûï Criar Utilizador</button>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>‚úèÔ∏è Ficha Completa do Utilizador</h3>
                <button class="modal-close" onclick="hideEditUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('basic')">üìã Informa√ß√£o B√°sica</button>
                    <button class="tab-btn" onclick="switchTab('personal')">üë§ Informa√ß√£o Pessoal</button>
                    <button class="tab-btn" onclick="switchTab('contact')">üìû Contactos</button>
                    <button class="tab-btn" onclick="switchTab('address')">üìç Morada</button>
                    <button class="tab-btn" onclick="switchTab('professional')">üíº Profissional</button>
                    <button class="tab-btn" onclick="switchTab('emergency')">‚ö†Ô∏è Emerg√™ncia</button>
                    <button class="tab-btn" onclick="switchTab('system')">‚öôÔ∏è Sistema</button>
                </div>
                
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="id">
                    <input type="hidden" id="editUserUserId" name="user_id">
                    
                    <!-- Tab 1: Informa√ß√£o B√°sica -->
                    <div id="tab-basic" class="tab-content active">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editUserName">Nome Completo <span class="required">*</span></label>
                                <input type="text" id="editUserName" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="editUserEmail">Email <span class="required">*</span></label>
                                <input type="email" id="editUserEmail" name="email" autocomplete="email" readonly>
                                <span class="helper-text">Email n√£o pode ser alterado</span>
                            </div>
                            <div class="form-group">
                                <label for="editUserPhone">Telefone</label>
                                <input type="tel" id="editUserPhone" name="phone" placeholder="+351 912 345 678" autocomplete="tel">
                            </div>
                            <div class="form-group">
                                <label for="editUserOrganization">Organiza√ß√£o</label>
                                <input type="text" id="editUserOrganization" name="organization" placeholder="Empresa XYZ">
                            </div>
                            <div class="form-group">
                                <label for="editUserRole">Perfil <span class="required">*</span></label>
                                <select id="editUserRole" name="role" required>
                                    <option value="user">üë§ Utilizador</option>
                                    <option value="moderator">‚öôÔ∏è Moderador</option>
                                    <option value="admin">üëë Administrador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editUserStatus">Estado</label>
                                <select id="editUserStatus" name="status">
                                    <option value="active">‚úÖ Ativo</option>
                                    <option value="inactive">‚è∏Ô∏è Inativo</option>
                                    <option value="suspended">üö´ Suspenso</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Se√ß√£o de Alterar Password -->
                        <div class="password-section">
                            <div class="password-toggle">
                                <input type="checkbox" id="changePassword">
                                <label for="changePassword">Alterar Palavra-passe</label>
                            </div>
                            <div id="passwordFields" style="display: none;">
                                <div class="form-grid">
                                    <div class="form-group full-width">
                                        <label for="editUserNewPassword">Nova Palavra-passe</label>
                                        <input type="password" id="editUserNewPassword" name="newPassword" autocomplete="new-password" minlength="8">
                                        <span class="helper-text">M√≠nimo 8 caracteres. Deixe em branco para manter password atual.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 2: Informa√ß√£o Pessoal -->
                    <div id="tab-personal" class="tab-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editUserBirthDate">Data de Nascimento</label>
                                <input type="date" id="editUserBirthDate" name="birth_date">
                            </div>
                            <div class="form-group">
                                <label for="editUserGender">G√©nero</label>
                                <select id="editUserGender" name="gender">
                                    <option value="">Selecionar...</option>
                                    <option value="male">Masculino</option>
                                    <option value="female">Feminino</option>
                                    <option value="other">Outro</option>
                                    <option value="prefer_not_to_say">Prefiro n√£o dizer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editUserNationality">Nacionalidade</label>
                                <input type="text" id="editUserNationality" name="nationality" placeholder="Portuguesa">
                            </div>
                            <div class="form-group">
                                <label for="editUserTaxId">NIF/NIPC</label>
                                <input type="text" id="editUserTaxId" name="tax_id" placeholder="123456789">
                            </div>
                            <div class="form-group full-width">
                                <label for="editUserBiography">Biografia</label>
                                <textarea id="editUserBiography" name="biography" rows="4" placeholder="Informa√ß√£o adicional sobre o utilizador..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 3: Contactos -->
                    <div id="tab-contact" class="tab-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editUserPhoneAlt">Telefone Alternativo</label>
                                <input type="tel" id="editUserPhoneAlt" name="phone_alt" placeholder="+351 912 345 678">
                            </div>
                            <div class="form-group">
                                <label for="editUserEmailAlt">Email Alternativo</label>
                                <input type="email" id="editUserEmailAlt" name="email_alt" placeholder="email.alternativo@exemplo.com">
                            </div>
                            <div class="form-group">
                                <label for="editUserWebsite">Website</label>
                                <input type="url" id="editUserWebsite" name="website" placeholder="https://www.exemplo.com">
                            </div>
                            <div class="form-group full-width">
                                <label>Redes Sociais</label>
                                <div class="form-grid">
                                    <input type="text" id="editUserLinkedIn" name="social_linkedin" placeholder="LinkedIn">
                                    <input type="text" id="editUserTwitter" name="social_twitter" placeholder="Twitter">
                                    <input type="text" id="editUserFacebook" name="social_facebook" placeholder="Facebook">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 4: Morada -->
                    <div id="tab-address" class="tab-content">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="editUserAddressLine1">Morada Linha 1</label>
                                <input type="text" id="editUserAddressLine1" name="address_line1" placeholder="Rua, Avenida, N√∫mero">
                            </div>
                            <div class="form-group full-width">
                                <label for="editUserAddressLine2">Morada Linha 2</label>
                                <input type="text" id="editUserAddressLine2" name="address_line2" placeholder="Complemento, Bloco, Andar">
                            </div>
                            <div class="form-group">
                                <label for="editUserCity">Cidade</label>
                                <input type="text" id="editUserCity" name="city" placeholder="Lisboa">
                            </div>
                            <div class="form-group">
                                <label for="editUserStateProvince">Distrito/Estado</label>
                                <input type="text" id="editUserStateProvince" name="state_province" placeholder="Lisboa">
                            </div>
                            <div class="form-group">
                                <label for="editUserPostalCode">C√≥digo Postal</label>
                                <input type="text" id="editUserPostalCode" name="postal_code" placeholder="1000-001">
                            </div>
                            <div class="form-group">
                                <label for="editUserCountry">Pa√≠s</label>
                                <input type="text" id="editUserCountry" name="country" placeholder="Portugal" value="Portugal">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 5: Profissional -->
                    <div id="tab-professional" class="tab-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editUserJobTitle">Cargo</label>
                                <input type="text" id="editUserJobTitle" name="job_title" placeholder="Gerente de Projetos">
                            </div>
                            <div class="form-group">
                                <label for="editUserDepartment">Departamento</label>
                                <input type="text" id="editUserDepartment" name="department" placeholder="TI">
                            </div>
                            <div class="form-group">
                                <label for="editUserHireDate">Data de In√≠cio</label>
                                <input type="date" id="editUserHireDate" name="hire_date">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 6: Emerg√™ncia -->
                    <div id="tab-emergency" class="tab-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editUserEmergencyName">Nome Contacto</label>
                                <input type="text" id="editUserEmergencyName" name="emergency_contact_name" placeholder="Nome completo">
                            </div>
                            <div class="form-group">
                                <label for="editUserEmergencyPhone">Telefone</label>
                                <input type="tel" id="editUserEmergencyPhone" name="emergency_contact_phone" placeholder="+351 912 345 678">
                            </div>
                            <div class="form-group">
                                <label for="editUserEmergencyRelation">Rela√ß√£o</label>
                                <input type="text" id="editUserEmergencyRelation" name="emergency_contact_relation" placeholder="C√¥njuge, Pai, M√£e, etc.">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 7: Sistema -->
                    <div id="tab-system" class="tab-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editUserTimezone">Fuso Hor√°rio</label>
                                <select id="editUserTimezone" name="timezone">
                                    <option value="Europe/Lisbon">Europe/Lisbon</option>
                                    <option value="Europe/London">Europe/London</option>
                                    <option value="America/New_York">America/New_York</option>
                                    <option value="America/Los_Angeles">America/Los_Angeles</option>
                                    <option value="Asia/Tokyo">Asia/Tokyo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editUserLanguage">Idioma</label>
                                <select id="editUserLanguage" name="language">
                                    <option value="pt">Portugu√™s</option>
                                    <option value="en">English</option>
                                    <option value="es">Espa√±ol</option>
                                    <option value="fr">Fran√ßais</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="hideEditUserModal()">Cancelar</button>
                <button type="submit" form="editUserForm" class="btn-primary">üíæ Guardar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102601" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="/universal-route-protection.js?v=2025102618" defer></script>
    
    <script src="/user-management.js?v=2025102609" defer></script>
    <script>
        // Tab switching function
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Show corresponding content
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }
        
        // Search and filter functionality
        function setupSearchAndFilters() {
            const searchInput = document.getElementById('searchUsers');
            const filterRole = document.getElementById('filterRole');
            const filterStatus = document.getElementById('filterStatus');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    if (window.userManagement) {
                        window.userManagement.applyFilters();
                    }
                });
            }
            
            if (filterRole) {
                filterRole.addEventListener('change', function() {
                    if (window.userManagement) {
                        window.userManagement.applyFilters();
                    }
                });
            }
            
            if (filterStatus) {
                filterStatus.addEventListener('change', function() {
                    if (window.userManagement) {
                        window.userManagement.applyFilters();
                    }
                });
            }
        }
        
        // Toggle password fields
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autentica√ß√£o
            verificarAutenticacao(['admin', 'moderator']).then(autenticado => {
                if (!autenticado) return;
                
                // Setup search and filters
                setupSearchAndFilters();
                
                // Carregar utilizadores automaticamente
                if (window.userManagement) {
                    window.userManagement.loadUsersTable();
                }
            });
            
            // Toggle password
            const changePasswordCheckbox = document.getElementById('changePassword');
            const passwordFields = document.getElementById('passwordFields');
            
            if (changePasswordCheckbox && passwordFields) {
                changePasswordCheckbox.addEventListener('change', function() {
                    passwordFields.style.display = this.checked ? 'block' : 'none';
                    const passwordInput = document.getElementById('editUserNewPassword');
                    if (passwordInput) {
                        passwordInput.required = this.checked;
                        if (!this.checked) {
                            passwordInput.value = '';
                        }
                    }
                });
            }
        });
        
        function showAddUserModal() {
            if (window.userManagement) {
                window.userManagement.showAddUserModal();
            }
        }
        
        function hideAddUserModal() {
            if (window.userManagement) {
                window.userManagement.hideAddUserModal();
            }
        }
        
        function showEditUserModal(userId) {
            if (window.userManagement) {
                window.userManagement.showEditUserModal(userId);
            }
        }
        
        function hideEditUserModal() {
            if (window.userManagement) {
                window.userManagement.hideEditUserModal();
            }
        }
        
        function logout() {
            if (window.authSystem) {
                window.authSystem.signOut();
            }
        }
    </script>
</body>
</html>

