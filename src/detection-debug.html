<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug DetecÃ§Ã£o - VisionKrono</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }
        
        .debug-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .status.loading {
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid #ffa500;
        }
        
        .status.success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
        }
        
        .status.error {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid #ff3b30;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #00ff88;
            color: black;
            cursor: pointer;
            font-weight: bold;
        }
        
        #logs {
            background: #222;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Debug DetecÃ§Ã£o Mobile</h1>
    
    <div class="debug-section">
        <h2>ğŸ“± ParÃ¢metros da URL</h2>
        <div id="urlParams">Carregando...</div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ”§ Status de InicializaÃ§Ã£o</h2>
        <div id="initStatus">
            <div class="status loading">â³ Aguardando inÃ­cio...</div>
        </div>
        <button onclick="startDebugInit()">ğŸš€ Iniciar Debug</button>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ“Š Supabase</h2>
        <div id="supabaseStatus">NÃ£o testado</div>
        <button onclick="testSupabase()">ğŸ§ª Testar Supabase</button>
    </div>
    
    <div class="debug-section">
        <h2>âš™ï¸ ConfiguraÃ§Ãµes</h2>
        <div id="configStatus">NÃ£o carregadas</div>
        <button onclick="testConfigs()">ğŸ“‹ Testar ConfiguraÃ§Ãµes</button>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ“¹ CÃ¢mera</h2>
        <div id="cameraStatus">NÃ£o testada</div>
        <button onclick="testCamera()">ğŸ“¸ Testar CÃ¢mera</button>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ“‹ Logs Detalhados</h2>
        <div id="logs"></div>
        <button onclick="clearLogs()">ğŸ§¹ Limpar</button>
    </div>
    
    <script src="/supabase.js"></script>
    <script>
        let logs = [];
        let supabaseClient = null;
        let eventId = null;
        let deviceId = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            
            const logsDiv = document.getElementById('logs');
            logsDiv.textContent = logs.slice(-50).join('\n'); // Ãšltimas 50 linhas
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logMessage);
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').textContent = '';
        }
        
        function showUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            eventId = urlParams.get('event');
            deviceId = urlParams.get('device');
            
            document.getElementById('urlParams').innerHTML = `
                <strong>Event ID:</strong> ${eventId || 'NÃ£o especificado'}<br>
                <strong>Device ID:</strong> ${deviceId || 'NÃ£o especificado'}
            `;
            
            log('ğŸ“‹ ParÃ¢metros URL carregados');
            log(`Event: ${eventId}`);
            log(`Device: ${deviceId}`);
        }
        
        async function startDebugInit() {
            const statusDiv = document.getElementById('initStatus');
            
            try {
                statusDiv.innerHTML = '<div class="status loading">â³ Passo 1: Inicializando Supabase...</div>';
                log('ğŸš€ Iniciando debug da inicializaÃ§Ã£o');
                
                supabaseClient = new SupabaseClient();
                const connected = await supabaseClient.init();
                
                statusDiv.innerHTML = `<div class="status ${connected ? 'success' : 'error'}">ğŸ“Š Supabase: ${connected ? 'CONECTADO' : 'FALHOU'}</div>`;
                log(`ğŸ“Š Supabase: ${connected ? 'CONECTADO' : 'FALHOU'}`);
                
                if (connected) {
                    statusDiv.innerHTML += '<div class="status loading">â³ Passo 2: Carregando configuraÃ§Ãµes...</div>';
                    await testConfigs();
                    
                    statusDiv.innerHTML += '<div class="status success">âœ… InicializaÃ§Ã£o completa</div>';
                    log('ğŸ‰ Debug da inicializaÃ§Ã£o completo');
                }
                
            } catch (error) {
                statusDiv.innerHTML += `<div class="status error">âŒ Erro: ${error.message}</div>`;
                log(`âŒ Erro na inicializaÃ§Ã£o: ${error.message}`);
            }
        }
        
        async function testSupabase() {
            const statusDiv = document.getElementById('supabaseStatus');
            
            try {
                log('ğŸ§ª Testando conexÃ£o Supabase...');
                statusDiv.innerHTML = '<div class="status loading">â³ Conectando...</div>';
                
                if (!supabaseClient) {
                    supabaseClient = new SupabaseClient();
                }
                
                const connected = await supabaseClient.init();
                
                if (connected) {
                    statusDiv.innerHTML = '<div class="status success">âœ… Conectado com sucesso</div>';
                    log('âœ… Supabase conectado');
                } else {
                    statusDiv.innerHTML = '<div class="status error">âŒ Falha na conexÃ£o</div>';
                    log('âŒ Falha na conexÃ£o Supabase');
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ Erro: ${error.message}</div>`;
                log(`âŒ Erro Supabase: ${error.message}`);
            }
        }
        
        async function testConfigs() {
            const statusDiv = document.getElementById('configStatus');
            
            try {
                log('ğŸ“‹ Testando carregamento de configuraÃ§Ãµes...');
                statusDiv.innerHTML = '<div class="status loading">â³ Carregando...</div>';
                
                if (!supabaseClient || !supabaseClient.isConnected) {
                    statusDiv.innerHTML = '<div class="status error">âŒ Supabase nÃ£o conectado</div>';
                    return;
                }
                
                if (!eventId) {
                    statusDiv.innerHTML = '<div class="status error">âŒ Event ID nÃ£o especificado</div>';
                    return;
                }
                
                // Testar carregamento de configuraÃ§Ãµes do evento
                log(`ğŸ” Carregando configuraÃ§Ãµes do evento: ${eventId}`);
                
                const { data: configs, error } = await supabaseClient.supabase
                    .from('event_configurations')
                    .select('config_type, config_data')
                    .eq('event_id', eventId);
                
                if (error) {
                    statusDiv.innerHTML = `<div class="status error">âŒ Erro: ${error.message}</div>`;
                    log(`âŒ Erro ao carregar configuraÃ§Ãµes: ${error.message}`);
                    return;
                }
                
                log(`ğŸ“Š ${configs?.length || 0} configuraÃ§Ãµes encontradas`);
                
                let statusHtml = `<div class="status success">âœ… ${configs?.length || 0} configuraÃ§Ãµes carregadas</div>`;
                
                configs?.forEach(config => {
                    statusHtml += `<div style="margin: 5px 0; font-size: 12px;">â€¢ ${config.config_type}</div>`;
                    log(`ğŸ“‹ ${config.config_type}: ${JSON.stringify(config.config_data).substring(0, 100)}...`);
                });
                
                statusDiv.innerHTML = statusHtml;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ Erro: ${error.message}</div>`;
                log(`âŒ Erro ao testar configuraÃ§Ãµes: ${error.message}`);
            }
        }
        
        async function testCamera() {
            const statusDiv = document.getElementById('cameraStatus');
            
            try {
                log('ğŸ“¹ Testando acesso Ã  cÃ¢mera...');
                statusDiv.innerHTML = '<div class="status loading">â³ Solicitando acesso...</div>';
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                statusDiv.innerHTML = '<div class="status success">âœ… CÃ¢mera acessÃ­vel</div>';
                log('âœ… CÃ¢mera funcionando');
                
                // Parar stream
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ Erro: ${error.message}</div>`;
                log(`âŒ Erro na cÃ¢mera: ${error.message}`);
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            showUrlParams();
            log('ğŸš€ Debug page carregada');
        });
    </script>
</body>
</html>
