<!DOCTYPE html>
<html lang="pt-PT" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kromi.online - Form Builder</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kromi.online">
    <meta name="description" content="Form Builder para cria√ß√£o de formul√°rios de inscri√ß√£o din√¢micos">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    <link rel="stylesheet" href="/logo-integration.css?v=2025012701">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
        /* Layout with Sidebar Structure */
        .layout-with-sidebar {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
        }
        
        .layout-with-sidebar .main {
            margin-left: 280px;
            margin-top: 60px;
            width: calc(100% - 280px);
            min-height: calc(100vh - 60px);
            transition: margin-left var(--transition-slow), width var(--transition-slow);
        }
        
        /* Mobile adjustments */
        @media (max-width: 1024px) {
            .layout-with-sidebar .main {
                margin-left: 0 !important;
                margin-top: 60px !important;
                width: 100% !important;
            }
        }
        
        /* Form Builder specific styles */
        .forms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--spacing-5);
            margin-bottom: var(--spacing-6);
        }
        
        .form-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
        }
        
        .form-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        .form-card h3 {
            margin: 0 0 var(--spacing-2) 0;
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-card .form-meta {
            display: flex;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-3);
            flex-wrap: wrap;
        }
        
        .form-card .form-meta span {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
        }
        
        .form-card .form-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-4);
        }
        
        .badge {
            display: inline-block;
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-published {
            background: var(--success-alpha-20);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .badge-draft {
            background: var(--warning-alpha-20);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-8);
            color: var(--text-secondary);
        }
        
        .empty-state div:first-child {
            font-size: 4rem;
            margin-bottom: var(--spacing-4);
        }
        
        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
        }
    </style>
</head>
<body>
    <div class="layout-with-sidebar" id="app">
        <!-- Sidebar Navigation (gera automaticamente) -->
        <nav id="sidebar" class="sidebar"></nav>
        
        <!-- Main Content -->
        <main class="main" id="mainContent">
            <div class="content-wrapper">
                <h1>üìã Form Builder</h1>
                <p class="subtitle">Criar e gerir formul√°rios de inscri√ß√£o din√¢micos</p>
                
                <!-- Event Info (sempre vis√≠vel) -->
                <div class="event-info-container" id="eventInfoContainer" style="margin-bottom: var(--spacing-6);">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 id="eventInfoName">--</h3>
                                <p id="eventInfoDate" style="color: var(--text-secondary); margin: 0;">--</p>
                            </div>
                            <button class="btn btn-secondary" onclick="showEventSelector()">
                                Mudar Evento
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Actions Bar -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-6);">
                    <h2 style="margin: 0;">Formul√°rios</h2>
                    <button class="btn btn-primary" id="btnCreateForm" onclick="createNewForm()" style="display: none;">
                        ‚ûï Novo Formul√°rio
                    </button>
                </div>
                
                <!-- Forms Grid -->
                <div class="forms-grid" id="formsGrid">
                    <div class="empty-state">
                        <div>‚è≥</div>
                        <h3>Carregando...</h3>
                        <p>Aguarde enquanto carregamos os formul√°rios</p>
                    </div>
                </div>
                
                <!-- Loading -->
                <div id="loading" style="display: none; text-align: center; padding: var(--spacing-8);">
                    <div style="font-size: 3rem; margin-bottom: var(--spacing-4);">‚è≥</div>
                    <p>Carregando...</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102701" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <script src="/logo-loader.js?v=2025012702"></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="/universal-route-protection.js?v=2025102618" defer></script>
    
    <!-- Form Builder Logic -->
    <script>
        let currentEventId = null;
        let forms = [];
        
        // Fun√ß√£o para aguardar sistemas
        async function waitForAuthSystem() {
            while (!window.authSystem || !window.authSystem.userProfile) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            return window.authSystem;
        }
        
        async function waitForNavigation() {
            let attempts = 0;
            while (!window.navigationService || !window.NavigationUtils) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
                if (attempts > 50) {
                    console.error('‚ùå Timeout aguardando navega√ß√£o ap√≥s 5s');
                    break;
                }
            }
            console.log('‚úÖ Navigation components dispon√≠veis');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìã Inicializando Form Builder...');
            
            try {
                console.log('‚è≥ Aguardando AuthSystem...');
                await waitForAuthSystem();
                console.log('‚úÖ AuthSystem pronto');
                
                console.log('‚è≥ Aguardando Navigation...');
                await waitForNavigation();
                console.log('‚úÖ Navigation pronto');
                
                console.log('‚úÖ Sistemas prontos');
                
                // Get event from URL
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('event');
                
                console.log('üîç Event ID da URL:', eventId);
                
                // Form Builder SEMPRE requer um evento
                if (!eventId) {
                    console.warn('‚ö†Ô∏è Nenhum evento especificado na URL');
                    alert('Por favor, selecione um evento primeiro.\n\nVoc√™ ser√° redirecionado para a lista de eventos.');
                    window.location.href = '/events-kromi.html';
                    return;
                }
                
                console.log('üéØ Evento selecionado:', eventId);
                console.log('üì• Iniciando carregamento do evento e formul√°rios...');
                
                // Load event and forms directly
                await loadEventAndForms(eventId);
                
                console.log('‚úÖ Form Builder inicializado');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar:', error);
                console.error('Stack trace:', error.stack);
            }
        });
        
        async function loadEventAndForms(eventId) {
            console.log('üöÄ loadEventAndForms chamada com eventId:', eventId);
            
            if (!eventId) {
                console.error('‚ùå eventId vazio, abortando');
                return;
            }
            
            currentEventId = eventId;
            console.log('‚úÖ currentEventId definido:', currentEventId);
            
            // Show button
            console.log('üîò Mostrando bot√£o Novo Formul√°rio...');
            const btnCreateForm = document.getElementById('btnCreateForm');
            if (btnCreateForm) {
                btnCreateForm.style.display = 'block';
                console.log('‚úÖ Bot√£o Novo Formul√°rio vis√≠vel');
            } else {
                console.error('‚ùå Bot√£o btnCreateForm n√£o encontrado!');
            }
            
            console.log('üîç Carregando informa√ß√µes do evento:', eventId);
            
            // Load event info
            try {
                console.log('üì° Fazendo fetch para /api/events/' + eventId);
                const response = await fetch(`/api/events/${eventId}`, {
                    credentials: 'include'
                });
                
                console.log('üì• Response recebido:', response.status);
                const data = await response.json();
                console.log('üìä Data recebido:', data);
                
                const { success, event } = data;
                
                if (success && event) {
                    console.log('‚úÖ Evento carregado com sucesso:', event.name);
                    document.getElementById('eventInfoName').textContent = event.name;
                    document.getElementById('eventInfoDate').textContent = event.event_date 
                        ? new Date(event.event_date).toLocaleDateString('pt-PT')
                        : 'Data n√£o definida';
                    
                    // Update navigation context
                    if (window.navigationService) {
                        console.log('üîÑ Atualizando contexto de navega√ß√£o...');
                        window.navigationService.setEventContext(eventId, event.name);
                        console.log('‚úÖ Contexto atualizado');
                    } else {
                        console.warn('‚ö†Ô∏è navigationService n√£o dispon√≠vel');
                    }
                } else {
                    console.error('‚ùå Erro ao carregar evento - success:', success);
                }
            } catch (error) {
                console.error('‚ùå Erro ao buscar evento:', error);
                console.error('Stack:', error.stack);
            }
            
            // Load forms
            console.log('üìã Carregando formul√°rios...');
            await loadForms(eventId);
            console.log('‚úÖ loadEventAndForms conclu√≠da');
        }
        
        function showEventSelector() {
            // Form Builder sempre requer evento - redirecionar para lista de eventos
            if (confirm('Deseja voltar para a lista de eventos?')) {
                window.location.href = '/events-kromi.html';
            }
        }
        
        async function loadForms(eventId) {
            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch(`/api/events/${eventId}/forms`, {
                    credentials: 'include'
                });
                
                const { success, forms: formsData, error } = await response.json();
                
                if (!success) {
                    console.error('‚ùå Erro ao carregar formul√°rios:', error);
                    renderForms([]);
                    return;
                }
                
                forms = formsData || [];
                console.log('üìã Formul√°rios carregados:', forms);
                renderForms(forms);
            } catch (error) {
                console.error('‚ùå Erro ao carregar formul√°rios:', error);
                renderForms([]);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function renderForms(forms) {
            const grid = document.getElementById('formsGrid');
            
            if (!forms || forms.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div>üìã</div>
                        <h3>Nenhum Formul√°rio</h3>
                        <p>Crie seu primeiro formul√°rio de inscri√ß√£o clicando no bot√£o "‚ûï Novo Formul√°rio" acima</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = forms.map(form => `
                <div class="form-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-3);">
                        <h3>${form.form_title_translations?.pt || form.form_title_translations?.en || 'Sem t√≠tulo'}</h3>
                        ${form.published_at ? '<span class="badge badge-published">Publicado</span>' : '<span class="badge badge-draft">Rascunho</span>'}
                    </div>
                    <div class="form-meta">
                        <span>üìÖ ${new Date(form.created_at).toLocaleDateString('pt-PT')}</span>
                        <span>üîó /form/${form.form_slug}</span>
                    </div>
                    <p style="color: var(--text-secondary); margin: 0 0 var(--spacing-4) 0;">${form.form_description_translations?.pt || ''}</p>
                    <div class="form-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewForm('${form.id}')">Ver</button>
                        <button class="btn btn-sm btn-secondary" onclick="editForm('${form.id}')">Editar</button>
                        <button class="btn btn-sm btn-secondary" onclick="viewSubmissions('${form.id}')">Submiss√µes</button>
                    </div>
                </div>
            `).join('');
        }
        
        function createNewForm() {
            if (!currentEventId) return;
            
            const title = prompt('Nome do formul√°rio:');
            if (!title) return;
            
            fetch(`/api/events/${currentEventId}/forms`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    form_title: { pt: title, en: title },
                    form_description: { pt: '', en: '' }
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Formul√°rio criado! Redirecionando...');
                    window.location.href = `/form-builder-edit.html?form=${data.form.id}&event=${currentEventId}`;
                } else {
                    alert('Erro: ' + data.error);
                }
            })
            .catch(err => {
                console.error('Erro:', err);
                alert('Erro ao criar formul√°rio');
            });
        }
        
        function viewForm(formId) {
            window.location.href = `/form-builder-edit.html?form=${formId}&event=${currentEventId}`;
        }
        
        function editForm(formId) {
            window.location.href = `/form-builder-edit.html?form=${formId}&event=${currentEventId}`;
        }
        
        function viewSubmissions(formId) {
            window.location.href = `/form-submissions-kromi.html?form=${formId}&event=${currentEventId}`;
        }
    </script>
</body>
</html>

