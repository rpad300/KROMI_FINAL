<!DOCTYPE html>
<html lang="pt-PT" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordem dos Checkpoints - VisionKrono</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VisionKrono">
    <meta name="description" content="Sistema de detec√ß√£o de dorsais VisionKrono">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
        /* Layout with Sidebar Structure */
        .layout-with-sidebar {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
        }
        
        /* Sidebar styles */
        .layout-with-sidebar .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1050;
            overflow-y: auto;
            transition: transform var(--transition-slow);
        }
        
        /* Header styles */
        .layout-with-sidebar .header {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 1040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-5);
            transition: left var(--transition-slow);
        }
        
        /* Main content area */
        .layout-with-sidebar .main {
            margin-left: 280px;
            margin-top: 60px;
            width: calc(100% - 280px);
            min-height: calc(100vh - 60px);
            transition: margin-left var(--transition-slow), width var(--transition-slow);
        }
        
        /* Mobile adjustments */
        @media (max-width: 1024px) {
            body {
                overflow-x: hidden;
            }
            
            .layout-with-sidebar .sidebar {
                transform: translateX(-100%);
            }
            
            .layout-with-sidebar .sidebar.sidebar-open {
                transform: translateX(0);
            }
            
            .layout-with-sidebar .header {
                left: 0;
            }
            
            .layout-with-sidebar .main {
                margin-left: 0 !important;
                margin-top: 60px !important;
                width: 100% !important;
                min-height: calc(100vh - 60px) !important;
                padding-bottom: 80px !important;
            }
            
            #mainContent {
                min-height: calc(100vh - 60px - 80px);
                padding: var(--spacing-4);
            }
            
            #menuToggle {
                display: block !important;
            }
            
            .app-bottom-nav {
                display: flex !important;
            }
        }
        
        /* Checkpoint order styles */
        .checkpoint-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-6);
        }
        
        .checkpoint-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            cursor: move;
            transition: all var(--transition-base);
        }
        
        .checkpoint-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .checkpoint-item.dragging {
            opacity: 0.5;
        }
        
        .checkpoint-order-badge {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--font-size-xl);
            flex-shrink: 0;
        }
        
        .checkpoint-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .checkpoint-info {
            flex: 1;
        }
        
        .checkpoint-name {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-1);
        }
        
        .checkpoint-details {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .checkpoint-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .quick-link-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            border: 1px solid var(--border-color);
            margin-bottom: var(--spacing-5);
        }
        
        .quick-link-input {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-3);
        }
        
        .quick-link-input input {
            flex: 1;
            padding: var(--spacing-3);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-base);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            font-family: var(--font-family-mono);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-12);
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-4);
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .checkpoint-item {
                flex-direction: column;
                text-align: center;
            }
            
            .checkpoint-actions {
                width: 100%;
                flex-direction: column;
            }
            
            .checkpoint-actions .btn {
                width: 100%;
            }
            
            .quick-link-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- App Container -->
    <div class="layout-with-sidebar">
        <!-- Sidebar -->
        <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
        <div class="sidebar" id="sidebar"></div>
        
        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: var(--spacing-4);">
                <button class="btn btn-icon btn-secondary" id="menuToggle" onclick="toggleSidebar()">
                    <i>‚ò∞</i>
                </button>
                <h2 id="pageTitle" style="font-size: var(--font-size-2xl); font-weight: 600; margin: 0;">
                    üìç Configurar Ordem dos Checkpoints
                </h2>
            </div>
            <div style="display: flex; gap: var(--spacing-2); align-items: center;" id="headerActions">
                <div id="connectionStatus" style="font-size: var(--font-size-xs); padding: var(--spacing-2); border-radius: var(--radius-full); display: flex; align-items: center; gap: var(--spacing-1);">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--danger);"></div>
                    <span>Verificando...</span>
                </div>
                <button class="btn btn-sm btn-primary" id="addCheckpointBtn">
                    <i>‚ûï</i> Adicionar Checkpoint
                </button>
                <button class="btn btn-sm btn-success" id="saveOrderBtn">
                    <i>üíæ</i> Salvar Ordem
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main">
            <div style="flex: 1; overflow-y: auto; padding: var(--spacing-5);" id="mainContent">
                
                <!-- Info Section -->
                <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-4); margin-bottom: var(--spacing-5); border: 1px solid var(--border-color);">
                    <h3 style="margin: 0 0 var(--spacing-2) 0; color: var(--primary);">üìç Como Funciona</h3>
                    <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm); line-height: 1.6;">
                        Configure a <strong>ordem dos checkpoints</strong> no percurso do evento. 
                        A ordem define como os <strong>splits s√£o calculados</strong> nas classifica√ß√µes.
                        Arraste os checkpoints para reordenar.
                    </p>
                </div>
                
                <!-- Quick Link Section -->
                <div class="quick-link-section">
                    <h3 style="margin: 0 0 var(--spacing-2) 0; color: var(--text-primary);">
                        üîó Link R√°pido para Detec√ß√£o
                    </h3>
                    <p style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--spacing-3);">
                        Partilhe este link com os operadores. Cada dispositivo ser√° configurado automaticamente.
                    </p>
                    <div class="quick-link-input">
                        <input type="text" readonly id="quickLinkInput" value="Carregando...">
                        <button class="btn btn-secondary" id="copyLinkBtn">
                            <i>üìã</i> Copiar
                        </button>
                        <button class="btn btn-primary" id="generateQRBtn">
                            <i>üì±</i> QR Code
                        </button>
                    </div>
                </div>
                
                <!-- Checkpoints List -->
                <div id="checkpointsContainer">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4);">
                        <h3 style="margin: 0; color: var(--text-primary);">
                            üìç Checkpoints do Percurso
                        </h3>
                        <span style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                            Arraste para reordenar
                        </span>
                    </div>
                    <div class="checkpoint-list" id="checkpointsList">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üìç</div>
                    <h3>Nenhum checkpoint configurado</h3>
                    <p>Configure os checkpoints do percurso para calcular splits nas classifica√ß√µes.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('addCheckpointBtn').click()">
                        ‚ûï Adicionar Primeiro Checkpoint
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="app-bottom-nav" id="bottomNav">
            <!-- Ser√° preenchido por navigation.js -->
        </nav>
    </div>
    
    <!-- Scripts -->
    <!-- Scripts de Autentica√ß√£o -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102601" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="/universal-route-protection.js?v=2025102618" defer></script>
    
    <!-- Checkpoint Order Logic -->
    <script>
        let currentEvent = null;
        let checkpointTypes = [];
        let checkpoints = [];
        
        // Aguardar navega√ß√£o estar pronta
        async function waitForNavigation() {
            return new Promise((resolve) => {
                if (window.NavigationUtils) {
                    resolve();
                } else {
                    window.addEventListener('navigationReady', resolve);
                }
            });
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Aguardar Supabase
                if (window.supabaseClient?.init) {
                    await window.supabaseClient.init();
                    await window.supabaseClient.ready();
                    console.log('‚úÖ Supabase inicializado');
                }
                
                // Verificar autentica√ß√£o
                const autenticado = await verificarAutenticacao(['admin', 'moderator', 'event_manager']);
                if (!autenticado) return;
                
                console.log('üöÄ Inicializando p√°gina checkpoint-order...');
                
                // Aguardar navega√ß√£o estar pronta
                await waitForNavigation();
                console.log('‚úÖ Navega√ß√£o pronta');
                
                // Get event from URL
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('event');
                const eventName = urlParams.get('eventName');
                
                if (!eventId) {
                    showError('Nenhum evento selecionado');
                    setTimeout(() => window.location.href = '/events', 2000);
                    return;
                }
                
                currentEvent = { id: eventId, name: eventName };
                
                // Atualizar contexto de evento
                if (window.navigationService) {
                    window.navigationService.setEventContext(eventId, eventName);
                }
                
                // Update UI
                updateEventInfo(eventName);
                updateQuickLink(eventId, eventName);
                
                // Debug: Verificar conex√£o
                console.log('üîç Verificando Supabase...');
                console.log('  - window.supabaseClient:', !!window.supabaseClient);
                console.log('  - supabase:', !!window.supabaseClient?.supabase);
                console.log('  - isConnected:', window.supabaseClient?.isConnected);
                
                // Load data
                await loadCheckpointTypes();
                
                // Aguardar um pouco para Supabase estar totalmente pronto
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await loadCheckpoints();
                
                // Setup event listeners
                setupEventListeners();
                
                // Update connection indicator
                updateConnectionStatus();
                
                console.log('‚úÖ P√°gina inicializada');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
            }
        });
        
        function setupEventListeners() {
            document.getElementById('addCheckpointBtn').addEventListener('click', showAddCheckpointModal);
            document.getElementById('saveOrderBtn').addEventListener('click', saveCheckpointOrder);
            document.getElementById('copyLinkBtn').addEventListener('click', copyQuickLink);
            document.getElementById('generateQRBtn').addEventListener('click', generateQRCode);
            
            // Menu toggle mobile
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('sidebar-open');
                });
            }
        }
        
        function updateEventInfo(eventName) {
            document.getElementById('pageTitle').textContent = `üìç Checkpoints - ${eventName || 'Evento'}`;
            
            const eventInfoPanel = document.getElementById('eventInfoPanel');
            const currentEventInfo = document.getElementById('currentEventInfo');
            
            if (eventInfoPanel && eventName) {
                eventInfoPanel.style.display = 'block';
                currentEventInfo.innerHTML = `
                    <strong>${eventName}</strong><br>
                    Configura√ß√£o de Checkpoints
                `;
            }
        }
        
        function updateQuickLink(eventId, eventName) {
            const url = `${window.location.origin}/detection?event=${eventId}${eventName ? '&eventName=' + encodeURIComponent(eventName) : ''}`;
            document.getElementById('quickLinkInput').value = url;
        }
        
        async function loadCheckpointTypes() {
            try {
                const { data, error } = await window.supabaseClient.supabase
                    .from('checkpoint_types')
                    .select('*')
                    .eq('is_active', true)
                    .order('sort_order');
                
                if (error) throw error;
                
                checkpointTypes = data || [];
                console.log('‚úÖ Tipos carregados:', checkpointTypes.length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar tipos:', error);
                checkpointTypes = [
                    { code: 'start', name: 'In√≠cio', icon: 'üèÅ', color: '#10b981', requires_split: false },
                    { code: 'intermediate', name: 'Interm√©dio', icon: 'üìç', color: '#fc6b03', requires_split: true },
                    { code: 'finish', name: 'Meta', icon: 'üèÅ', color: '#ef4444', requires_split: true }
                ];
            }
        }
        
        async function loadCheckpoints() {
            try {
                console.log('üìç loadCheckpoints: Iniciando...');
                console.log('üìç Event ID:', currentEvent.id);
                console.log('üìç Supabase:', !!window.supabaseClient?.supabase);
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.error('‚ùå Supabase n√£o dispon√≠vel');
                    showError('Supabase n√£o conectado');
                    return;
                }
                
                console.log('üìç Fazendo query em event_devices...');
                
                const { data, error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select(`
                        *,
                        checkpoint_types (
                            code,
                            name,
                            icon,
                            color,
                            is_start,
                            is_finish,
                            requires_split
                        )
                    `)
                    .eq('event_id', currentEvent.id)
                    .order('checkpoint_order', { ascending: true });
                
                console.log('üìä Resultado:');
                console.log('  - Error:', error);
                console.log('  - Data:', data);
                console.log('  - Quantidade:', data?.length || 0);
                
                if (error) {
                    console.error('‚ùå Erro na query:', error);
                    // Tentar sem JOIN se falhar
                    console.log('üîÑ Tentando query simplificada...');
                    const { data: simpleData, error: simpleError } = await window.supabaseClient.supabase
                        .from('event_devices')
                        .select('*')
                        .eq('event_id', currentEvent.id)
                        .order('checkpoint_order', { ascending: true });
                    
                    if (simpleError) {
                        throw simpleError;
                    }
                    
                    console.log('‚úÖ Query simplificada funcionou:', simpleData);
                    checkpoints = simpleData || [];
                } else {
                    checkpoints = data || [];
                }
                
                console.log('‚úÖ Total checkpoints carregados:', checkpoints.length);
                
                // Calcular quantos dispositivos t√™m checkpoint configurado
                const configuredCount = checkpoints.filter(c => c.checkpoint_name || c.checkpoint_type).length;
                const totalDevices = data?.length || 0;
                
                console.log(`üìä Dispositivos: ${totalDevices} total, ${configuredCount} configurados`);
                
                // Atualizar bot√£o de adicionar
                updateAddCheckpointButton(totalDevices, configuredCount);
                
                renderCheckpoints();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar checkpoints:', error);
                showError(`Erro ao carregar: ${error.message}`);
            }
        }
        
        function updateAddCheckpointButton(totalDevices, configuredCount) {
            const addBtn = document.getElementById('addCheckpointBtn');
            if (!addBtn) return;
            
            if (totalDevices === 0) {
                addBtn.disabled = true;
                addBtn.innerHTML = '<i>‚ûï</i> Sem Dispositivos';
                addBtn.title = 'Adicione dispositivos primeiro em /devices';
            } else if (configuredCount >= totalDevices) {
                addBtn.disabled = true;
                addBtn.innerHTML = '<i>‚úì</i> Todos Configurados';
                addBtn.title = 'Todos os dispositivos j√° t√™m checkpoints configurados';
            } else {
                addBtn.disabled = false;
                addBtn.innerHTML = `<i>‚ûï</i> Adicionar Checkpoint (${totalDevices - configuredCount} dispon√≠vel)`;
                addBtn.title = `${totalDevices - configuredCount} dispositivo(s) ainda sem checkpoint`;
            }
        }
        
        function renderCheckpoints() {
            const list = document.getElementById('checkpointsList');
            const container = document.getElementById('checkpointsContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (checkpoints.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            list.innerHTML = checkpoints.map((checkpoint, index) => {
                const typeInfo = checkpoint.checkpoint_types || {};
                const typeIcon = typeInfo.icon || 'üìç';
                const typeName = typeInfo.name || 'Interm√©dio';
                const typeColor = typeInfo.color || '#fc6b03';
                const checkpointName = checkpoint.checkpoint_name || `Checkpoint ${checkpoint.checkpoint_order}`;
                
                return `
                <div class="checkpoint-item" draggable="true" data-checkpoint-id="${checkpoint.id}" data-order="${checkpoint.checkpoint_order}">
                    <div class="checkpoint-order-badge" style="background: ${typeColor}; color: white;">
                        ${checkpoint.checkpoint_order}
                    </div>
                    <div class="checkpoint-icon">${typeIcon}</div>
                    <div class="checkpoint-info">
                        <div class="checkpoint-name">${checkpointName}</div>
                        <div class="checkpoint-details">
                            Tipo: ${typeName} ‚Ä¢ 
                            Role: ${checkpoint.role} ‚Ä¢
                            Splits: ${typeInfo.requires_split ? '‚úì Sim' : '‚úó N√£o'} ‚Ä¢
                            Device: ${checkpoint.device_id.substring(0, 12)}...
                        </div>
                    </div>
                    <div class="checkpoint-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editCheckpoint('${checkpoint.id}')">
                            <i>‚úèÔ∏è</i> Editar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeCheckpoint('${checkpoint.id}')">
                            <i>üóëÔ∏è</i> Remover
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            // Setup drag and drop
            setupDragAndDrop();
        }
        
        function setupDragAndDrop() {
            const items = document.querySelectorAll('.checkpoint-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }
        
        let draggedElement = null;
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const list = document.getElementById('checkpointsList');
                const allItems = [...list.querySelectorAll('.checkpoint-item')];
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
                
                updateOrderBadges();
            }
            
            return false;
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }
        
        function updateOrderBadges() {
            const items = document.querySelectorAll('.checkpoint-item');
            items.forEach((item, index) => {
                const badge = item.querySelector('.checkpoint-order-badge');
                badge.textContent = index + 1;
                item.dataset.order = index + 1;
            });
        }
        
        async function showAddCheckpointModal() {
            console.log('üì± Carregando dispositivos do evento:', currentEvent.id);
            
            try {
                // Carregar TODOS os dispositivos do evento
                const { data: allDevices, error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('*')
                    .eq('event_id', currentEvent.id);
                
                console.log('üìä Dispositivos encontrados:', allDevices?.length || 0, allDevices);
                
                if (error) {
                    console.error('‚ùå Erro ao carregar dispositivos:', error);
                    showError(`Erro ao carregar dispositivos: ${error.message}`);
                    return;
                }
                
                // Verificar se existem dispositivos
                if (!allDevices || allDevices.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum dispositivo em event_devices');
                    if (confirm('Nenhum dispositivo associado ao evento. Deseja ir para a p√°gina de Dispositivos para adicionar?')) {
                        window.location.href = `/devices?event=${currentEvent.id}&eventName=${encodeURIComponent(currentEvent.name)}`;
                    }
                    return;
                }
                
                // Filtrar apenas dispositivos SEM checkpoint configurado
                const availableDevices = allDevices.filter(d => !d.checkpoint_name && !d.checkpoint_type);
                
                console.log(`üìä Total: ${allDevices.length}, Dispon√≠veis: ${availableDevices.length}, J√° configurados: ${allDevices.length - availableDevices.length}`);
                
                if (availableDevices.length === 0) {
                    showError('Todos os dispositivos j√° t√™m checkpoints configurados. Edite os existentes ou adicione mais dispositivos.');
                    return;
                }
                
                console.log('‚úÖ Mostrando modal com', availableDevices.length, 'dispositivos dispon√≠veis');
                
                // Preparar options (DENTRO do try para ter acesso a availableDevices)
                const typesOptions = checkpointTypes.map(t => 
                    `<option value="${t.code}">${t.icon} ${t.name} ${t.requires_split ? '(Split)' : ''}</option>`
                ).join('');
                
                const devicesOptions = availableDevices.map((d, index) => 
                    `<option value="${d.device_id}">
                        ${d.checkpoint_name || `Dispositivo ${index + 1}`} 
                        (ID: ${d.device_id.substring(0, 8)}...)
                    </option>`
                ).join('');
                
                const nextOrder = checkpoints.length + 1;
                
                // Criar modal HTML
                const modalHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="addCheckpointModal">
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-6); max-width: 500px; width: 90%;">
                            <h3 style="margin: 0 0 var(--spacing-4) 0; color: var(--text-primary);">‚ûï Adicionar Checkpoint</h3>
                            
                            <div style="margin-bottom: var(--spacing-4);">
                                <label style="display: block; font-size: var(--font-size-sm); color: var(--text-primary); margin-bottom: var(--spacing-2);">Nome do Checkpoint:</label>
                                <input type="text" id="checkpointNameInput" placeholder="Ex: Km 5, Subida, Descida..." style="width: 100%; padding: var(--spacing-3); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-base); color: var(--text-primary);">
                            </div>
                            
                            <div style="margin-bottom: var(--spacing-4);">
                                <label style="display: block; font-size: var(--font-size-sm); color: var(--text-primary); margin-bottom: var(--spacing-2);">Tipo de Checkpoint:</label>
                                <select id="checkpointTypeInput" style="width: 100%; padding: var(--spacing-3); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-base); color: var(--text-primary);">
                                    ${typesOptions}
                                </select>
                            </div>
                            
                            <div style="margin-bottom: var(--spacing-4);">
                                <label style="display: block; font-size: var(--font-size-sm); color: var(--text-primary); margin-bottom: var(--spacing-2);">Ordem no Percurso:</label>
                                <input type="number" id="checkpointOrderInput" value="${nextOrder}" min="1" style="width: 100%; padding: var(--spacing-3); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-base); color: var(--text-primary);">
                                <small style="color: var(--text-secondary); font-size: var(--font-size-xs);">Sugest√£o: ${nextOrder}</small>
                            </div>
                            
                            <div style="margin-bottom: var(--spacing-5);">
                                <label style="display: block; font-size: var(--font-size-sm); color: var(--text-primary); margin-bottom: var(--spacing-2);">Dispositivo: *</label>
                                <select id="deviceIdInput" required style="width: 100%; padding: var(--spacing-3); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-base); color: var(--text-primary);">
                                    ${devicesOptions}
                                </select>
                                <small style="color: var(--text-secondary); font-size: var(--font-size-xs);">
                                    <a href="/devices?event=${currentEvent.id}&eventName=${encodeURIComponent(currentEvent.name)}" style="color: var(--primary);">
                                        ‚ûï Adicionar novo dispositivo
                                    </a>
                                </small>
                            </div>
                            
                            <div style="display: flex; gap: var(--spacing-3);">
                                <button class="btn btn-secondary" style="flex: 1;" onclick="closeAddCheckpointModal()">Cancelar</button>
                                <button class="btn btn-primary" style="flex: 1;" onclick="confirmAddCheckpoint()">Adicionar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                console.error('‚ùå Erro ao criar modal:', error);
                showError('Erro ao preparar modal');
            }
        }
        
        function closeAddCheckpointModal() {
            const modal = document.getElementById('addCheckpointModal');
            if (modal) modal.remove();
        }
        
        function confirmAddCheckpoint() {
            const checkpointName = document.getElementById('checkpointNameInput').value.trim();
            const checkpointType = document.getElementById('checkpointTypeInput').value;
            const checkpointOrder = parseInt(document.getElementById('checkpointOrderInput').value);
            const deviceId = document.getElementById('deviceIdInput').value;
            
            if (!checkpointName) {
                alert('Por favor, digite um nome para o checkpoint');
                return;
            }
            
            if (!deviceId) {
                alert('Por favor, selecione um dispositivo');
                return;
            }
            
            closeAddCheckpointModal();
            addCheckpoint(deviceId, checkpointOrder, checkpointType, checkpointName);
        }
        
        async function addCheckpoint(deviceId, checkpointOrder, checkpointType, checkpointName) {
            try {
                // Verificar se j√° existe configura√ß√£o para este dispositivo
                const { data: existing } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId)
                    .single();
                
                if (existing) {
                    // Atualizar configura√ß√£o do checkpoint no dispositivo existente
                    const { error } = await window.supabaseClient.supabase
                        .from('event_devices')
                        .update({
                            checkpoint_order: checkpointOrder,
                            checkpoint_type: checkpointType,
                            checkpoint_name: checkpointName
                        })
                        .eq('event_id', currentEvent.id)
                        .eq('device_id', deviceId);
                    
                    if (error) throw error;
                } else {
                    // Criar nova associa√ß√£o (caso o device_id seja novo)
                    showError('Dispositivo n√£o encontrado. Adicione primeiro em Dispositivos.');
                    return;
                }
                
                showSuccess('Checkpoint configurado!');
                await loadCheckpoints();
                
            } catch (error) {
                console.error('‚ùå Erro ao adicionar checkpoint:', error);
                showError('Erro ao adicionar. Execute create-checkpoint-types.sql');
            }
        }
        
        async function editCheckpoint(checkpointId) {
            const checkpoint = checkpoints.find(c => c.id === checkpointId);
            if (!checkpoint) return;
            
            const typesOptions = checkpointTypes.map(t => 
                `<option value="${t.code}" ${checkpoint.checkpoint_type === t.code ? 'selected' : ''}>${t.icon} ${t.name}</option>`
            ).join('');
            
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="editCheckpointModal">
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-6); max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 var(--spacing-4) 0; color: var(--text-primary);">‚úèÔ∏è Editar Checkpoint</h3>
                        
                        <div style="margin-bottom: var(--spacing-4);">
                            <label style="display: block; font-size: var(--font-size-sm); color: var(--text-primary); margin-bottom: var(--spacing-2);">Nome:</label>
                            <input type="text" id="editNameInput" value="${checkpoint.checkpoint_name || ''}" style="width: 100%; padding: var(--spacing-3); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-base); color: var(--text-primary);">
                        </div>
                        
                        <div style="margin-bottom: var(--spacing-5);">
                            <label style="display: block; font-size: var(--font-size-sm); color: var(--text-primary); margin-bottom: var(--spacing-2);">Tipo:</label>
                            <select id="editTypeInput" style="width: 100%; padding: var(--spacing-3); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-base); color: var(--text-primary);">
                                ${typesOptions}
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: var(--spacing-3);">
                            <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditCheckpointModal()">Cancelar</button>
                            <button class="btn btn-primary" style="flex: 1;" onclick="confirmEditCheckpoint('${checkpointId}')">Salvar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeEditCheckpointModal() {
            const modal = document.getElementById('editCheckpointModal');
            if (modal) modal.remove();
        }
        
        async function confirmEditCheckpoint(checkpointId) {
            const name = document.getElementById('editNameInput').value.trim();
            const type = document.getElementById('editTypeInput').value;
            
            closeEditCheckpointModal();
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .update({
                        checkpoint_name: name,
                        checkpoint_type: type
                    })
                    .eq('id', checkpointId);
                
                if (error) throw error;
                
                showSuccess('Checkpoint atualizado!');
                await loadCheckpoints();
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar:', error);
                showError('Erro ao atualizar checkpoint');
            }
        }
        
        async function removeCheckpoint(checkpointId) {
            if (!confirm('Tem certeza que deseja remover este checkpoint?')) return;
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .delete()
                    .eq('id', checkpointId);
                
                if (error) throw error;
                
                showSuccess('Checkpoint removido!');
                await loadCheckpoints();
                
            } catch (error) {
                console.error('‚ùå Erro ao remover:', error);
                showError('Erro ao remover checkpoint');
            }
        }
        
        async function saveCheckpointOrder() {
            const items = document.querySelectorAll('.checkpoint-item');
            const updates = [];
            
            items.forEach((item, index) => {
                updates.push({
                    id: item.dataset.checkpointId,
                    newOrder: index + 1
                });
            });
            
            try {
                for (const update of updates) {
                    const { error } = await window.supabaseClient.supabase
                        .from('event_devices')
                        .update({ checkpoint_order: update.newOrder })
                        .eq('id', update.id);
                    
                    if (error) throw error;
                }
                
                showSuccess('Ordem salva com sucesso!');
                await loadCheckpoints();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar ordem:', error);
                showError('Erro ao salvar ordem');
            }
        }
        
        function copyQuickLink() {
            const input = document.getElementById('quickLinkInput');
            input.select();
            document.execCommand('copy');
            showSuccess('Link copiado!');
        }
        
        function generateQRCode() {
            showSuccess('Funcionalidade QR Code em desenvolvimento');
        }
        
        function showError(message) {
            alert(`‚ùå ${message}`);
        }
        
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) return;
            
            const isConnected = window.supabaseClient && window.supabaseClient.supabase && window.supabaseClient.isConnected;
            
            if (isConnected) {
                statusDiv.innerHTML = `
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></div>
                    <span style="color: var(--success);">Conectado</span>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--danger);"></div>
                    <span style="color: var(--danger);">Desconectado</span>
                `;
            }
            
            setTimeout(updateConnectionStatus, 5000);
        }
        
        function showError(message) {
            alert(`‚ùå ${message}`);
        }
        
        function showSuccess(message) {
            alert(`‚úÖ ${message}`);
        }
    </script>
</body>
</html>

