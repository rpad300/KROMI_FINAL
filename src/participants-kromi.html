<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Kromi.online - Gest√£o de Participantes</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    <link rel="stylesheet" href="/logo-integration.css?v=2025012701">
    
    <style>
        /* Layout with Sidebar Structure */
        .layout-with-sidebar {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
        }
        
        /* Sidebar styles */
        .layout-with-sidebar .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1050;
            overflow-y: auto;
            transition: transform var(--transition-slow);
        }
        
        /* Header styles */
        .layout-with-sidebar .header {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 1040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-5);
            transition: left var(--transition-slow);
        }
        
        /* Main content area */
        .layout-with-sidebar .main {
            margin-left: 280px;
            margin-top: 60px;
            width: calc(100% - 280px);
            min-height: calc(100vh - 60px);
            transition: margin-left var(--transition-slow), width var(--transition-slow);
        }
        
        /* Mobile adjustments */
        @media (max-width: 1024px) {
            body {
                overflow-x: hidden;
            }
            
            .layout-with-sidebar .sidebar {
                transform: translateX(-100%);
            }
            
            .layout-with-sidebar .sidebar.sidebar-open {
                transform: translateX(0);
            }
            
            .layout-with-sidebar .header {
                left: 0;
            }
            
            .layout-with-sidebar .main {
                margin-left: 0 !important;
                margin-top: 60px !important;
                width: 100% !important;
                min-height: calc(100vh - 60px) !important;
                padding-bottom: 80px !important;
            }
            
            /* Ensure content fills the screen */
            #mainContent {
                min-height: calc(100vh - 60px - 80px);
                padding: var(--spacing-4);
            }
            
            #menuToggle {
                display: block !important;
            }
            
            .app-bottom-nav {
                display: flex !important;
            }
        }
        
        /* Participants specific styles */
        .participants-grid {
            display: grid;
            gap: var(--spacing-5);
            margin-bottom: var(--spacing-6);
        }
        
        .event-selector-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
        }
        
        .event-config-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
        }
        
        .participants-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .table-header {
            background: var(--bg-primary);
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-3);
        }
        
        .table-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .table-actions {
            display: flex;
            gap: var(--spacing-2);
            flex-wrap: wrap;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 600;
            padding: var(--spacing-3) var(--spacing-4);
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            font-size: var(--font-size-sm);
            white-space: nowrap;
        }
        
        .data-table td {
            padding: var(--spacing-3) var(--spacing-4);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }
        
        .data-table tr:hover {
            background: rgba(252, 107, 3, 0.05);
        }
        
        .participant-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-4);
        }
        
        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            padding: var(--spacing-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-base);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            font-family: var(--font-family-base);
            transition: all var(--transition-base);
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(252, 107, 3, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            text-align: center;
            transition: transform var(--transition-base), box-shadow var(--transition-base);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--spacing-1);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-12);
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: var(--spacing-4);
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-2);
            color: var(--text-primary);
        }
        
        .empty-state p {
            font-size: var(--font-size-base);
            line-height: 1.6;
            max-width: 400px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .table-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .table-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .data-table {
                font-size: var(--font-size-xs);
            }
            
            .data-table th,
            .data-table td {
                padding: var(--spacing-2);
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- App Container -->
    <div class="layout-with-sidebar">
        <!-- Sidebar -->
        <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
        <div class="sidebar" id="sidebar"></div>
        
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="header-title">üë• Gest√£o de Participantes</h1>
            </div>
            <div class="header-right">
                <button class="btn btn-sm btn-primary" id="addParticipant">
                    <i>‚ûï</i> Adicionar
                </button>
                <button class="btn btn-sm btn-secondary" id="downloadExampleFile">
                    <i>üì•</i> Download Exemplo
                </button>
                <button class="btn btn-sm btn-secondary" id="importParticipants">
                    <i>üìä</i> Importar Excel/CSV
                </button>
                <button class="btn btn-sm btn-secondary" id="exportParticipants">
                    <i>üì§</i> Exportar
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main">
            <div style="flex: 1; overflow-y: auto; padding: var(--spacing-5);" id="mainContent">
                
                <!-- Event Selector -->
                <div class="participants-grid event-selector-container">
                    <div class="event-selector-card">
                        <h3 style="margin: 0 0 var(--spacing-4) 0; font-size: var(--font-size-lg); font-weight: 600; color: var(--text-primary);">
                            üìã Selecionar Evento
                        </h3>
                        <div class="form-group">
                            <label class="form-label" for="eventSelect">Evento:</label>
                            <select id="eventSelect" class="form-select">
                                <option value="">-- Selecionar Evento --</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Import Instructions -->
                <div class="participants-grid event-selector-container" id="importInstructions" style="display: none;">
                    <div class="event-selector-card" style="background: linear-gradient(135deg, var(--info), #3b82f6); color: white;">
                        <h3 style="margin: 0 0 var(--spacing-3) 0; font-size: var(--font-size-lg); font-weight: 600;">
                            üìã Formato de Importa√ß√£o
                        </h3>
                        <div style="font-size: var(--font-size-sm); line-height: 1.6; opacity: 0.95;">
                            <p style="margin: 0 0 var(--spacing-2) 0;">
                                <strong>Formatos suportados:</strong> Excel (.xlsx) ou CSV (.csv)
                            </p>
                            <p style="margin: 0 0 var(--spacing-2) 0;">
                                <strong>Colunas obrigat√≥rias:</strong> Dorsal, Nome
                            </p>
                            <p style="margin: 0 0 var(--spacing-2) 0;">
                                <strong>Colunas opcionais:</strong> Email, Telefone, Data Nascimento, G√©nero (M/F), Equipa, Categoria, Data Pagamento, Estado Inscri√ß√£o (pending/paid), Pagamento (valor)
                            </p>
                            <p style="margin: 0 0 var(--spacing-2) 0; font-size: 11px; opacity: 0.9;">
                                <em>Nota: C√≥digo e Idade s√£o gerados automaticamente. Data Inscri√ß√£o √© criada no momento da importa√ß√£o.</em>
                            </p>
                            <p style="margin: 0;">
                                <strong>Primeira linha:</strong> Deve conter os cabe√ßalhos (Dorsal, Nome, etc.)
                            </p>
                        </div>
                        <div style="margin-top: var(--spacing-3);">
                            <button class="btn btn-sm" style="background: white; color: var(--info); border: none;" id="downloadExampleFileCard">
                                <i>üì•</i> Baixar Ficheiro de Exemplo (Excel)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div class="stats-grid event-info-container" id="statsGrid" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalParticipants">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maleParticipants">0</div>
                        <div class="stat-label">Masculino</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="femaleParticipants">0</div>
                        <div class="stat-label">Feminino</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="confirmedParticipants">0</div>
                        <div class="stat-label">Confirmados</div>
                    </div>
                </div>
                
                <!-- Registration Chart -->
                <div class="event-info-container" id="chartContainer" style="display: none; margin-bottom: var(--spacing-6);">
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-5);">
                        <h3 style="margin: 0 0 var(--spacing-4) 0; font-size: var(--font-size-lg); font-weight: 600;">
                            üìà Evolu√ß√£o de Inscri√ß√µes
                        </h3>
                        <canvas id="registrationChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                
                <!-- Participants Table -->
                <div class="participants-table" id="participantsTable" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">üë• Lista de Participantes</h3>
                        <div class="table-actions">
                            <input 
                                type="text" 
                                id="searchParticipants" 
                                placeholder="üîç Pesquisar por nome, email ou telefone..." 
                                class="form-input"
                                style="min-width: 300px; margin-right: var(--spacing-2);"
                                onkeyup="filterParticipants()"
                            />
                            <button class="btn btn-sm btn-secondary" id="refreshParticipants">
                                <i>üîÑ</i> Atualizar
                            </button>
                            <button class="btn btn-sm btn-danger" id="clearParticipants">
                                <i>üóëÔ∏è</i> Limpar
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Dorsal</th>
                                    <th>C√≥digo</th>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Telefone</th>
                                    <th>Idade</th>
                                    <th>G√©nero</th>
                                    <th>Equipa</th>
                                    <th>Categoria</th>
                                    <th>Data Inscri√ß√£o</th>
                                    <th>Data Pagamento</th>
                                    <th>Estado Inscri√ß√£o</th>
                                    <th>Pagamento</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="participantsBody">
                                <!-- Ser√° preenchido dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Add Participant Form -->
                <div class="participant-form" id="participantForm" style="display: none;">
                    <h3 style="margin: 0 0 var(--spacing-4) 0; font-size: var(--font-size-lg); font-weight: 600; color: var(--text-primary);">
                        ‚ûï Adicionar Participante
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="participantDorsal">Dorsal:</label>
                            <input type="number" id="participantDorsal" class="form-input" placeholder="Ex: 123">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="participantName">Nome Completo:</label>
                            <input type="text" id="participantName" class="form-input" placeholder="Ex: Jo√£o Silva">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="participantEmail">Email: *</label>
                            <input type="email" id="participantEmail" class="form-input" placeholder="Ex: joao@email.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="participantPhone">Telefone: *</label>
                            <input type="tel" id="participantPhone" class="form-input" placeholder="Ex: +351 912 345 678" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="participantTeam">Equipa:</label>
                            <input type="text" id="participantTeam" class="form-input" placeholder="Ex: Clube Atl√©tico">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="participantCategory">Categoria:</label>
                            <input type="text" id="participantCategory" class="form-input" placeholder="Ex: S√©nior M">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="participantBirthDate">Data Nascimento: *</label>
                            <input type="date" id="participantBirthDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="participantGender">G√©nero: *</label>
                            <select id="participantGender" class="form-select" required>
                                <option value="">-- Selecionar --</option>
                                <option value="M">Masculino</option>
                                <option value="F">Feminino</option>
                                <option value="O">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: var(--spacing-4); display: flex; gap: var(--spacing-3);">
                        <button class="btn btn-primary" id="saveParticipant">
                            <i>üíæ</i> Salvar Participante
                        </button>
                        <button class="btn btn-secondary" id="cancelParticipant">
                            <i>‚ùå</i> Cancelar
                        </button>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <div>üë•</div>
                    <h3>Nenhum Evento Selecionado</h3>
                    <p>Selecione um evento para gerir os participantes.</p>
                </div>
                
            </div>
        </main>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="app-bottom-nav">
            <button class="nav-btn" onclick="window.location.href='/'">
                <i>üè†</i>
                <span>Home</span>
            </button>
            <button class="nav-btn" onclick="window.location.href='/events'">
                <i>üèÉ</i>
                <span>Eventos</span>
            </button>
            <button class="nav-btn" onclick="window.location.href='/detection'">
                <i>üì±</i>
                <span>Detec√ß√£o</span>
            </button>
            <button class="nav-btn active">
                <i>üë•</i>
                <span>Participantes</span>
            </button>
        </nav>
    </div>
    
    <!-- Scripts -->
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- SheetJS para ler ficheiros Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Scripts de Autentica√ß√£o -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102601" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <!-- Logo Loader (carregar ANTES da navega√ß√£o, SEM defer para garantir ordem) -->
    <script src="/logo-loader.js?v=2025012702"></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="/universal-route-protection.js?v=2025102618" defer></script>
    
    <!-- Participants Logic -->
    <script>
        // Global variables
        let currentEvent = null;
        
        // Aguardar navega√ß√£o estar pronta
        async function waitForNavigation() {
            return new Promise((resolve) => {
                if (window.NavigationUtils) {
                    resolve();
                } else {
                    window.addEventListener('navigationReady', resolve);
                }
            });
        }
        let participants = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autentica√ß√£o
            const autenticado = await verificarAutenticacao(['admin', 'moderator', 'event_manager', 'participant', 'user']);
            if (!autenticado) return;
            
            // Aguardar navega√ß√£o estar pronta
            await waitForNavigation();
            console.log('‚úÖ Navega√ß√£o pronta');
            
            // Get event from URL
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event');
            const eventName = urlParams.get('eventName');
            
            // Atualizar contexto de evento
            if (eventId && window.navigationService) {
                window.navigationService.setEventContext(eventId, eventName);
            }
            
            if (eventId) {
                // Se temos evento na URL, carregar automaticamente
                await loadEventInfo(eventId);
                
                // Esconder dropdown de sele√ß√£o de evento
                const eventSelectorContainer = document.querySelector('.event-selector-container');
                if (eventSelectorContainer) {
                    eventSelectorContainer.style.display = 'none';
                }
                
                // Mostrar instru√ß√µes de importa√ß√£o
                const importInstructions = document.getElementById('importInstructions');
                if (importInstructions) {
                    importInstructions.style.display = 'block';
                }
                
                // Mostrar info do evento selecionado
                const eventInfoContainer = document.querySelector('.event-info-container');
                if (eventInfoContainer) {
                    eventInfoContainer.style.display = 'block';
                }
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Load events
            await loadEvents();
        });
        
        function setupEventListeners() {
            // Event selector
            document.getElementById('eventSelect').addEventListener('change', (e) => {
                if (e.target.value) {
                    loadEventInfo(e.target.value);
                } else {
                    hideEventInfo();
                }
            });
            
            // Event config (removido - n√£o existe mais)
            
            // Participants
            const addParticipantBtn = document.getElementById('addParticipant');
            const saveParticipantBtn = document.getElementById('saveParticipant');
            const cancelParticipantBtn = document.getElementById('cancelParticipant');
            const refreshParticipantsBtn = document.getElementById('refreshParticipants');
            const clearParticipantsBtn = document.getElementById('clearParticipants');
            
            if (addParticipantBtn) addParticipantBtn.addEventListener('click', showParticipantForm);
            if (saveParticipantBtn) saveParticipantBtn.addEventListener('click', saveParticipant);
            if (cancelParticipantBtn) cancelParticipantBtn.addEventListener('click', hideParticipantForm);
            if (refreshParticipantsBtn) refreshParticipantsBtn.addEventListener('click', refreshParticipants);
            if (clearParticipantsBtn) clearParticipantsBtn.addEventListener('click', clearParticipants);
            
            // Import/Export
            const importParticipantsBtn = document.getElementById('importParticipants');
            const exportParticipantsBtn = document.getElementById('exportParticipants');
            const downloadExampleFileBtn = document.getElementById('downloadExampleFile');
            const downloadExampleFileCardBtn = document.getElementById('downloadExampleFileCard');
            
            if (importParticipantsBtn) importParticipantsBtn.addEventListener('click', importParticipants);
            if (exportParticipantsBtn) exportParticipantsBtn.addEventListener('click', exportParticipants);
            if (downloadExampleFileBtn) downloadExampleFileBtn.addEventListener('click', downloadExampleFile);
            if (downloadExampleFileCardBtn) downloadExampleFileCardBtn.addEventListener('click', downloadExampleFile);
            
            // Menu toggle mobile
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }
        }
        
        async function loadEvents() {
            try {
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.error('Supabase n√£o dispon√≠vel');
                    showError('Supabase n√£o dispon√≠vel');
                    return;
                }
                
                const { data: events, error } = await window.supabaseClient.supabase
                    .from('events')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Erro ao carregar eventos:', error);
                    showError('Erro ao carregar eventos');
                    return;
                }
                
                const selector = document.getElementById('eventSelect');
                selector.innerHTML = '<option value="">-- Selecionar Evento --</option>';
                
                events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.name} (${event.is_active ? 'Ativo' : 'Inativo'})`;
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar eventos:', error);
                showError('Erro ao carregar eventos');
            }
        }
        
        async function loadEventInfo(eventId) {
            try {
                console.log('üîç loadEventInfo chamado com eventId:', eventId);
                
                // Aguardar Supabase estar pronto
                if (window.supabaseClient && window.supabaseClient.init) {
                    console.log('‚è≥ Aguardando Supabase inicializar...');
                    await window.supabaseClient.init();
                    await window.supabaseClient.ready();
                    console.log('‚úÖ Supabase pronto');
                }
                
                // Usar API REST em vez de query direta (para evitar problemas de RLS)
                console.log('üåê Tentando carregar evento via API REST...');
                const apiRes = await fetch(`/api/events/list`, {
                    credentials: 'include'
                });
                
                if (apiRes.ok) {
                    const apiData = await apiRes.json();
                    console.log('üìä API resposta:', apiData);
                    
                    if (apiData.success && apiData.events) {
                        // Procurar o evento espec√≠fico na lista
                        const event = apiData.events.find(e => e.id === eventId);
                        if (event) {
                            console.log('‚úÖ Evento encontrado via API:', event.name);
                            currentEvent = event;
                            
                            // Update UI
                            const eventNameEl = document.getElementById('eventName');
                            const eventDateEl = document.getElementById('eventDate');
                            const eventTimeEl = document.getElementById('eventTime');
                            const eventLocationEl = document.getElementById('eventLocation');
                            
                            if (eventNameEl) eventNameEl.value = event.name;
                            if (eventDateEl) eventDateEl.value = event.event_date ? event.event_date.split('T')[0] : '';
                            if (eventTimeEl) eventTimeEl.value = event.event_date ? event.event_date.split('T')[1]?.substring(0, 5) : '';
                            if (eventLocationEl) eventLocationEl.value = event.location || '';
                            
                            // Show elements that exist
                            const statsGrid = document.getElementById('statsGrid');
                            const participantsTable = document.getElementById('participantsTable');
                            const emptyState = document.getElementById('emptyState');
                            
                            if (statsGrid) statsGrid.style.display = 'grid';
                            if (participantsTable) participantsTable.style.display = 'block';
                            if (emptyState) emptyState.style.display = 'none';
                            
                            // Update sidebar
                            const eventInfoPanel = document.getElementById('eventInfoPanel');
                            const currentEventInfo = document.getElementById('currentEventInfo');
                            
                            if (eventInfoPanel) eventInfoPanel.style.display = 'block';
                            if (currentEventInfo) {
                                currentEventInfo.innerHTML = `
                                    <strong>${event.name}</strong><br>
                                    Data: ${event.event_date ? new Date(event.event_date).toLocaleDateString('pt-PT') : 'N√£o definida'}<br>
                                    Local: ${event.location || 'N√£o definido'}
                                `;
                            }
                            
                            // Load participants
                            await loadParticipants();
                            return;
                        }
                    }
                }
                
                // Fallback: tentar query direta do Supabase
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.error('‚ùå Supabase n√£o dispon√≠vel');
                    return;
                }
                
                console.log('‚ö†Ô∏è API n√£o retornou evento, tentando query direta...');
                const { data: event, error: eventError } = await window.supabaseClient.supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (eventError) {
                    console.error('‚ùå Erro ao carregar evento:', eventError);
                    if (eventError.code === 'PGRST116') {
                        console.error('‚ùå Evento n√£o existe na base de dados');
                        alert('‚ùå Evento n√£o encontrado!\n\nRedirecionando para eventos...');
                        setTimeout(() => {
                            window.location.href = '/events-kromi.html';
                        }, 2000);
                    } else {
                        showError('Erro ao carregar evento: ' + eventError.message);
                    }
                    return;
                }
                
                if (!event) {
                    console.error('‚ùå Evento n√£o retornado da query');
                    alert('‚ùå Evento n√£o encontrado!\n\nRedirecionando para eventos...');
                    setTimeout(() => {
                        window.location.href = '/events-kromi.html';
                    }, 2000);
                    return;
                }
                
                currentEvent = event;
                
                // Update UI (apenas elementos que existem) - Fallback path
                const eventNameEl = document.getElementById('eventName');
                const eventDateEl = document.getElementById('eventDate');
                const eventTimeEl = document.getElementById('eventTime');
                const eventLocationEl = document.getElementById('eventLocation');
                
                if (eventNameEl) eventNameEl.value = event.name;
                if (eventDateEl) eventDateEl.value = event.event_date ? event.event_date.split('T')[0] : '';
                if (eventTimeEl) eventTimeEl.value = event.event_date ? event.event_date.split('T')[1]?.substring(0, 5) : '';
                if (eventLocationEl) eventLocationEl.value = event.location || '';
                
                // Show elements that exist
                const statsGrid = document.getElementById('statsGrid');
                const participantsTable = document.getElementById('participantsTable');
                const emptyState = document.getElementById('emptyState');
                
                if (statsGrid) statsGrid.style.display = 'grid';
                if (participantsTable) participantsTable.style.display = 'block';
                if (emptyState) emptyState.style.display = 'none';
                
                // Update sidebar
                const eventInfoPanel = document.getElementById('eventInfoPanel');
                const currentEventInfo = document.getElementById('currentEventInfo');
                
                if (eventInfoPanel) eventInfoPanel.style.display = 'block';
                if (currentEventInfo) {
                    currentEventInfo.innerHTML = `
                        <strong>${event.name}</strong><br>
                        Data: ${event.event_date ? new Date(event.event_date).toLocaleDateString('pt-PT') : 'N√£o definida'}<br>
                        Local: ${event.location || 'N√£o definido'}
                    `;
                }
                
                // Load participants
                await loadParticipants();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar evento:', error);
                showError('Erro ao carregar evento');
            }
        }
        
        function hideEventInfo() {
            currentEvent = null;
            
            // Hide event info
            document.getElementById('eventConfigCard').style.display = 'none';
            document.getElementById('statsGrid').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('participantsTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            
            // Hide sidebar info
            document.getElementById('eventInfoPanel').style.display = 'none';
        }
        
        async function loadParticipants() {
            try {
                if (!currentEvent || !window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('Sem evento selecionado ou Supabase n√£o dispon√≠vel');
                    return;
                }
                
                const { data: participantsData, error } = await window.supabaseClient.supabase
                    .from('participants')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .order('dorsal_number', { ascending: true });
                
                if (error) {
                    console.error('Erro ao carregar participantes:', error);
                    showError('Erro ao carregar participantes');
                    return;
                }
                
                participants = participantsData || [];
                renderParticipants();
                updateStatistics();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar participantes:', error);
                showError('Erro ao carregar participantes');
            }
        }
        
        function renderParticipants() {
            const tbody = document.getElementById('participantsBody');
            tbody.innerHTML = '';
            
            participants.forEach(participant => {
                const row = document.createElement('tr');
                
                // Calcular idade se birth_date existir
                let age = '--';
                if (participant.birth_date) {
                    const birthDate = new Date(participant.birth_date);
                    const today = new Date();
                    age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                }
                
                // Status badge
                const registrationStatus = participant.registration_status || 'pending';
                const paymentStatus = participant.payment_status || 'pending';
                const isFree = participant.is_free || false;
                
                let statusBadge = '';
                if (registrationStatus === 'paid') {
                    statusBadge = '<span style="display: inline-block; padding: 4px 12px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 12px; font-size: 12px; font-weight: 600;">‚úÖ Pago</span>';
                } else if (isFree) {
                    statusBadge = '<span style="display: inline-block; padding: 4px 12px; background: rgba(59, 130, 246, 0.2); color: #3b82f6; border-radius: 12px; font-size: 12px; font-weight: 600;">üéÅ Gratuito</span>';
                } else {
                    statusBadge = '<span style="display: inline-block; padding: 4px 12px; background: rgba(251, 146, 60, 0.2); color: #fb923c; border-radius: 12px; font-size: 12px; font-weight: 600;">‚è≥ Pendente</span>';
                }
                
                let paymentInfo = '--';
                if (paymentStatus === 'paid' && participant.payment_amount) {
                    paymentInfo = `${participant.payment_amount}‚Ç¨`;
                } else if (isFree) {
                    paymentInfo = 'Gratuito';
                }
                
                // Formatar datas
                const createdAt = participant.created_at 
                    ? new Date(participant.created_at).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                    : '--';
                const paymentDate = participant.payment_date 
                    ? new Date(participant.payment_date).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                    : '--';
                
                row.innerHTML = `
                    <td><strong>${participant.dorsal_number || '--'}</strong></td>
                    <td><code style="background: var(--color-primary-light); padding: 4px 8px; border-radius: 4px; font-weight: 600; color: var(--color-primary);">${participant.participant_code || '--'}</code></td>
                    <td>${participant.full_name || '--'}</td>
                    <td>${participant.email || '--'}</td>
                    <td>${participant.phone || '--'}</td>
                    <td>${age}</td>
                    <td>${participant.gender === 'M' ? 'Masculino' : participant.gender === 'F' ? 'Feminino' : 'Outro'}</td>
                    <td>${participant.team_name || '--'}</td>
                    <td>${participant.category || 'Open'}</td>
                    <td style="font-size: 11px; white-space: nowrap;">${createdAt}</td>
                    <td style="font-size: 11px; white-space: nowrap;">${paymentDate}</td>
                    <td>${statusBadge}</td>
                    <td>${paymentInfo}</td>
                    <td>
                        <div style="display: flex; gap: var(--spacing-1); flex-wrap: wrap;">
                            ${registrationStatus !== 'paid' && !isFree ? `
                                <button class="btn btn-sm btn-success" onclick="markAsPaid('${participant.id}')" title="Marcar como Pago">
                                    üí∞
                                </button>
                                <button class="btn btn-sm btn-info" onclick="markAsFree('${participant.id}')" title="Dar Inscri√ß√£o Gratuita">
                                    üéÅ
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="editParticipant(${participant.dorsal_number})">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteParticipant(${participant.dorsal_number})">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'confirmed': return 'badge-success';
                case 'pending': return 'badge-warning';
                case 'cancelled': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'confirmed': return 'Confirmado';
                case 'pending': return 'Pendente';
                case 'cancelled': return 'Cancelado';
                default: return 'Desconhecido';
            }
        }
        
        function updateStatistics() {
            const total = participants.length;
            const male = participants.filter(p => p.gender === 'M').length;
            const female = participants.filter(p => p.gender === 'F').length;
            const confirmed = participants.filter(p => p.registration_status === 'paid').length;
            
            document.getElementById('totalParticipants').textContent = total;
            document.getElementById('maleParticipants').textContent = male;
            document.getElementById('femaleParticipants').textContent = female;
            document.getElementById('confirmedParticipants').textContent = confirmed;
            
            // Update chart
            updateRegistrationChart();
        }
        
        let registrationChart = null;
        
        function updateRegistrationChart() {
            if (!participants || participants.length === 0) {
                const container = document.getElementById('chartContainer');
                if (container) container.style.display = 'none';
                return;
            }
            
            // Show chart container
            const container = document.getElementById('chartContainer');
            if (container) container.style.display = 'block';
            
            // Group by date
            const registrationsByDate = {};
            participants.forEach(p => {
                if (p.created_at) {
                    const date = new Date(p.created_at).toLocaleDateString('pt-PT');
                    registrationsByDate[date] = (registrationsByDate[date] || 0) + 1;
                }
            });
            
            // Sort dates
            const sortedDates = Object.keys(registrationsByDate).sort((a, b) => {
                const [dayA, monthA, yearA] = a.split('/');
                const [dayB, monthB, yearB] = b.split('/');
                return new Date(yearA, monthA - 1, dayA) - new Date(yearB, monthB - 1, dayB);
            });
            
            // Calculate cumulative
            let cumulative = 0;
            const cumulativeData = sortedDates.map(date => {
                cumulative += registrationsByDate[date];
                return cumulative;
            });
            
            const ctx = document.getElementById('registrationChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (registrationChart) {
                registrationChart.destroy();
            }
            
            // Create new chart
            registrationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Inscri√ß√µes Acumuladas',
                        data: cumulativeData,
                        borderColor: '#fc6b03',
                        backgroundColor: 'rgba(252, 107, 3, 0.1)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Inscri√ß√µes por Dia',
                        data: sortedDates.map(date => registrationsByDate[date]),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: false,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#aaa',
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        function filterParticipants() {
            const searchTerm = document.getElementById('searchParticipants').value.toLowerCase();
            const tbody = document.getElementById('participantsBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const name = row.cells[2]?.textContent.toLowerCase() || '';
                const email = row.cells[3]?.textContent.toLowerCase() || '';
                const phone = row.cells[4]?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }
        
        function saveEventConfig() {
            const config = {
                name: document.getElementById('eventName').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value,
                location: document.getElementById('eventLocation').value
            };
            
            // Validate
            if (!config.name || !config.date || !config.time || !config.location) {
                showError('Preencha todos os campos obrigat√≥rios');
                return;
            }
            
            // Save config (replace with actual Supabase call)
            console.log('üíæ Salvando configura√ß√£o:', config);
            showSuccess('Configura√ß√£o salva com sucesso');
        }
        
        function resetEventConfig() {
            if (confirm('Tem certeza que deseja resetar a configura√ß√£o?')) {
                document.getElementById('eventName').value = '';
                document.getElementById('eventDate').value = '';
                document.getElementById('eventTime').value = '';
                document.getElementById('eventLocation').value = '';
                showSuccess('Configura√ß√£o resetada');
            }
        }
        
        function showParticipantForm() {
            document.getElementById('participantForm').style.display = 'block';
            document.getElementById('addParticipant').style.display = 'none';
        }
        
        function hideParticipantForm() {
            document.getElementById('participantForm').style.display = 'none';
            document.getElementById('addParticipant').style.display = 'inline-flex';
            
            // Clear form
            document.getElementById('participantDorsal').value = '';
            document.getElementById('participantName').value = '';
            document.getElementById('participantEmail').value = '';
            document.getElementById('participantPhone').value = '';
            document.getElementById('participantBirthDate').value = '';
            document.getElementById('participantGender').value = '';
            document.getElementById('participantTeam').value = '';
            document.getElementById('participantCategory').value = '';
        }
        
        async function saveParticipant() {
            const participantData = {
                event_id: currentEvent.id,
                dorsal_number: parseInt(document.getElementById('participantDorsal').value),
                full_name: document.getElementById('participantName').value,
                email: document.getElementById('participantEmail').value,
                phone: document.getElementById('participantPhone').value,
                birth_date: document.getElementById('participantBirthDate').value,
                gender: document.getElementById('participantGender').value,
                team_name: document.getElementById('participantTeam').value || null,
                category: document.getElementById('participantCategory').value || null
            };
            
            // Validate TODOS os campos obrigat√≥rios
            if (!participantData.dorsal_number) {
                showError('Dorsal √© obrigat√≥rio');
                return;
            }
            if (!participantData.full_name) {
                showError('Nome √© obrigat√≥rio');
                return;
            }
            if (!participantData.email) {
                showError('Email √© obrigat√≥rio');
                return;
            }
            if (!participantData.phone) {
                showError('Telefone √© obrigat√≥rio');
                return;
            }
            if (!participantData.birth_date) {
                showError('Data de nascimento √© obrigat√≥ria');
                return;
            }
            if (!participantData.gender) {
                showError('G√©nero √© obrigat√≥rio');
                return;
            }
            
            try {
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    showError('Supabase n√£o dispon√≠vel');
                    return;
                }
                
                const { error } = await window.supabaseClient.supabase
                    .from('participants')
                    .insert([participantData]);
                
                if (error) {
                    if (error.code === '23505') {
                        showError('Dorsal j√° existe');
                    } else {
                        throw error;
                    }
                    return;
                }
                
                showSuccess('Participante adicionado com sucesso!');
                hideParticipantForm();
                await loadParticipants();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar participante:', error);
                showError('Erro ao salvar participante');
            }
        }
        
        async function editParticipant(dorsal) {
            const participant = participants.find(p => (p.dorsal_number || p.dorsal) === dorsal);
            if (!participant) return;
            
            // Use prompt for simplicity (pode melhorar com modal depois)
            const newName = prompt('Nome:', participant.full_name || participant.name);
            if (!newName) return;
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('participants')
                    .update({ full_name: newName })
                    .eq('event_id', currentEvent.id)
                    .eq('dorsal_number', dorsal);
                
                if (error) throw error;
                
                showSuccess('Participante atualizado!');
                await loadParticipants();
                
            } catch (error) {
                console.error('‚ùå Erro ao editar:', error);
                showError('Erro ao editar participante');
            }
        }
        
        async function deleteParticipant(dorsal) {
            if (!confirm(`Tem certeza que deseja remover o participante com dorsal ${dorsal}?`)) {
                return;
            }
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('participants')
                    .delete()
                    .eq('event_id', currentEvent.id)
                    .eq('dorsal_number', dorsal);
                
                if (error) throw error;
                
                showSuccess('Participante removido!');
                await loadParticipants();
                
            } catch (error) {
                console.error('‚ùå Erro ao remover:', error);
                showError('Erro ao remover participante');
            }
        }
        
        async function markAsPaid(participantId) {
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('participants')
                    .update({ 
                        payment_status: 'paid',
                        payment_date: new Date().toISOString()
                    })
                    .eq('id', participantId);
                
                if (error) throw error;
                
                showSuccess('Participante marcado como PAGO! ‚úÖ');
                await loadParticipants();
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar como pago:', error);
                showError('Erro ao marcar como pago');
            }
        }
        
        async function markAsFree(participantId) {
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('participants')
                    .update({ 
                        is_free: true,
                        notes: 'Inscri√ß√£o gratuita atribu√≠da pelo organizador'
                    })
                    .eq('id', participantId);
                
                if (error) throw error;
                
                showSuccess('Participante marcado como GRATUITO! üéÅ');
                await loadParticipants();
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar como gratuito:', error);
                showError('Erro ao marcar como gratuito');
            }
        }
        
        function refreshParticipants() {
            loadParticipants();
            showSuccess('Lista atualizada');
        }
        
        function clearParticipants() {
            if (confirm('Tem certeza que deseja limpar todos os participantes?')) {
                participants = [];
                renderParticipants();
                updateStatistics();
                showSuccess('Lista limpa');
            }
        }
        
        function downloadExampleFile() {
            try {
                // Definir todos os campos poss√≠veis baseados na tabela de participantes
                // Nota: C√≥digo, Idade e Data Inscri√ß√£o s√£o gerados/calculados automaticamente
                const allFields = [
                    'Dorsal',               // obrigat√≥rio
                    'Nome',                 // obrigat√≥rio
                    'Email',
                    'Telefone',
                    'Data Nascimento',      // usado para calcular Idade
                    'G√©nero',              // M ou F
                    'Equipa',
                    'Categoria',
                    'Data Pagamento',       // opcional
                    'Estado Inscri√ß√£o',    // pending, paid, etc.
                    'Pagamento'            // valor em euros (opcional)
                    // Nota: C√≥digo √© gerado automaticamente, Idade √© calculada, Data Inscri√ß√£o √© criada automaticamente
                ];
                
                // Se temos participantes, usar os primeiros como exemplo
                let exampleRows = [];
                
                if (participants && participants.length > 0) {
                    // Usar dados reais dos participantes existentes (m√°ximo 5)
                    exampleRows = participants.slice(0, 5).map(p => [
                        p.dorsal_number || '',
                        p.full_name || '',
                        p.email || '',
                        p.phone || '',
                        p.birth_date ? p.birth_date.split('T')[0] : '',
                        p.gender || 'M',
                        p.team_name || '',
                        p.category || 'Open',
                        p.payment_date ? p.payment_date.split('T')[0] : '',
                        p.registration_status || 'pending',
                        p.payment_amount ? `${p.payment_amount}‚Ç¨` : ''
                    ]);
                    
                    // Se n√£o tivermos 5 participantes, completar com dados de exemplo
                    while (exampleRows.length < 5) {
                        const exampleNum = exampleRows.length + 1;
                        exampleRows.push([
                            exampleNum,
                            `Participante ${exampleNum}`,
                            `participante${exampleNum}@email.com`,
                            `+351 912 345 ${String(exampleNum).padStart(3, '0')}`,
                            `199${exampleNum}-0${exampleNum}-1${exampleNum}`,
                            exampleNum % 2 === 0 ? 'F' : 'M',
                            `Equipa ${String.fromCharCode(64 + exampleNum)}`,
                            'Open',
                            '', // Data Pagamento
                            'pending', // Estado Inscri√ß√£o
                            '' // Pagamento
                        ]);
                    }
                } else {
                    // Criar dados de exemplo padr√£o
                    exampleRows = [
                        [1, 'Jo√£o Silva', 'joao.silva@email.com', '+351 912 345 678', '1990-05-15', 'M', 'Equipa A', 'Open', '2025-01-15', 'paid', '25‚Ç¨'],
                        [2, 'Maria Santos', 'maria.santos@email.com', '+351 912 345 679', '1992-08-20', 'F', 'Equipa B', 'Open', '', 'pending', ''],
                        [3, 'Pedro Costa', 'pedro.costa@email.com', '+351 912 345 680', '1988-03-10', 'M', 'Equipa A', 'Open', '2025-01-20', 'paid', '25‚Ç¨'],
                        [4, 'Ana Oliveira', 'ana.oliveira@email.com', '+351 912 345 681', '1995-11-25', 'F', 'Equipa C', 'Open', '', 'pending', ''],
                        [5, 'Carlos Ferreira', 'carlos.ferreira@email.com', '+351 912 345 682', '1991-07-30', 'M', 'Equipa B', 'Open', '2025-01-18', 'paid', '25‚Ç¨']
                    ];
                }
                
                // Criar array completo com cabe√ßalhos
                const exampleData = [allFields, ...exampleRows];
                
                // Verificar se XLSX est√° dispon√≠vel
                if (typeof XLSX === 'undefined') {
                    // Fallback: criar CSV se XLSX n√£o estiver dispon√≠vel
                    const csvData = exampleData.map(row => 
                        row.map(cell => `"${cell}"`).join(',')
                    ).join('\n');
                    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'exemplo_importacao_participantes.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showSuccess('Ficheiro CSV de exemplo descarregado');
                    return;
                }
                
                // Criar workbook Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exampleData);
                
                // Ajustar largura das colunas baseado nos campos
                ws['!cols'] = [
                    { wch: 10 },  // Dorsal
                    { wch: 25 },  // Nome
                    { wch: 30 },  // Email
                    { wch: 18 },  // Telefone
                    { wch: 18 },  // Data Nascimento
                    { wch: 10 },  // G√©nero
                    { wch: 15 },  // Equipa
                    { wch: 12 },  // Categoria
                    { wch: 18 },  // Data Pagamento
                    { wch: 18 },  // Estado Inscri√ß√£o
                    { wch: 12 }   // Pagamento
                ];
                
                // Estilizar cabe√ßalhos (fazer negrito)
                const headerRange = XLSX.utils.decode_range(ws['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "E8E8E8" } },
                        alignment: { horizontal: "center" }
                    };
                }
                
                // Adicionar worksheet ao workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Participantes');
                
                // Fazer download
                const fileName = participants && participants.length > 0 
                    ? `exemplo_importacao_participantes_baseado_em_dados_existentes.xlsx`
                    : `exemplo_importacao_participantes.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                showSuccess('Ficheiro Excel de exemplo descarregado');
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar ficheiro de exemplo:', error);
                showError('Erro ao gerar ficheiro de exemplo');
            }
        }
        
        async function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Ler primeira sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Converter para JSON (mantendo primeira linha como header)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            header: 1,
                            defval: '' // Valores vazios como string vazia
                        });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('Excel vazio ou inv√°lido (precisa de pelo menos cabe√ßalho + 1 linha)'));
                            return;
                        }
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Erro ao ler ficheiro'));
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function parseCSVFile(file) {
            const text = await file.text();
            const lines = text.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('CSV vazio ou inv√°lido');
            }
            
            // Converter CSV para array de arrays
            const data = lines.map(line => {
                // Parse CSV considerando aspas e v√≠rgulas dentro de campos
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            });
            
            return data;
        }
        
        function importParticipants() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx,.xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!currentEvent || !currentEvent.id) {
                    showError('Por favor, selecione um evento primeiro');
                    return;
                }
                
                try {
                    let rows = [];
                    const fileName = file.name.toLowerCase();
                    
                    // Determinar tipo de ficheiro e fazer parse
                    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        console.log('üìä Lendo ficheiro Excel...');
                        rows = await parseExcelFile(file);
                    } else if (fileName.endsWith('.csv')) {
                        console.log('üìä Lendo ficheiro CSV...');
                        rows = await parseCSVFile(file);
                    } else {
                        showError('Formato n√£o suportado. Use Excel (.xlsx) ou CSV (.csv)');
                        return;
                    }
                    
                    if (rows.length < 2) {
                        showError('Ficheiro vazio ou inv√°lido (precisa de cabe√ßalho + pelo menos 1 linha de dados)');
                        return;
                    }
                    
                    // Primeira linha s√£o os cabe√ßalhos
                    const headers = rows[0].map(h => h.toString().toLowerCase().trim());
                    console.log('üìã Cabe√ßalhos encontrados:', headers);
                    
                    // Encontrar √≠ndices das colunas (case-insensitive)
                    const dorsalIndex = headers.findIndex(h => h.includes('dorsal') || h.includes('n√∫mero') || h.includes('numero'));
                    const nameIndex = headers.findIndex(h => h.includes('nome') || h.includes('name') || h.includes('nome completo'));
                    const emailIndex = headers.findIndex(h => h.includes('email') || h.includes('e-mail'));
                    const phoneIndex = headers.findIndex(h => h.includes('telefone') || h.includes('phone') || h.includes('tel'));
                    const birthDateIndex = headers.findIndex(h => h.includes('data') && (h.includes('nasc') || h.includes('birth')));
                    const genderIndex = headers.findIndex(h => h.includes('g√©nero') || h.includes('genero') || h.includes('gender') || h.includes('sexo'));
                    const teamIndex = headers.findIndex(h => h.includes('equipa') || h.includes('equipe') || h.includes('team'));
                    const categoryIndex = headers.findIndex(h => h.includes('categoria') || h.includes('category'));
                    const paymentDateIndex = headers.findIndex(h => h.includes('pagamento') && h.includes('data') || h.includes('payment') && h.includes('date'));
                    const registrationStatusIndex = headers.findIndex(h => h.includes('estado') && h.includes('inscri') || h.includes('registration') && h.includes('status') || h.includes('status') && h.includes('inscri'));
                    const paymentAmountIndex = headers.findIndex(h => (h.includes('pagamento') && !h.includes('data')) || (h.includes('payment') && !h.includes('date')) || h === 'pagamento' || h === 'payment');
                    
                    if (dorsalIndex === -1 || nameIndex === -1) {
                        showError('Cabe√ßalhos obrigat√≥rios n√£o encontrados. Procure por: Dorsal/N√∫mero e Nome');
                        console.error('Cabe√ßalhos necess√°rios:', {
                            encontrado: {
                                dorsal: dorsalIndex !== -1,
                                name: nameIndex !== -1
                            },
                            headers: headers
                        });
                        return;
                    }
                    
                    // Processar linhas de dados (pular cabe√ßalho)
                    const dataLines = rows.slice(1);
                    const importData = [];
                    const errors = [];
                    
                    for (let i = 0; i < dataLines.length; i++) {
                        const row = dataLines[i];
                        const dorsal = row[dorsalIndex]?.toString().trim();
                        const name = row[nameIndex]?.toString().trim();
                        
                        if (!dorsal || !name || dorsal === '' || name === '') {
                            continue; // Pular linhas vazias
                        }
                        
                        const dorsalNumber = parseInt(dorsal);
                        if (isNaN(dorsalNumber)) {
                            errors.push(`Linha ${i + 2}: Dorsal "${dorsal}" n√£o √© um n√∫mero v√°lido`);
                            continue;
                        }
                        
                        const email = emailIndex !== -1 && row[emailIndex] ? row[emailIndex].toString().trim() : null;
                        const phone = phoneIndex !== -1 && row[phoneIndex] ? row[phoneIndex].toString().trim() : null;
                        const birthDate = birthDateIndex !== -1 && row[birthDateIndex] ? row[birthDateIndex].toString().trim() : null;
                        const gender = genderIndex !== -1 && row[genderIndex] ? row[genderIndex].toString().trim().toUpperCase() : 'M';
                        const team = teamIndex !== -1 && row[teamIndex] ? row[teamIndex].toString().trim() : null;
                        const category = categoryIndex !== -1 && row[categoryIndex] ? row[categoryIndex].toString().trim() : null;
                        
                        // Campos de pagamento
                        let paymentDate = null;
                        if (paymentDateIndex !== -1 && row[paymentDateIndex]) {
                            const pd = row[paymentDateIndex].toString().trim();
                            paymentDate = pd ? pd : null;
                        }
                        
                        let registrationStatus = null;
                        if (registrationStatusIndex !== -1 && row[registrationStatusIndex]) {
                            const rs = row[registrationStatusIndex].toString().trim().toLowerCase();
                            if (rs === 'paid' || rs === 'pago' || rs.includes('pago')) {
                                registrationStatus = 'paid';
                            } else if (rs === 'pending' || rs === 'pendente' || rs.includes('pendente')) {
                                registrationStatus = 'pending';
                            }
                        }
                        
                        let paymentAmount = null;
                        if (paymentAmountIndex !== -1 && row[paymentAmountIndex]) {
                            const pa = row[paymentAmountIndex].toString().trim();
                            // Remover s√≠mbolos de moeda e espa√ßos, converter para n√∫mero
                            const cleanAmount = pa.replace(/[‚Ç¨$,\s]/g, '').replace(',', '.');
                            const amount = parseFloat(cleanAmount);
                            if (!isNaN(amount) && amount > 0) {
                                paymentAmount = amount;
                            }
                        }
                        
                        // Validar e normalizar g√©nero
                        let normalizedGender = 'M';
                        if (gender === 'F' || gender === 'FEMININO' || gender === 'FEMALE' || gender === 'FEM') {
                            normalizedGender = 'F';
                        } else if (gender === 'M' || gender === 'MASCULINO' || gender === 'MALE' || gender === 'MASC') {
                            normalizedGender = 'M';
                        }
                        
                        importData.push({
                            event_id: currentEvent.id,
                            dorsal_number: dorsalNumber,
                            full_name: name,
                            email: email || null,
                            phone: phone || null,
                            birth_date: birthDate || null,
                            gender: normalizedGender,
                            team_name: team || null,
                            category: category || null,
                            payment_date: paymentDate || null,
                            registration_status: registrationStatus || 'pending',
                            payment_amount: paymentAmount || null
                        });
                    }
                    
                    if (importData.length === 0) {
                        showError('Nenhum dado v√°lido encontrado no ficheiro');
                        if (errors.length > 0) {
                            console.error('Erros encontrados:', errors);
                        }
                        return;
                    }
                    
                    // Mostrar erros se houver
                    if (errors.length > 0) {
                        console.warn('‚ö†Ô∏è Erros encontrados durante importa√ß√£o:', errors);
                        showError(`${errors.length} linha(s) ignorada(s). Ver console para detalhes.`);
                    }
                    
                    console.log(`üìä Preparando para importar ${importData.length} participantes...`);
                    console.log('üìã Dados de exemplo:', importData.slice(0, 3));
                    
                    // Import to Supabase
                    const { error } = await window.supabaseClient.supabase
                        .from('participants')
                        .insert(importData);
                    
                    if (error) {
                        console.error('‚ùå Erro ao importar:', error);
                        throw error;
                    }
                    
                    showSuccess(`${importData.length} participante(s) importado(s) com sucesso!`);
                    await loadParticipants();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao importar:', error);
                    showError('Erro ao importar ficheiro: ' + (error.message || error));
                }
            };
            input.click();
        }
        
        function exportParticipants() {
            if (!participants || participants.length === 0) {
                showError('Nenhum participante para exportar');
                return;
            }
            
            // Create CSV data
            const csvData = [
                ['Dorsal', 'Nome', 'Data Nascimento', 'G√©nero', 'Equipa'],
                ...participants.map(p => [
                    p.dorsal_number || p.dorsal,
                    p.full_name || p.name,
                    p.birth_date || '',
                    p.gender || 'M',
                    p.team_name || '',
                    getStatusText(p.status)
                ])
            ].map(row => row.join(',')).join('\n');
            
            // Download CSV
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `participantes_${currentEvent?.name.replace(/\s+/g, '_') || 'evento'}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showSuccess('Dados exportados');
        }
        
        function showSuccess(message) {
            showToast(message, 'success');
        }
        
        function showError(message) {
            showToast(message, 'error');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
    </script>
    
    <style>
        /* Layout adaptations */
        .layout-with-sidebar {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            flex-shrink: 0;
        }
        
        /* Mobile */
        @media (max-width: 1023px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
                z-index: var(--z-modal);
                box-shadow: var(--shadow-2xl);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            #menuToggle {
                display: flex !important;
            }
            
            .main #mainContent {
                padding-bottom: 80px;
            }
        }
    </style>
</body>
</html>
