<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>VisionKrono - Detec√ß√£o de Dorsais</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    <link rel="stylesheet" href="/kromi-mobile.css">
    <link rel="stylesheet" href="/kromi-mobile-ios.css">
    <link rel="stylesheet" href="/kromi-mobile-android.css">
    <link rel="stylesheet" href="/kromi-camera.css">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    
    <!-- Capability Detection -->
    <script src="/kromi-capability-detection.js"></script>
    
    <!-- Additional inline styles kept minimal for runtime overrides -->
</head>
<body data-theme="dark">
    <!-- App Container -->
    <div class="layout-with-sidebar">
        <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
        <div class="sidebar" id="sidebar"></div>
        
        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: var(--spacing-4);">
                <button class="btn btn-icon btn-secondary" id="menuToggle" onclick="toggleSidebar()">
                    <i>‚ò∞</i>
                </button>
                <h2 id="pageTitle" style="font-size: var(--font-size-2xl); font-weight: 600; margin: 0;">
                    üì± Detec√ß√£o de Dorsais
                </h2>
            </div>
            <div style="display: flex; gap: var(--spacing-2);" id="headerActions">
                <button class="btn btn-sm btn-secondary" id="toggleFullscreen">
                    <i>‚õ∂</i> Fullscreen
                </button>
                <button class="btn btn-sm btn-secondary" id="toggleFlash">
                    <i>üí°</i> Flash
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main">
            <div class="camera-container" id="cameraContainer">
                <!-- Back Button (Mobile Only) -->
                <button class="back-button-mobile" id="backButton" title="Voltar ao Evento">
                    ‚Üê
                </button>
                
                <!-- Camera Video -->
                <video id="cameraVideo" class="camera-video" autoplay muted playsinline></video>
                
                <!-- Camera Overlay -->
                <div class="camera-overlay" id="cameraOverlay">
                    <!-- Detection areas will be added here -->
                </div>
                
                <!-- Camera Info -->
                <div class="camera-info">
                    <div class="detection-stats" id="detectionStats">
                        <div style="font-weight: 600; margin-bottom: var(--spacing-1);">üìä Detec√ß√µes</div>
                        <div id="detectionCount">0</div>
                    </div>
                    
                    <div class="event-info" id="eventInfo">
                        <div style="font-weight: 600; margin-bottom: var(--spacing-1);">üèÉ Evento</div>
                        <div id="eventName">Nenhum evento selecionado</div>
                    </div>
                    
                    <!-- Bot√£o Terminar Sess√£o -->
                    <button id="endSessionBtn" onclick="endSession()" 
                        style="position: absolute; top: var(--spacing-4); right: var(--spacing-4); background: rgba(239, 68, 68, 0.9); color: white; border: 2px solid var(--danger); padding: var(--spacing-2) var(--spacing-3); border-radius: var(--radius-full); font-size: var(--font-size-sm); font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); z-index: 25; display: none;">
                        üö™ Terminar Sess√£o
                    </button>
                </div>
                
                <!-- Side Controls (Left Side) -->
                <div class="side-controls">
                    <button class="btn btn-sm btn-warning" id="toggleFlash">
                        <i>‚ö°</i> Flash
                    </button>
                    <button class="btn btn-sm btn-danger" id="switchCamera">
                        <i>üîÑ</i> Trocar
                    </button>
                    <button class="btn btn-sm btn-danger" id="endSessionBtn2" onclick="endSession()" style="display: none;">
                        <i>üö™</i> Terminar
                    </button>
                </div>
                
                <!-- Main Camera Controls (Center Bottom) -->
                <div class="main-camera-controls">
                    <button class="btn btn-lg btn-primary" id="startDetection">
                        <i>‚ñ∂Ô∏è</i> Iniciar Detec√ß√£o
                    </button>
                    <button class="btn btn-lg btn-secondary" id="stopDetection" style="display: none;">
                        <i>‚èπÔ∏è</i> Parar Detec√ß√£o
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="app-bottom-nav">
            <button class="nav-btn" onclick="window.location.href='/'">
                <i>üè†</i>
                <span>Home</span>
            </button>
            <button class="nav-btn" onclick="window.location.href='/events'">
                <i>üèÉ</i>
                <span>Eventos</span>
            </button>
            <button class="nav-btn active">
                <i>üì±</i>
                <span>Detec√ß√£o</span>
            </button>
            <button class="nav-btn" onclick="window.location.href='/classifications'">
                <i>üèÜ</i>
                <span>Rankings</span>
            </button>
        </nav>
    </div>
    
    <!-- Permission Panel -->
    <!-- PIN Panel (aparece primeiro) -->
    <div class="permission-panel" id="pinPanel" style="display: none;">
        <div class="permission-content">
            <h3>üîê PIN de Seguran√ßa</h3>
            <p>Digite o PIN do dispositivo para acessar a detec√ß√£o.</p>
            <div style="margin: var(--spacing-5) 0;">
                <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="6" id="pinInput" 
                    placeholder="Digite o PIN"
                    style="width: 100%; padding: var(--spacing-4); font-size: var(--font-size-2xl); text-align: center; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: var(--radius-lg); color: var(--text-primary); font-weight: 700; letter-spacing: 8px;">
                <div id="pinError" style="color: var(--danger); margin-top: var(--spacing-2); font-size: var(--font-size-sm); text-align: center; display: none;"></div>
            </div>
            <div class="permission-actions">
                <button class="btn btn-primary" id="validatePin">
                    <i>üîì</i> Validar PIN
                </button>
                <button class="btn btn-secondary" onclick="window.history.back()">
                    <i>‚Ü©Ô∏è</i> Voltar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Camera Permission Panel (aparece depois do PIN) -->
    <div class="permission-panel" id="permissionPanel" style="display: none;">
        <div class="permission-content">
            <h3>üì∑ Acesso √† C√¢mera</h3>
            <p>O VisionKrono precisa acessar sua c√¢mera para detectar dorsais automaticamente.</p>
            <div class="permission-actions">
                <button class="btn btn-primary" id="requestCamera">
                    <i>üì∑</i> Permitir C√¢mera
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    <i>‚Ü©Ô∏è</i> Voltar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102601" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- NOTA: Detection N√ÉO tem prote√ß√£o de rotas - acesso via PIN do dispositivo -->
    
    <!-- Detection Logic -->
    <script>
        // Global variables
        let cameraStream = null;
        let isDetecting = false;
        let detectionCount = 0;
        let currentEvent = null;
        let currentDevice = null;
        let sessionId = null;
        let captureInterval = null;
        let currentPosition = null;
        let devicePin = null;
        let pinValidated = false;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase
            if (window.supabaseClient) {
                await window.supabaseClient.init();
            }
            
            // Initialize navigation
            if (window.Navigation) {
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('event');
                let deviceId = urlParams.get('device');
                const eventName = urlParams.get('eventName');
                
                console.log('üîó Par√¢metros URL:');
                console.log('  Event:', eventId);
                console.log('  Device:', deviceId);
                console.log('  EventName:', eventName);
                
                // Se n√£o tem deviceId, buscar primeiro dispositivo do evento
                if (eventId && !deviceId) {
                    console.log('‚ö†Ô∏è Device ID n√£o especificado, buscando dispositivos do evento...');
                    
                    const { data: devices, error } = await window.supabaseClient.supabase
                        .from('event_devices')
                        .select('device_id, checkpoint_name')
                        .eq('event_id', eventId)
                        .order('checkpoint_order', { ascending: true })
                        .limit(1);
                    
                    if (devices && devices.length > 0) {
                        deviceId = devices[0].device_id;
                        console.log('‚úÖ Usando primeiro dispositivo:', deviceId, devices[0].checkpoint_name);
                        
                        // Atualizar URL
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('device', deviceId);
                        window.history.replaceState({}, '', newUrl);
                    } else {
                        console.error('‚ùå Nenhum dispositivo encontrado para este evento');
                        showError('Nenhum dispositivo configurado para este evento. Configure em /devices');
                        setTimeout(() => window.location.href = `/devices?event=${eventId}&eventName=${eventName}`, 3000);
                        return;
                    }
                }
                
                currentEvent = { id: eventId, name: eventName };
                currentDevice = deviceId;
                sessionId = `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                console.log('üîó Par√¢metros finais:');
                console.log('  Event:', eventId);
                console.log('  Device:', deviceId);
                console.log('  Session:', sessionId);
                
                // Atualizar contexto de evento
                if (window.navigationService) {
                    window.navigationService.setEventContext(eventId, eventName);
                }
                
                if (eventId) {
                    loadEventInfo(eventId, eventName);
                }
                
                // Register device
                if (eventId && deviceId) {
                    await registerDevice(eventId, deviceId);
                }
            }
            
            // Get current location
            await getCurrentLocation();
            
            // Setup event listeners
            setupEventListeners();
            
            // Request PIN sempre (se tem device)
            console.log('üîê Verificando se deve pedir PIN...');
            console.log('  currentDevice:', currentDevice);
            
            if (currentDevice) {
                console.log('‚úÖ Device especificado, pedindo PIN...');
                await requestDevicePin();
            } else {
                console.error('‚ùå Device n√£o especificado');
                showError('Dispositivo n√£o especificado');
                setTimeout(() => window.location.href = '/events', 3000);
            }
            
            console.log('‚úÖ Inicializa√ß√£o completa');
        });
        
        function setupEventListeners() {
            // PIN validation
            document.getElementById('validatePin')?.addEventListener('click', validatePin);
            document.getElementById('pinInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    validatePin();
                }
            });
            
            // Camera permission
            document.getElementById('requestCamera').addEventListener('click', startCamera);
            
            // Detection controls - COM VERIFICA√á√ïES DE SEGURAN√áA E DELAY
            setTimeout(() => {
                const startDetectionBtn = document.getElementById('startDetection');
                const stopDetectionBtn = document.getElementById('stopDetection');
                const switchCameraBtn = document.getElementById('switchCamera');
                const toggleFlashBtn = document.getElementById('toggleFlash');
                const endSessionBtn2 = document.getElementById('endSessionBtn2');
                
                console.log('üîç Procurando bot√µes...');
                console.log('startDetectionBtn:', startDetectionBtn);
                console.log('stopDetectionBtn:', stopDetectionBtn);
                console.log('switchCameraBtn:', switchCameraBtn);
                console.log('toggleFlashBtn:', toggleFlashBtn);
                console.log('endSessionBtn2:', endSessionBtn2);
                
                if (startDetectionBtn) {
                    startDetectionBtn.addEventListener('click', startDetection);
                    console.log('‚úÖ Event listener adicionado: startDetection');
                } else {
                    console.error('‚ùå Bot√£o startDetection n√£o encontrado');
                }
                
                if (stopDetectionBtn) {
                    stopDetectionBtn.addEventListener('click', stopDetection);
                    console.log('‚úÖ Event listener adicionado: stopDetection');
                } else {
                    console.error('‚ùå Bot√£o stopDetection n√£o encontrado');
                }
                
                if (switchCameraBtn) {
                    switchCameraBtn.addEventListener('click', switchCamera);
                    console.log('‚úÖ Event listener adicionado: switchCamera');
                } else {
                    console.error('‚ùå Bot√£o switchCamera n√£o encontrado');
                }
                
                if (toggleFlashBtn) {
                    toggleFlashBtn.addEventListener('click', toggleFlash);
                    console.log('‚úÖ Event listener adicionado: toggleFlash');
                } else {
                    console.error('‚ùå Bot√£o toggleFlash n√£o encontrado');
                }
                
                if (endSessionBtn2) {
                    // Remove onclick inline e adiciona event listener
                    endSessionBtn2.removeAttribute('onclick');
                    endSessionBtn2.addEventListener('click', endSession);
                    console.log('‚úÖ Event listener adicionado: endSessionBtn2');
                } else {
                    console.error('‚ùå Bot√£o endSessionBtn2 n√£o encontrado');
                }
            }, 100);
            
            // Fullscreen toggle
            document.getElementById('toggleFullscreen').addEventListener('click', toggleFullscreen);
            
            // Back button (mobile)
            const backButton = document.getElementById('backButton');
            if (backButton) {
                backButton.addEventListener('click', () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const eventId = urlParams.get('event');
                    const eventName = urlParams.get('eventName');
                    
                    if (eventId) {
                        // Voltar para a p√°gina do evento (classifications)
                        window.location.href = `/classifications?event=${eventId}${eventName ? '&eventName=' + encodeURIComponent(eventName) : ''}`;
                    } else {
                        // Voltar para eventos
                        window.location.href = '/events';
                    }
                });
            }
            
            // Menu toggle mobile
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('sidebar-open');
                });
            }
        }
        
        async function requestDevicePin() {
            try {
                console.log('üîê requestDevicePin: Iniciando...');
                console.log('  Event ID:', currentEvent.id);
                console.log('  Device ID:', currentDevice);
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.error('‚ùå Supabase n√£o dispon√≠vel');
                    showError('Supabase n√£o conectado');
                    return;
                }
                
                console.log('üìä Buscando dados do dispositivo no Supabase...');
                
                // Carregar dados do dispositivo (PIN e limites de sess√£o)
                const { data: deviceData, error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('device_pin, checkpoint_name, max_sessions, active_sessions')
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', currentDevice)
                    .single();
                
                console.log('üìä Resultado:');
                console.log('  Data:', deviceData);
                console.log('  Error:', error);
                
                if (error || !deviceData) {
                    console.warn('‚ö†Ô∏è Device n√£o encontrado, pulando PIN');
                    console.warn('  Poss√≠vel causa: device n√£o est√° em event_devices');
                    console.warn('  Execute: SELECT * FROM event_devices WHERE device_id = \'' + currentDevice + '\'');
                    requestCameraPermission();
                    return;
                }
                
                console.log('‚úÖ Device encontrado:', deviceData);
                
                // Verificar limite de sess√µes
                const activeSessions = deviceData.active_sessions || 0;
                const maxSessions = deviceData.max_sessions || 1;
                
                console.log(`üìä Sess√µes: ${activeSessions}/${maxSessions}`);
                console.log(`üìä Verificando limite: ${activeSessions} >= ${maxSessions} ?`);
                console.log(`üìä Resultado: ${activeSessions >= maxSessions}`);
                
                if (activeSessions >= maxSessions) {
                    console.error('‚ùå‚ùå‚ùå LIMITE DE SESS√ïES ATINGIDO! ‚ùå‚ùå‚ùå');
                    console.error(`  Ativas: ${activeSessions}`);
                    console.error(`  M√°ximo: ${maxSessions}`);
                    
                    // Mostrar modal de confirma√ß√£o com PIN para libertar sess√£o
                    await showSessionConflictModal(deviceData);
                    return;
                }
                
                devicePin = deviceData.device_pin;
                
                console.log('üîê PIN requerido para este dispositivo');
                console.log('  PIN existe:', !!devicePin);
                console.log('  PIN valor:', devicePin ? '****' : 'Nenhum');
                console.log('üìç Checkpoint:', deviceData.checkpoint_name || 'N√£o configurado');
                
                // Se n√£o tem PIN configurado, ir direto para c√¢mera
                if (!devicePin) {
                    console.log('‚ö†Ô∏è Dispositivo sem PIN, pulando valida√ß√£o');
                    requestCameraPermission();
                    return;
                }
                
                // Mostrar tela de PIN
                console.log('üîê Mostrando tela de PIN...');
                const pinPanel = document.getElementById('pinPanel');
                if (pinPanel) {
                    pinPanel.style.display = 'flex';
                    console.log('‚úÖ Tela de PIN exibida');
                } else {
                    console.error('‚ùå Elemento pinPanel n√£o encontrado');
                }
                
                // Focus no input
                setTimeout(() => {
                    const pinInput = document.getElementById('pinInput');
                    if (pinInput) {
                        pinInput.focus();
                        console.log('‚úÖ Focus no input PIN');
                    } else {
                        console.error('‚ùå Input PIN n√£o encontrado');
                    }
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar PIN:', error);
                // Se falhar, permitir acesso
                requestCameraPermission();
            }
        }
        
        async function showSessionConflictModal(deviceData) {
            return new Promise((resolve) => {
                // Criar modal de confirma√ß√£o
                const modal = document.createElement('div');
                modal.id = 'sessionConflictModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: var(--spacing-4);
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: var(--bg-secondary);
                        border-radius: var(--radius-lg);
                        padding: var(--spacing-6);
                        max-width: 500px;
                        width: 100%;
                        box-shadow: var(--shadow-2xl);
                    ">
                        <h2 style="color: var(--danger); margin: 0 0 var(--spacing-4) 0; display: flex; align-items: center; gap: var(--spacing-2);">
                            <span style="font-size: 2rem;">‚ö†Ô∏è</span>
                            Dispositivo em Uso
                        </h2>
                        
                        <p style="color: var(--text-primary); margin: 0 0 var(--spacing-4) 0; line-height: 1.6;">
                            Este dispositivo j√° tem <strong>${deviceData.active_sessions}</strong> sess√£o(√µes) ativa(s).<br>
                            Limite m√°ximo: <strong>${deviceData.max_sessions}</strong> sess√£o(√µes).
                        </p>
                        
                        <div style="background: rgba(252, 107, 3, 0.1); padding: var(--spacing-4); border-radius: var(--radius-base); border-left: 3px solid var(--primary); margin: 0 0 var(--spacing-5) 0;">
                            <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">
                                <strong>üîê Tem a certeza que deseja assumir este dispositivo?</strong><br><br>
                                Para libertar a sess√£o atual e criar uma nova, introduza o PIN do dispositivo:
                            </p>
                        </div>
                        
                        <div style="margin: 0 0 var(--spacing-4) 0;">
                            <input 
                                type="password" 
                                id="conflictPinInput"
                                placeholder="Digite o PIN do dispositivo"
                                autocomplete="off"
                                style="
                                    width: 100%;
                                    padding: var(--spacing-3);
                                    font-size: var(--font-size-lg);
                                    text-align: center;
                                    letter-spacing: 0.5em;
                                    border: 2px solid var(--border-color);
                                    border-radius: var(--radius-base);
                                    background: var(--bg-primary);
                                    color: var(--text-primary);
                                "
                            />
                            <div id="conflictPinError" style="color: var(--danger); margin-top: var(--spacing-2); display: none;"></div>
                        </div>
                        
                        <div style="display: flex; gap: var(--spacing-3);">
                            <button 
                                id="confirmReleaseBtn"
                                class="btn btn-primary"
                                style="flex: 1;"
                            >
                                üîì Libertar e Assumir
                            </button>
                            <button 
                                id="cancelReleaseBtn"
                                class="btn btn-secondary"
                                style="flex: 1;"
                            >
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const pinInput = modal.querySelector('#conflictPinInput');
                const errorDiv = modal.querySelector('#conflictPinError');
                const confirmBtn = modal.querySelector('#confirmReleaseBtn');
                const cancelBtn = modal.querySelector('#cancelReleaseBtn');
                
                pinInput.focus();
                
                // Enter no input = confirmar
                pinInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    }
                });
                
                // Confirmar com PIN
                confirmBtn.addEventListener('click', async () => {
                    const inputPin = pinInput.value.trim();
                    
                    if (!inputPin) {
                        errorDiv.textContent = '‚ö†Ô∏è Digite o PIN do dispositivo';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    
                    if (inputPin !== deviceData.device_pin) {
                        errorDiv.textContent = '‚ùå PIN incorreto. Tente novamente.';
                        errorDiv.style.display = 'block';
                        pinInput.value = '';
                        pinInput.focus();
                        return;
                    }
                    
                    // PIN correto! Libertar sess√µes antigas e criar nova
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '‚è≥ Libertando sess√£o...';
                    
                    // Libertar todas as sess√µes deste dispositivo
                    await releaseAllDeviceSessions();
                    
                    // Remover modal
                    modal.remove();
                    resolve(true);
                    
                    // Continuar com fluxo normal (mostrar tela de PIN padr√£o)
                    devicePin = deviceData.device_pin;
                    document.getElementById('pinPanel').style.display = 'flex';
                    document.getElementById('pinInput').focus();
                });
                
                // Cancelar
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                    setTimeout(() => window.history.back(), 500);
                });
            });
        }
        
        async function releaseAllDeviceSessions() {
            try {
                console.log('üîì Libertando todas as sess√µes do dispositivo...');
                
                // Decrementar contador de sess√µes ativas
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .update({ active_sessions: 0 })
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', currentDevice);
                
                if (error) {
                    console.error('‚ùå Erro ao libertar sess√µes:', error);
                } else {
                    console.log('‚úÖ Sess√µes libertadas com sucesso');
                }
                
                // Se existir fun√ß√£o RPC para limpar sess√µes
                try {
                    await window.supabaseClient.supabase
                        .rpc('end_all_device_sessions', {
                            p_device_id: currentDevice,
                            p_event_id: currentEvent.id
                        });
                } catch (rpcError) {
                    console.log('‚ÑπÔ∏è RPC end_all_device_sessions n√£o dispon√≠vel (opcional)');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao libertar sess√µes:', error);
            }
        }
        
        async function validatePin() {
            const inputPin = document.getElementById('pinInput').value;
            const errorDiv = document.getElementById('pinError');
            
            if (!inputPin) {
                errorDiv.textContent = 'Digite o PIN';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (inputPin === devicePin) {
                // PIN correto! Tentar iniciar sess√£o
                console.log('‚úÖ PIN validado com sucesso');
                pinValidated = true;
                
                // Criar sess√£o no Supabase
                const sessionCreated = await createDeviceSession();
                
                if (!sessionCreated) {
                    errorDiv.textContent = '‚ùå Limite de sess√µes atingido. Aguarde.';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Esconder tela de PIN
                document.getElementById('pinPanel').style.display = 'none';
                
                // Mostrar bot√£o terminar sess√£o (mobile e desktop)
                const endBtn = document.getElementById('endSessionBtn');
                const endBtn2 = document.getElementById('endSessionBtn2');
                if (endBtn) endBtn.style.display = 'block';
                if (endBtn2) endBtn2.style.display = 'inline-flex';
                
                // Mostrar tela de permiss√£o de c√¢mera
                requestCameraPermission();
                
                // Iniciar heartbeat
                startSessionHeartbeat();
                
            } else {
                // PIN errado
                console.error('‚ùå PIN incorreto');
                errorDiv.textContent = '‚ùå PIN incorreto. Tente novamente.';
                errorDiv.style.display = 'block';
                
                // Limpar input
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').focus();
                
                // Shake animation
                const panel = document.querySelector('#pinPanel .permission-content');
                panel.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    panel.style.animation = '';
                }, 500);
            }
        }
        
        async function cleanupInactiveSessions() {
            try {
                console.log('üßπ Limpando sess√µes inativas...');
                
                const { data, error } = await window.supabaseClient.supabase
                    .rpc('cleanup_inactive_sessions');
                
                if (error) {
                    console.error('‚ùå Erro ao limpar:', error);
                    showError('Erro ao limpar sess√µes');
                    return false;
                }
                
                console.log(`‚úÖ ${data || 0} sess√µes inativas removidas`);
                alert(`‚úÖ ${data || 0} sess√µes inativas foram removidas. Tente novamente.`);
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                showError('Fun√ß√£o cleanup n√£o dispon√≠vel. Execute add-device-sessions.sql');
                return false;
            }
        }
        
        async function createDeviceSession() {
            try {
                console.log('üìù Criando sess√£o...');
                
                const { data, error } = await window.supabaseClient.supabase
                    .rpc('start_device_session', {
                        p_event_id: currentEvent.id,
                        p_device_id: currentDevice,
                        p_session_id: sessionId,
                        p_user_agent: navigator.userAgent
                    });
                
                console.log('üìä Resultado criar sess√£o:');
                console.log('  Data:', data);
                console.log('  Error:', error);
                
                if (error) {
                    console.error('‚ùå Erro ao criar sess√£o:', error);
                    console.error('  Poss√≠vel causa: Fun√ß√£o start_device_session n√£o existe');
                    console.error('  Execute: add-device-sessions.sql no Supabase');
                    
                    // Permitir acesso mesmo sem sess√µes (fallback)
                    console.warn('‚ö†Ô∏è Continuando sem controle de sess√µes...');
                    return true;
                }
                
                if (!data?.success) {
                    console.error('‚ùå Sess√£o n√£o criada:', data);
                    if (data?.error === 'Max sessions exceeded') {
                        showError(`Limite de ${data.max_allowed} sess√µes atingido!`);
                    }
                    return false;
                }
                
                console.log('‚úÖ Sess√£o criada com sucesso!');
                console.log(`  Sess√£o ID: ${data.session_id}`);
                console.log(`  Ativas agora: ${data.current_active}/${data.max_allowed}`);
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro geral:', error);
                // Permitir acesso em caso de erro (para n√£o bloquear)
                return true;
            }
        }
        
        function startSessionHeartbeat() {
            // Enviar heartbeat a cada 30 segundos
            setInterval(async () => {
                try {
                    await window.supabaseClient.supabase
                        .rpc('update_session_heartbeat', {
                            p_session_id: sessionId
                        });
                    console.log('üíì Heartbeat enviado');
                } catch (error) {
                    console.error('‚ùå Erro no heartbeat:', error);
                }
            }, 30000);
        }
        
        async function endSession() {
            if (!confirm('Tem certeza que deseja terminar a sess√£o? Isto ir√° libertar o dispositivo para outro operador.')) {
                return;
            }
            
            try {
                console.log('üö™ Encerrando sess√£o...');
                console.log('  Session ID:', sessionId);
                console.log('  Device ID:', currentDevice);
                console.log('  Event ID:', currentEvent.id);
                
                // Parar detec√ß√£o se estiver ativa
                if (isDetecting) {
                    stopDetection();
                    console.log('‚úÖ Detec√ß√£o parada');
                }
                
                // Parar c√¢mera
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    console.log('‚úÖ C√¢mera desligada');
                }
                
                // DECREMENTAR active_sessions MANUALMENTE (fallback se fun√ß√£o n√£o existir)
                console.log('üìâ Decrementando active_sessions...');
                const { error: decrementError } = await window.supabaseClient.supabase
                    .rpc('decrement', {
                        table_name: 'event_devices',
                        column_name: 'active_sessions',
                        row_id: null
                    });
                
                // Alternativa: UPDATE direto
                const { data: currentData } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('active_sessions')
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', currentDevice)
                    .single();
                
                const newCount = Math.max(0, (currentData?.active_sessions || 1) - 1);
                
                console.log(`üìâ Atualizando: ${currentData?.active_sessions} ‚Üí ${newCount}`);
                
                const { error: updateError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .update({ active_sessions: newCount })
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', currentDevice);
                
                if (updateError) {
                    console.error('‚ùå Erro ao decrementar:', updateError);
                } else {
                    console.log('‚úÖ Contador decrementado');
                }
                
                // Encerrar sess√£o no Supabase (se fun√ß√£o existir)
                if (sessionId && pinValidated) {
                    try {
                        console.log('üîÑ Chamando end_device_session com sessionId:', sessionId);
                        const { data, error } = await window.supabaseClient.supabase
                            .rpc('end_device_session', {
                                p_session_id: sessionId
                            });
                        
                        if (error) {
                            console.error('‚ùå Erro ao encerrar sess√£o via RPC:', error);
                        } else {
                            console.log('‚úÖ Sess√£o encerrada via RPC:', data);
                        }
                    } catch (rpcError) {
                        console.error('‚ùå Erro ao chamar RPC end_device_session:', rpcError);
                    }
                } else {
                    console.warn('‚ö†Ô∏è sessionId ou pinValidated n√£o dispon√≠vel:', { sessionId, pinValidated });
                }
                
                // Limpar sess√µes inativas
                try {
                    console.log('üßπ Limpando sess√µes inativas...');
                    const { data: cleanupData, error: cleanupError } = await window.supabaseClient.supabase
                        .rpc('cleanup_inactive_sessions');
                    
                    if (cleanupError) {
                        console.error('‚ùå Erro ao limpar sess√µes inativas:', cleanupError);
                    } else {
                        console.log('‚úÖ Sess√µes inativas limpas:', cleanupData);
                    }
                } catch (cleanupRpcError) {
                    console.error('‚ùå Erro ao chamar cleanup_inactive_sessions:', cleanupRpcError);
                }
                
                // Mostrar mensagem
                alert('‚úÖ Sess√£o encerrada com sucesso! O dispositivo foi libertado.');
                
                // Redirecionar para a home page
                window.location.href = '/';
                
            } catch (error) {
                console.error('‚ùå Erro ao encerrar sess√£o:', error);
                showError('Erro ao encerrar sess√£o');
            }
        }
        
        // Encerrar sess√£o ao sair (autom√°tico)
        // Liberta√ß√£o autom√°tica ao navegar para outra p√°gina
        window.addEventListener('beforeunload', async (e) => {
            if (sessionId && pinValidated) {
                // Libertar dispositivo automaticamente
                await releaseDeviceOnExit();
            }
        });
        
        // Interceptar navega√ß√£o via sidebar/links
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('a.nav-link, .nav-btn');
            
            if (link) {
                const href = link.getAttribute('href');
                
                // Se est√° a navegar para outra p√°gina (n√£o √© hash ou mesma p√°gina)
                if (href && !href.startsWith('#') && !href.includes('detection')) {
                    e.preventDefault();
                    
                    console.log('üîÑ Navega√ß√£o detectada para p√°gina protegida...');
                    
                    // 1. Libertar dispositivo se tiver sess√£o ativa
                    if (sessionId && pinValidated) {
                        console.log('üö™ Libertando dispositivo...');
                        await releaseDeviceOnExit();
                    }
                    
                    // 2. Verificar se p√°gina de destino requer autentica√ß√£o
                    const requiresAuth = !href.includes('login') && !href.includes('register');
                    
                    if (requiresAuth) {
                        // Verificar se est√° autenticado
                        const isAuthenticated = window.authSystem?.currentUser;
                        
                        if (!isAuthenticated) {
                            console.log('üîê P√°gina protegida - redirecionando para login...');
                            
                            // Salvar URL de destino para voltar ap√≥s login
                            sessionStorage.setItem('returnUrl', href);
                            
                            // Redirecionar para login
                            window.location.href = '/login.html?returnUrl=' + encodeURIComponent(href);
                            return;
                        }
                    }
                    
                    // 3. Continuar navega√ß√£o
                    setTimeout(() => {
                        window.location.href = href;
                    }, 300);
                }
            }
        });
        
        async function releaseDeviceOnExit() {
            try {
                console.log('üö™ Libertando dispositivo ao sair...');
                
                // Parar detec√ß√£o
                if (isDetecting) {
                    stopDetection();
                }
                
                // Parar c√¢mera
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Decrementar sess√µes ativas usando sendBeacon para garantir
                const updateData = {
                    event_id: currentEvent.id,
                    device_id: currentDevice
                };
                
                // Tentar via sendBeacon primeiro
                try {
                    const { data: currentData } = await window.supabaseClient.supabase
                        .from('event_devices')
                        .select('active_sessions')
                        .eq('event_id', currentEvent.id)
                        .eq('device_id', currentDevice)
                        .single();
                    
                    const newCount = Math.max(0, (currentData?.active_sessions || 1) - 1);
                    
                    await window.supabaseClient.supabase
                        .from('event_devices')
                        .update({ active_sessions: newCount })
                        .eq('event_id', currentEvent.id)
                        .eq('device_id', currentDevice);
                    
                    console.log(`‚úÖ Dispositivo libertado (sess√µes: ${currentData?.active_sessions} ‚Üí ${newCount})`);
                } catch (error) {
                    console.error('‚ùå Erro ao libertar:', error);
                }
                
            } catch (error) {
                console.error('‚ùå Erro em releaseDeviceOnExit:', error);
            }
        }
        
        function requestCameraPermission() {
            // Show permission panel
            document.getElementById('permissionPanel').style.display = 'flex';
        }
        
        async function startCamera() {
            try {
                // Hide permission panel
                document.getElementById('permissionPanel').style.display = 'none';
                
                // Request camera access
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Back camera
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                // Set video source
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;
                
                console.log('‚úÖ C√¢mera iniciada');
                
                // Show detection area
                setupDetectionArea();
                
            } catch (error) {
                console.error('‚ùå Erro ao acessar c√¢mera:', error);
                showError('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.');
            }
        }
        
        function setupDetectionArea() {
            const overlay = document.getElementById('cameraOverlay');
            const detectionArea = document.createElement('div');
            detectionArea.className = 'detection-area';
            detectionArea.id = 'detectionArea';
            
            // Position detection area (center 60% of screen)
            const rect = {
                left: '20%',
                top: '20%',
                width: '60%',
                height: '60%'
            };
            
            Object.assign(detectionArea.style, rect);
            overlay.appendChild(detectionArea);
        }
        
        function startDetection() {
            console.log('üéØ startDetection() chamada');
            
            if (!cameraStream) {
                console.error('‚ùå C√¢mera n√£o iniciada');
                showError('C√¢mera n√£o iniciada');
                return;
            }
            
            isDetecting = true;
            detectionCount = 0;
            
            // Update UI
            document.getElementById('startDetection').style.display = 'none';
            document.getElementById('stopDetection').style.display = 'inline-flex';
            
            // Start continuous capture to buffer (every 2 seconds)
            captureInterval = setInterval(() => {
                captureToBuffer();
            }, 2000);
            
            console.log('üéØ Detec√ß√£o iniciada - Capturando para buffer a cada 2s');
            console.log('üìã As imagens ser√£o processadas automaticamente pelo servidor');
        }
        
        function stopDetection() {
            console.log('‚èπÔ∏è stopDetection() chamada');
            
            isDetecting = false;
            
            // Stop capture interval
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            
            // Update UI
            document.getElementById('startDetection').style.display = 'inline-flex';
            document.getElementById('stopDetection').style.display = 'none';
            
            console.log('‚èπÔ∏è Detec√ß√£o parada');
        }
        
        async function captureToBuffer() {
            if (!isDetecting || !cameraStream) return;
            
            try {
                const video = document.getElementById('cameraVideo');
                if (!video.videoWidth || !video.videoHeight) return;
                
                // Capture image from video
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert to base64 (optimized for AI)
                const aiVersion = canvas.toDataURL('image/jpeg', 0.7); // 70% quality for AI
                const displayVersion = canvas.toDataURL('image/jpeg', 0.9); // 90% quality for display
                
                const now = new Date();
                
                // Create buffer entry
                const bufferEntry = {
                    event_id: currentEvent.id,
                    device_id: currentDevice,
                    session_id: sessionId,
                    image_data: aiVersion,
                    display_image: displayVersion,
                    image_metadata: {
                        width: canvas.width,
                        height: canvas.height,
                        device_type: 'mobile',
                        timestamp: now.toISOString()
                    },
                    captured_at: now.toISOString(),
                    latitude: currentPosition?.latitude || null,
                    longitude: currentPosition?.longitude || null,
                    accuracy: currentPosition?.accuracy || null,
                    status: 'pending'
                };
                
                // Send to Supabase buffer
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.error('‚ùå Supabase n√£o dispon√≠vel');
                    return;
                }
                
                const { data, error } = await window.supabaseClient.supabase
                    .from('image_buffer')
                    .insert([bufferEntry])
                    .select()
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro ao salvar no buffer:', error);
                } else {
                    detectionCount++;
                    document.getElementById('detectionCount').textContent = detectionCount;
                    
                    // Flash detection area green
                    const overlay = document.getElementById('cameraOverlay');
                    overlay.style.border = '4px solid #10b981';
                    setTimeout(() => {
                        overlay.style.border = 'none';
                    }, 200);
                    
                    console.log(`üì∏ Imagem ${detectionCount} salva no buffer:`, data.id);
                }
                
            } catch (error) {
                console.error('‚ùå Erro na captura:', error);
            }
        }
        
        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                console.log('‚ö†Ô∏è Geolocaliza√ß√£o n√£o dispon√≠vel');
                return;
            }
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                currentPosition = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                console.log('üìç Localiza√ß√£o obtida:', currentPosition);
            } catch (error) {
                console.log('‚ö†Ô∏è Erro ao obter localiza√ß√£o:', error.message);
            }
        }
        
        async function registerDevice(eventId, deviceId) {
            if (!window.supabaseClient || !window.supabaseClient.supabase) {
                console.log('‚ö†Ô∏è Supabase n√£o dispon√≠vel');
                return;
            }
            
            try {
                // Atualizar last_seen do dispositivo
                const { error } = await window.supabaseClient.supabase
                    .from('devices')
                    .update({ 
                        last_seen: new Date().toISOString(),
                        user_agent: navigator.userAgent
                    })
                    .eq('id', deviceId);
                
                if (error) {
                    console.warn('‚ö†Ô∏è Aviso ao atualizar dispositivo:', error.message);
                } else {
                    console.log('‚úÖ Dispositivo registrado no evento');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao registrar dispositivo:', error.message);
            }
        }
        
        function switchCamera() {
            // Implementation for camera switching
            console.log('üîÑ Trocando c√¢mera...');
        }
        
        let flashEnabled = false;
        async function toggleFlash() {
            console.log('‚ö° toggleFlash() chamada');
            
            try {
                if (!cameraStream) {
                    console.error('‚ùå C√¢mera n√£o iniciada');
                    showError('C√¢mera n√£o iniciada');
                    return;
                }
                
                const track = cameraStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if (!capabilities.torch) {
                    showError('Flash n√£o dispon√≠vel neste dispositivo');
                    return;
                }
                
                flashEnabled = !flashEnabled;
                await track.applyConstraints({
                    advanced: [{ torch: flashEnabled }]
                });
                
                const flashBtn = document.getElementById('toggleFlash');
                if (flashEnabled) {
                    flashBtn.innerHTML = '<i>üí°</i> Flash ON';
                    flashBtn.classList.remove('btn-warning');
                    flashBtn.classList.add('btn-success');
                    console.log('‚ö° Flash ativado');
                } else {
                    flashBtn.innerHTML = '<i>‚ö°</i> Flash';
                    flashBtn.classList.remove('btn-success');
                    flashBtn.classList.add('btn-warning');
                    console.log('‚ö° Flash desativado');
                }
            } catch (error) {
                console.error('‚ùå Erro ao alternar flash:', error);
                showError('Erro ao controlar o flash');
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function loadEventInfo(eventId, eventName) {
            // Update UI
            const name = eventName || 'Evento Selecionado';
            document.getElementById('eventName').textContent = name;
            
            const eventInfoPanel = document.getElementById('eventInfoPanel');
            const currentEventInfo = document.getElementById('currentEventInfo');
            
            if (eventInfoPanel && eventId) {
                eventInfoPanel.style.display = 'block';
                currentEventInfo.innerHTML = `
                    <strong>${name}</strong><br>
                    Device: ${currentDevice?.substring(0, 12) || 'N/A'}...
                `;
            }
        }
        
        function showError(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'toast toast-error';
            toast.innerHTML = `
                <div class="toast-icon">‚ùå</div>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
    
    <!-- All styles moved to external CSS files -->
</body>
</html>
