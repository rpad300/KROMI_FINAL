<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS Tracking - VisionKrono</title>
  <link rel="icon" type="image/png" href="Logos/icon_kromi_color.png">
  
  <!-- External Dependencies -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #fc6b03;
      --primary-dark: #e55a02;
      --bg-light: #ffffff;
      --bg-dark: #000000;
      --card-light: #f8fafc;
      --card-dark: #1a1a1a;
      --text-light: #1f2937;
      --text-dark: #ffffff;
      --border-light: #e5e7eb;
      --border-dark: #374151;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }

    [data-theme="dark"] {
      --bg-primary: var(--bg-dark);
      --bg-secondary: var(--card-dark);
      --text-primary: var(--text-dark);
      --text-secondary: #a0a0a0;
      --border-color: var(--border-dark);
    }

    [data-theme="light"] {
      --bg-primary: var(--bg-light);
      --bg-secondary: var(--card-light);
      --text-primary: var(--text-light);
      --text-secondary: #6b7280;
      --border-color: var(--border-light);
    }

    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.3s ease;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .app-container { height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    .app-header { height: 56px; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; align-items: center; padding: 0 16px; }
    .app-content { flex: 1; overflow-y: auto; }
    .app-bottom-nav { height: 60px; background: var(--bg-primary); border-top: 1px solid var(--border-color); flex-shrink: 0; display: flex; justify-content: space-around; align-items: center; }

    .compact-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    
    .btn { padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .nav-item { flex: 1; text-align: center; padding: 8px; cursor: pointer; transition: all 0.2s; color: var(--text-secondary); }
    .nav-item.active { color: var(--primary); }
    .nav-item i { display: block; font-size: 20px; margin-bottom: 4px; }
    .nav-item span { font-size: 10px; }

    .section { padding: 16px; }
    .section-hidden { display: none; }

    #map { height: 400px; width: 100%; border-radius: 8px; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .stat-card { background: var(--bg-secondary); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

    .route-card, .runner-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .route-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .route-name { font-weight: 600; font-size: 16px; }

    .badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; display: inline-block; }
    .badge-active { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .badge-inactive { background: rgba(107, 114, 128, 0.15); color: #6b7280; }

    table { width: 100%; border-collapse: collapse; }
    th { background: var(--bg-secondary); padding: 8px; text-align: left; font-size: 12px; border-bottom: 2px solid var(--border-color); }
    td { padding: 8px; border-bottom: 1px solid var(--border-color); font-size: 13px; }
    tbody tr:hover { background: var(--bg-secondary); }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
    .modal-body { padding: 16px; }
    .modal-footer { padding: 16px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; justify-content: flex-end; }

    .form-group { margin-bottom: 12px; }
    .form-label { display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500; }
    .form-input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); }

    .qr-display { text-align: center; padding: 16px; }
    .qr-code-text { font-family: monospace; font-size: 10px; word-break: break-all; margin-top: 8px; }

    .runner-marker { width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; color: white; background: var(--success); }
  </style>
</head>
<body data-theme="light">
  <div class="app-container">
    <!-- Header -->
    <div class="app-header">
      <button onclick="goBack()" class="btn btn-sm">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
      <div style="flex: 1; text-align: center; font-weight: 600;">
        üìç GPS Tracking
      </div>
      <button onclick="toggleTheme()" class="btn btn-sm">
        <i class="fas fa-moon" id="theme-icon"></i>
      </button>
    </div>

    <!-- Content -->
    <div class="app-content">
      <!-- Rotas Section -->
      <div id="section-routes" class="section">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-routes">0</div>
            <div class="stat-label">Rotas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-active">0</div>
            <div class="stat-label">Ativas</div>
          </div>
        </div>

        <button class="btn btn-primary" onclick="openRouteModal()" style="width: 100%; margin-bottom: 12px;">
          <i class="fas fa-plus"></i> Nova Rota
        </button>

        <div id="routes-list"></div>
      </div>

      <!-- QR Codes Section -->
      <div id="section-qrs" class="section section-hidden">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-qr-total">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-qr-active">0</div>
            <div class="stat-label">QRs Ativos</div>
          </div>
        </div>

        <button class="btn btn-primary" onclick="issueAllQRs()" style="width: 100%; margin-bottom: 12px;">
          <i class="fas fa-qrcode"></i> Emitir QRs em Massa
        </button>

        <div id="qrs-list"></div>
      </div>

      <!-- Live Map Section -->
      <div id="section-live" class="section section-hidden">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-running">0</div>
            <div class="stat-label">Em Corrida</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-paused">0</div>
            <div class="stat-label">Pausados</div>
          </div>
        </div>

        <div id="map" class="compact-card"></div>
        <div id="runners-list" style="margin-top: 12px;"></div>
      </div>

      <!-- Rankings Section -->
      <div id="section-rankings" class="section section-hidden">
        <select id="route-filter" class="form-input" style="margin-bottom: 12px;">
          <option value="">Selecione uma rota...</option>
        </select>

        <div id="rankings-list"></div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="app-bottom-nav">
      <div class="nav-item active" onclick="showSection('routes')">
        <i class="fas fa-route"></i>
        <span>Rotas</span>
      </div>
      <div class="nav-item" onclick="showSection('qrs')">
        <i class="fas fa-qrcode"></i>
        <span>QR Codes</span>
      </div>
      <div class="nav-item" onclick="showSection('live')">
        <i class="fas fa-map-marked-alt"></i>
        <span>Mapa Live</span>
      </div>
      <div class="nav-item" onclick="showSection('rankings')">
        <i class="fas fa-trophy"></i>
        <span>Rankings</span>
      </div>
    </div>
  </div>

  <!-- Modal Rota -->
  <div id="route-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="route-modal-title">Nova Rota</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nome *</label>
          <input type="text" id="route-name" class="form-input" placeholder="Ex: 10K">
        </div>
        <div class="form-group">
          <label class="form-label">Dist√¢ncia (km) *</label>
          <input type="number" id="route-distance" class="form-input" step="0.1" placeholder="10.0">
        </div>
        <div class="form-group">
          <label class="form-label">Vel. M√°xima (km/h)</label>
          <input type="number" id="route-max-speed" class="form-input" value="50">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeRouteModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveRoute()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal QR -->
  <div id="qr-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>QR Code</h3>
      </div>
      <div class="modal-body">
        <div class="qr-display">
          <canvas id="qr-canvas"></canvas>
          <p class="qr-code-text" id="qr-code-text"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeQRModal()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // Configura√ß√£o - SUBSTITUIR com valores reais
    const SUPABASE_URL = 'https://mdrvgbztadnluhrrnlob.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kcnZnYnp0YWRubHVocnJubG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5OTQ1MDUsImV4cCI6MjA3NjU3MDUwNX0.x2po57tZOQ443NLVURBWDIYQnYbJ4D6O45FlZ5qwmp4';
    const EVENT_ID = new URLSearchParams(window.location.search).get('event_id') || 'YOUR_EVENT_ID';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    let map;
    let markers = {};
    let currentSection = 'routes';

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', async () => {
      initMap();
      await loadRoutes();
      await loadQRs();
      setInterval(loadLivePositions, 5000); // Atualizar a cada 5s
    });

    // Navega√ß√£o
    function showSection(section) {
      currentSection = section;
      document.querySelectorAll('.section').forEach(s => s.classList.add('section-hidden'));
      document.getElementById(`section-${section}`).classList.remove('section-hidden');
      
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      event.currentTarget.classList.add('active');

      if (section === 'live') loadLivePositions();
      if (section === 'rankings') loadRankings();
    }

    function goBack() {
      window.history.back();
    }

    function toggleTheme() {
      const current = document.body.getAttribute('data-theme');
      const newTheme = current === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      document.getElementById('theme-icon').className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }

    // Rotas
    async function loadRoutes() {
      try {
        const { data, error } = await supabaseClient
          .from('track_routes')
          .select('*')
          .eq('event_id', EVENT_ID)
          .order('created_at', { ascending: false });

        if (error) throw error;

        document.getElementById('stat-routes').textContent = data.length;
        document.getElementById('stat-active').textContent = data.filter(r => r.is_active).length;

        const list = document.getElementById('routes-list');
        list.innerHTML = data.map(r => `
          <div class="route-card">
            <div class="route-header">
              <span class="route-name">${r.name}</span>
              <span class="badge ${r.is_active ? 'badge-active' : 'badge-inactive'}">
                ${r.is_active ? 'Ativa' : 'Inativa'}
              </span>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary);">
              ${r.distance_km} km ‚Ä¢ Vel.M√°x: ${r.max_speed_kmh} km/h
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar rotas:', error);
      }
    }

    function openRouteModal() {
      document.getElementById('route-modal').classList.add('active');
    }

    function closeRouteModal() {
      document.getElementById('route-modal').classList.remove('active');
    }

    async function saveRoute() {
      const data = {
        event_id: EVENT_ID,
        name: document.getElementById('route-name').value,
        distance_km: parseFloat(document.getElementById('route-distance').value),
        max_speed_kmh: parseFloat(document.getElementById('route-max-speed').value),
        is_active: true
      };

      try {
        const { error } = await supabaseClient.from('track_routes').insert([data]);
        if (error) throw error;
        closeRouteModal();
        await loadRoutes();
      } catch (error) {
        alert('Erro: ' + error.message);
      }
    }

    // QR Codes
    async function loadQRs() {
      try {
        const { data, error } = await supabaseClient
          .from('participants')
          .select('id, full_name, bib_number, track_participant_qr(id, qr_code, status)')
          .eq('event_id', EVENT_ID)
          .order('bib_number');

        if (error) throw error;

        const active = data.filter(p => p.track_participant_qr?.some(q => q.status === 'active')).length;
        document.getElementById('stat-qr-total').textContent = data.length;
        document.getElementById('stat-qr-active').textContent = active;

        const list = document.getElementById('qrs-list');
        list.innerHTML = data.map(p => {
          const qr = p.track_participant_qr?.find(q => q.status === 'active');
          return `
            <div class="compact-card">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>#${p.bib_number}</strong> ${p.full_name}
                </div>
                ${qr ? `
                  <button class="btn btn-sm btn-primary" onclick="showQR('${qr.qr_code}')">
                    Ver QR
                  </button>
                ` : `
                  <button class="btn btn-sm btn-primary" onclick="issueQR('${p.id}')">
                    Emitir
                  </button>
                `}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Erro:', error);
      }
    }

    async function issueQR(participantId) {
      try {
        const { data, error } = await supabaseClient.rpc('track_issue_qr', {
          p_event_id: EVENT_ID,
          p_participant_id: participantId
        });
        if (error) throw error;
        await loadQRs();
        showQR(data.qr_code);
      } catch (error) {
        alert('Erro: ' + error.message);
      }
    }

    async function issueAllQRs() {
      if (!confirm('Emitir QRs para todos os participantes sem QR?')) return;
      // Implementar l√≥gica similar ao HTML standalone
      alert('Funcionalidade em desenvolvimento');
    }

    function showQR(qrCode) {
      const canvas = document.getElementById('qr-canvas');
      document.getElementById('qr-code-text').textContent = qrCode;
      
      QRCode.toCanvas(canvas, qrCode, { width: 250 }, (error) => {
        if (error) console.error(error);
      });

      document.getElementById('qr-modal').classList.add('active');
    }

    function closeQRModal() {
      document.getElementById('qr-modal').classList.remove('active');
    }

    // Mapa Live
    function initMap() {
      map = L.map('map').setView([38.7223, -9.1393], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);
    }

    async function loadLivePositions() {
      if (currentSection !== 'live') return;

      try {
        const { data, error } = await supabaseClient.rpc('track_get_live_positions', {
          p_event_id: EVENT_ID
        });

        if (error) throw error;

        const running = data.filter(r => r.status === 'running').length;
        const paused = data.filter(r => r.status === 'paused').length;
        
        document.getElementById('stat-running').textContent = running;
        document.getElementById('stat-paused').textContent = paused;

        // Atualizar marcadores no mapa
        updateMapMarkers(data);

        // Listar corredores
        const list = document.getElementById('runners-list');
        list.innerHTML = data.map(r => `
          <div class="runner-card">
            <strong>${r.participant_name}</strong> #${r.bib_number}
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
              ‚è±Ô∏è ${formatTime(r.elapsed_sec)} ‚Ä¢ üèÉ ${r.speed_kmh?.toFixed(1) || '-'} km/h
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro:', error);
      }
    }

    function updateMapMarkers(runners) {
      // Limpar marcadores antigos
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};

      // Criar novos marcadores
      runners.forEach(r => {
        if (!r.lat || !r.lng) return;
        
        const icon = L.divIcon({
          html: `<div class="runner-marker">${r.bib_number}</div>`,
          iconSize: [32, 32]
        });

        markers[r.activity_id] = L.marker([r.lat, r.lng], { icon })
          .bindPopup(`<strong>${r.participant_name}</strong><br>#${r.bib_number}`)
          .addTo(map);
      });

      if (runners.length > 0) {
        const group = L.featureGroup(Object.values(markers));
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }

    // Rankings
    async function loadRankings() {
      // Carregar rotas no select
      const { data: routes } = await supabaseClient
        .from('track_routes')
        .select('id, name')
        .eq('event_id', EVENT_ID)
        .eq('is_active', true);

      const select = document.getElementById('route-filter');
      select.innerHTML = '<option value="">Selecione uma rota...</option>' + 
        routes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

      select.onchange = async () => {
        if (!select.value) return;

        const { data, error } = await supabaseClient.rpc('track_get_rankings', {
          p_event_id: EVENT_ID,
          p_route_id: select.value,
          p_limit: 100
        });

        if (error) {
          console.error(error);
          return;
        }

        const list = document.getElementById('rankings-list');
        list.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Pos</th>
                <th>Dorsal</th>
                <th>Nome</th>
                <th>Tempo</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(r => `
                <tr>
                  <td><strong>${r.rank}¬∫</strong></td>
                  <td>#${r.bib_number}</td>
                  <td>${r.participant_name}</td>
                  <td>${r.formatted_time}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      };
    }

    // Utilidades
    function formatTime(seconds) {
      if (!seconds) return '-';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // Fechar modais ao clicar fora
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>

