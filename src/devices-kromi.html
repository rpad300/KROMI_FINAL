<!DOCTYPE html>
<html lang="pt-PT" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivos - VisionKrono</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VisionKrono">
    <meta name="description" content="Sistema de detec√ß√£o de dorsais VisionKrono">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
        /* Layout with Sidebar Structure */
        .layout-with-sidebar {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
        }
        
        /* Sidebar styles */
        .layout-with-sidebar .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1050;
            overflow-y: auto;
            transition: transform var(--transition-slow);
        }
        
        /* Header styles */
        .layout-with-sidebar .header {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 1040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-5);
            transition: left var(--transition-slow);
        }
        
        /* Main content area */
        .layout-with-sidebar .main {
            margin-left: 280px;
            margin-top: 60px;
            width: calc(100% - 280px);
            min-height: calc(100vh - 60px);
            transition: margin-left var(--transition-slow), width var(--transition-slow);
        }
        
        /* Mobile adjustments */
        @media (max-width: 1024px) {
            body {
                overflow-x: hidden;
            }
            
            .layout-with-sidebar .sidebar {
                transform: translateX(-100%);
            }
            
            .layout-with-sidebar .sidebar.sidebar-open {
                transform: translateX(0);
            }
            
            .layout-with-sidebar .header {
                left: 0;
            }
            
            .layout-with-sidebar .main {
                margin-left: 0 !important;
                margin-top: 60px !important;
                width: 100% !important;
                min-height: calc(100vh - 60px) !important;
                padding-bottom: 80px !important;
            }
            
            /* Ensure content fills the screen */
            #mainContent {
                min-height: calc(100vh - 60px - 80px);
                padding: var(--spacing-4);
            }
            
            #menuToggle {
                display: block !important;
            }
            
            .app-bottom-nav {
                display: flex !important;
            }
        }
        
        /* Devices page styles */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .device-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-base), box-shadow var(--transition-base);
        }
        
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-4);
        }
        
        .device-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-1);
        }
        
        .device-id {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-family: var(--font-family-mono);
        }
        
        .device-status {
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-base);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }
        
        .status-online {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .status-offline {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .device-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-3);
            margin-top: var(--spacing-4);
            padding-top: var(--spacing-4);
            border-top: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .device-info {
                grid-template-columns: 1fr;
            }
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-1);
        }
        
        .info-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .device-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-4);
            flex-wrap: wrap;
        }
        
        .device-actions .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-12);
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-4);
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
        }
        
        .empty-state p {
            color: var(--text-secondary);
            max-width: 400px;
            margin-bottom: var(--spacing-4);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .device-info {
                grid-template-columns: 1fr;
            }
            
            .device-actions {
                flex-direction: column;
            }
            
            .device-actions .btn {
                width: 100%;
                min-width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- App Container -->
    <div class="layout-with-sidebar">
        <!-- Sidebar -->
        <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
        <div class="sidebar" id="sidebar">
            <!-- Event Info Panel -->
            <div id="eventInfoPanel" style="padding: var(--spacing-4); border-top: 1px solid var(--border-color); display: none;">
                <div class="nav-category">Evento Atual</div>
                <div id="currentEventInfo" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
        </div>
        
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="header-title">üì± Dispositivos F√≠sicos</h1>
            </div>
            <div class="header-right">
                <div id="connectionStatus" style="font-size: var(--font-size-xs); padding: var(--spacing-2); border-radius: var(--radius-full); display: flex; align-items: center; gap: var(--spacing-1);">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--danger);"></div>
                    <span>Verificando...</span>
                </div>
                <button class="btn btn-sm btn-primary" id="addDeviceBtn">
                    <i>‚ûï</i> Adicionar Dispositivo
                </button>
                <button class="btn btn-sm btn-primary" id="generatePDFBtn" title="Gerar PDF com dispositivos e QR Codes">
                    <i>üìÑ</i> Gerar PDF
                </button>
                <button class="btn btn-sm btn-secondary" id="refreshDevices" title="Clique para recarregar do Supabase">
                    <i>üîÑ</i> Atualizar
                </button>
                <button class="btn btn-sm btn-secondary" onclick="window.location.reload()" title="Recarregar p√°gina completa">
                    <i>‚Üª</i> Reload
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main">
            <div style="flex: 1; overflow-y: auto; padding: var(--spacing-5);" id="mainContent">
                
                <!-- Info Section -->
                <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-4); margin-bottom: var(--spacing-5); border: 1px solid var(--border-color);">
                    <p style="margin: 0 0 var(--spacing-2) 0; color: var(--text-secondary); font-size: var(--font-size-sm);">
                        üì± Gerencie os <strong>dispositivos f√≠sicos</strong> (smartphones, tablets) associados ao evento.
                        Para configurar a <strong>ordem dos checkpoints</strong>, v√° em 
                        <a href="#" id="goToCheckpointOrder" style="color: var(--primary); text-decoration: underline;">Ordem dos Checkpoints</a>.
                    </p>
                    <p style="margin: var(--spacing-2) 0 0 0; padding-top: var(--spacing-2); border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: var(--font-size-xs);">
                        üîê <strong>Seguran√ßa:</strong> Cada dispositivo requer um PIN (4-6 d√≠gitos) para acesso. 
                        O operador ter√° que inserir o PIN ao abrir o link de detec√ß√£o.
                    </p>
                    <div id="debugInfo" style="margin-top: var(--spacing-3); padding: var(--spacing-2); background: var(--bg-primary); border-radius: var(--radius-base); font-size: var(--font-size-xs); color: var(--text-secondary); font-family: var(--font-family-mono);">
                        Event ID: <span id="debugEventId">...</span><br>
                        Query Status: <span id="debugQueryStatus">...</span><br>
                        Dispositivos Encontrados: <span id="debugDeviceCount">...</span>
                    </div>
                </div>
                
                <!-- Devices Grid -->
                <div id="devicesContainer">
                    <h3 style="margin: 0 0 var(--spacing-4) 0; color: var(--text-primary);">
                        üì± Dispositivos Associados
                    </h3>
                    <div class="devices-grid" id="devicesGrid">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üì±</div>
                    <h3>Nenhum dispositivo associado</h3>
                    <p>Adicione dispositivos f√≠sicos para come√ßar a capturar dorsais durante o evento.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('addDeviceBtn').click()">
                        ‚ûï Adicionar Primeiro Dispositivo
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="app-bottom-nav" id="bottomNav">
            <!-- Ser√° preenchido por navigation.js -->
        </nav>
    </div>
    
    <!-- Scripts -->
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- QR Code Library -->
    <script>
        // Carregar biblioteca QRCode dinamicamente
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
            script.onload = function() {
                console.log('‚úÖ QRCode library carregada');
                // Disparar evento customizado
                window.dispatchEvent(new Event('qrcodeLoaded'));
            };
            script.onerror = function() {
                console.error('‚ùå Erro ao carregar QRCode library');
                // Tentar alternativa
                const altScript = document.createElement('script');
                altScript.src = 'https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js';
                altScript.onload = function() {
                    console.log('‚úÖ QRCode library alternativa carregada');
                    window.dispatchEvent(new Event('qrcodeLoaded'));
                };
                document.head.appendChild(altScript);
            };
            document.head.appendChild(script);
        })();
    </script>
    
    <!-- Scripts de Autentica√ß√£o -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102601" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="/universal-route-protection.js?v=2025102618" defer></script>
    
    <!-- Devices Logic -->
    <script>
        let currentEvent = null;
        
        // Aguardar navega√ß√£o estar pronta
        async function waitForNavigation() {
            return new Promise((resolve) => {
                if (window.NavigationUtils) {
                    resolve();
                } else {
                    window.addEventListener('navigationReady', resolve);
                }
            });
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Aguardar Supabase
                if (window.supabaseClient?.init) {
                    await window.supabaseClient.init();
                    await window.supabaseClient.ready();
                }
                
                // Verificar autentica√ß√£o
                const autenticado = await verificarAutenticacao(['admin', 'moderator', 'event_manager']);
                if (!autenticado) return;
                
                console.log('üöÄ Inicializando p√°gina devices...');
                
                // Aguardar navega√ß√£o estar pronta
                await waitForNavigation();
                console.log('‚úÖ Navega√ß√£o pronta');
                
                // Get event from URL
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('event');
                const eventName = urlParams.get('eventName');
                
                if (!eventId) {
                    showError('Nenhum evento selecionado');
                    setTimeout(() => window.location.href = '/events', 2000);
                    return;
                }
                
                currentEvent = { id: eventId, name: eventName };
                
                // Atualizar contexto de evento
                if (window.navigationService) {
                    window.navigationService.setEventContext(eventId, eventName);
                }
                
                // Update UI
                updateEventInfo(eventName);
            
            // Verificar conex√£o Supabase
            console.log('üîç Verificando conex√£o Supabase...');
            console.log('  - window.supabaseClient:', !!window.supabaseClient);
            console.log('  - supabase:', !!window.supabaseClient?.supabase);
            console.log('  - isConnected:', window.supabaseClient?.isConnected);
            
            // Load devices
            await loadDevices();
            
            // Update connection status
            updateConnectionStatus();
            
                // Setup event listeners
                setupEventListeners();
                
                console.log('‚úÖ P√°gina inicializada');
                
            } catch (error) {
                console.error('‚ùå Erro fatal na inicializa√ß√£o:', error);
                const main = document.querySelector('.main');
                if (main) {
                    main.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h2 style="color: var(--danger);">Erro ao Carregar P√°gina</h2>
                            <p>${error.message}</p>
                            <button onclick="window.location.reload()" class="btn-primary">Recarregar</button>
                        </div>
                    `;
                }
            }
        });
        
        function setupEventListeners() {
            document.getElementById('addDeviceBtn').addEventListener('click', showAddDeviceModal);
            document.getElementById('refreshDevices').addEventListener('click', () => {
                console.log('üîÑ Refresh manual acionado');
                loadDevices();
            });
            document.getElementById('generatePDFBtn').addEventListener('click', generateDevicesPDF);
            
            // Link para checkpoint order
            document.getElementById('goToCheckpointOrder').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `/checkpoint-order?event=${currentEvent.id}&eventName=${encodeURIComponent(currentEvent.name)}`;
            });
            
            // Menu toggle mobile
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('sidebar-open');
                });
            }
        }
        
        function updateEventInfo(eventName) {
            // Update header title if needed
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle && eventName) {
                headerTitle.textContent = `üì± Dispositivos - ${eventName}`;
            }
            
            const eventInfoPanel = document.getElementById('eventInfoPanel');
            const currentEventInfo = document.getElementById('currentEventInfo');
            
            if (eventInfoPanel && currentEventInfo && eventName) {
                eventInfoPanel.style.display = 'block';
                currentEventInfo.innerHTML = `
                    <strong>${eventName}</strong><br>
                    Gest√£o de Dispositivos F√≠sicos
                `;
            }
        }
        
        async function loadDevices() {
            try {
                console.log('üìã loadDevices: Iniciando...');
                console.log('üìã Event ID:', currentEvent.id);
                
                // Update debug info
                if (document.getElementById('debugEventId')) {
                    document.getElementById('debugEventId').textContent = currentEvent.id;
                }
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.error('‚ùå Supabase n√£o dispon√≠vel');
                    if (document.getElementById('debugQueryStatus')) {
                        document.getElementById('debugQueryStatus').textContent = 'Supabase n√£o conectado';
                        document.getElementById('debugQueryStatus').style.color = 'var(--danger)';
                    }
                    showError('Supabase n√£o dispon√≠vel');
                    return;
                }
                
                console.log('‚úÖ Supabase dispon√≠vel, fazendo query...');
                console.log('üìä Query: SELECT * FROM event_devices WHERE event_id = ' + currentEvent.id);
                
                // Tentar query simples primeiro
                const { data: testData, error: testError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('*')
                    .eq('event_id', currentEvent.id);
                
                console.log('üß™ Teste query simples:');
                console.log('   Data:', testData);
                console.log('   Error:', testError);
                console.log('   Count:', testData?.length || 0);
                
                if (testError) {
                    console.error('‚ùå Erro em query simples - Poss√≠vel problema de RLS!');
                    showError('Erro de permiss√µes. Execute fix-rls-policies.sql no Supabase.');
                    return;
                }
                
                // Agora query com JOIN
                const { data: devices, error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select(`
                        *,
                        devices (
                            id,
                            device_name,
                            device_type,
                            status,
                            last_seen
                        ),
                        events (
                            id,
                            name
                        )
                    `)
                    .eq('event_id', currentEvent.id)
                    .order('checkpoint_order', { ascending: true, nullsLast: true });
                
                console.log('üìä Resultado da query:');
                console.log('  - Error:', error);
                console.log('  - Devices:', devices);
                console.log('  - Quantidade:', devices?.length || 0);
                
                // Update debug info
                if (document.getElementById('debugQueryStatus')) {
                    document.getElementById('debugQueryStatus').textContent = error ? `Erro: ${error.message}` : 'Success';
                    document.getElementById('debugQueryStatus').style.color = error ? 'var(--danger)' : 'var(--success)';
                }
                if (document.getElementById('debugDeviceCount')) {
                    document.getElementById('debugDeviceCount').textContent = devices?.length || 0;
                    document.getElementById('debugDeviceCount').style.color = (devices?.length || 0) > 0 ? 'var(--success)' : 'var(--danger)';
                }
                
                if (error) {
                    console.error('‚ùå Erro na query:', error);
                    throw error;
                }
                
                // Log detalhado de cada dispositivo
                if (devices && devices.length > 0) {
                    console.log('üì± Dispositivos encontrados:');
                    devices.forEach((d, i) => {
                        console.log(`  ${i+1}. UUID: ${d.device_id}`);
                        console.log(`     Nome: ${d.devices?.device_name || 'N/A'}`);
                        console.log(`     Role: ${d.role}`);
                        console.log(`     Associado: ${d.assigned_at}`);
                    });
                } else {
                    console.log('‚ö†Ô∏è Nenhum dispositivo encontrado em event_devices para este evento');
                    console.log('üí° Execute no Supabase SQL:');
                    console.log(`   SELECT * FROM event_devices WHERE event_id = '${currentEvent.id}';`);
                }
                
                console.log('‚úÖ Renderizando', devices?.length || 0, 'dispositivos');
                renderDevices(devices || []);
                
                // Gerar QR Codes automaticamente para todos os dispositivos
                setTimeout(() => {
                    devices?.forEach((device) => {
                        if (device.device_id && device.device_pin) {
                            generateInlineQRCode(device.device_id, device.device_pin, device.devices?.device_name || 'Dispositivo');
                        }
                    });
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dispositivos:', error);
                showError(`Erro ao carregar: ${error.message}`);
            }
        }
        
        function renderDevices(devices) {
            const grid = document.getElementById('devicesGrid');
            const container = document.getElementById('devicesContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (devices.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            grid.innerHTML = devices.map((device, index) => {
                const deviceInfo = device.devices || {};
                
                // Extrair nome original (remover sufixo _EventID_Timestamp)
                let displayName = deviceInfo.device_name || 'Dispositivo';
                const nameParts = displayName.split('_');
                if (nameParts.length >= 3) {
                    // Se tem formato Nome_EventID_Timestamp, pegar s√≥ o Nome
                    displayName = nameParts.slice(0, -2).join('_');
                }
                
                return `
                <div class="device-card">
                    <div class="device-header">
                        <div>
                            <div class="device-title">üì± ${displayName}</div>
                            <div class="device-id">UUID: ${device.device_id.substring(0, 12)}...</div>
                        </div>
                        <span class="device-status status-offline">
                            Offline
                        </span>
                    </div>
                    
                    <div class="device-info">
                        <div class="info-item">
                            <div class="info-label">Tipo</div>
                            <div class="info-value">${deviceInfo.device_type || 'mobile'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">PIN</div>
                            <div class="info-value">${device.device_pin ? 'üîê ****' : 'üîì Sem PIN'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Checkpoint</div>
                            <div class="info-value">
                                ${device.checkpoint_name || 'N/A'}
                                ${device.checkpoint_order ? ` (#${device.checkpoint_order})` : ''}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Tipo Checkpoint</div>
                            <div class="info-value">
                                ${getCheckpointTypeLabel(device.checkpoint_type)}
                                ${device.checkpoint_type === 'intermediate' || device.checkpoint_type === 'finish' ? ' (Conta voltas)' : ' (N√£o conta voltas)'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informa√ß√µes do Evento -->
                    <div style="margin-top: var(--spacing-3); padding: var(--spacing-3); background: var(--bg-primary); border-radius: var(--radius-base); border: 1px solid var(--border-color);">
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: var(--spacing-2);">
                            <strong>Evento:</strong> ${device.events?.name || currentEvent.name || 'N/A'}
                        </div>
                    </div>
                    
                    <!-- QR Code ao lado de Role e Sess√µes -->
                    <div style="margin-top: var(--spacing-4); padding-top: var(--spacing-4); border-top: 1px solid var(--border-color); display: flex; align-items: flex-start; gap: var(--spacing-4);">
                        <!-- QR Code -->
                        <div style="flex-shrink: 0;">
                            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: var(--spacing-2); text-align: center;">üì± QR Code</div>
                            <div id="qrCodeInline-${device.device_id}" style="display: inline-block; padding: var(--spacing-2); background: white; border-radius: var(--radius-base);"></div>
                        </div>
                        <!-- Role e Sess√µes -->
                        <div style="flex: 1; display: flex; flex-direction: column; gap: var(--spacing-3);">
                            <div class="info-item">
                                <div class="info-label">Role</div>
                                <div class="info-value">${device.role || 'detector'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Sess√µes</div>
                                <div class="info-value">
                                    <span style="color: ${(device.active_sessions || 0) >= (device.max_sessions || 1) ? 'var(--danger)' : 'var(--success)'}">
                                        ${device.active_sessions || 0}/${device.max_sessions || 1}
                                    </span>
                                    <button onclick="editMaxSessions('${device.device_id}', ${device.max_sessions || 1})" 
                                        style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; margin-left: 4px;" 
                                        title="Alterar limite de sess√µes">
                                        ‚úèÔ∏è
                                    </button>
                                </div>
                            </div>
                            <div class="info-item" style="margin-top: var(--spacing-2);">
                                <div class="info-label">C√≥digo de Acesso</div>
                                <div class="info-value" style="font-family: var(--font-family-mono); font-weight: 700; letter-spacing: 2px;">
                                    ${device.access_code || 'Gerando...'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- URL de Detec√ß√£o -->
                    <div style="margin-top: var(--spacing-4); padding-top: var(--spacing-4); border-top: 1px solid var(--border-color);">
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: var(--spacing-2);">üîó Link de Detec√ß√£o:</div>
                        <input type="text" readonly value="${window.location.origin}/detection?event=${currentEvent.id}&device=${device.device_id}&eventName=${encodeURIComponent(currentEvent.name)}" 
                            id="deviceUrl-${device.device_id}"
                            style="width: 100%; padding: var(--spacing-2); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-base); color: var(--text-primary); font-size: var(--font-size-xs); font-family: var(--font-family-mono); margin-bottom: var(--spacing-2);">
                        <div style="display: flex; gap: var(--spacing-2);">
                            <button class="btn btn-sm btn-primary" onclick="openDetection('${device.device_id}')">
                                <i>üì±</i> Abrir Detec√ß√£o
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="copyDeviceUrl('${device.device_id}')">
                                <i>üìã</i> Copiar URL
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="showDeviceQRCode('${device.device_id}', '${device.device_pin || ''}', '${displayName}')" style="margin-top: var(--spacing-2);">
                                <i>üì±</i> Ver QR Code
                            </button>
                        </div>
                    </div>
                    
                    <div class="device-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editDevicePin('${device.device_id}', '${device.device_pin || ''}')">
                            <i>üîê</i> ${device.device_pin ? 'Alterar PIN' : 'Definir PIN'}
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="clearDeviceSessions('${device.device_id}')" 
                            ${(device.active_sessions || 0) === 0 ? 'disabled' : ''}>
                            <i>üßπ</i> Limpar Sess√µes ${(device.active_sessions || 0) > 0 ? `(${device.active_sessions})` : ''}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeDevice('${device.device_id}')">
                            <i>üóëÔ∏è</i> Remover
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function showAddDeviceModal() {
            const deviceName = prompt('Digite o nome do dispositivo (ex: iPhone de Jo√£o, Samsung Galaxy):');
            
            if (!deviceName || deviceName.trim() === '') {
                showError('Nome do dispositivo √© obrigat√≥rio');
                return;
            }
            
            const devicePin = prompt('Digite um PIN de seguran√ßa (4-6 d√≠gitos):');
            
            if (!devicePin || devicePin.trim() === '') {
                showError('PIN √© obrigat√≥rio para seguran√ßa');
                return;
            }
            
            // Validar PIN (4-6 d√≠gitos)
            if (!/^\d{4,6}$/.test(devicePin)) {
                showError('PIN deve ter 4 a 6 d√≠gitos num√©ricos');
                return;
            }
            
            const maxSessions = prompt('Quantas sess√µes simult√¢neas permitir? (1-10):', '1');
            
            if (!maxSessions || isNaN(parseInt(maxSessions))) {
                showError('N√∫mero de sess√µes inv√°lido');
                return;
            }
            
            const sessionsLimit = parseInt(maxSessions);
            if (sessionsLimit < 1 || sessionsLimit > 10) {
                showError('N√∫mero de sess√µes deve ser entre 1 e 10');
                return;
            }
            
            addDevice(deviceName.trim(), devicePin, sessionsLimit);
        }
        
        async function addDevice(deviceName, devicePin, maxSessions) {
            try {
                console.log('üîÑ Iniciando adi√ß√£o de dispositivo:', deviceName);
                console.log('üîó Event ID:', currentEvent.id);
                console.log('üîê PIN definido:', devicePin ? '****' : 'Nenhum');
                console.log('üìä Max sess√µes:', maxSessions);
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    showError('Supabase n√£o conectado. Aguarde e tente novamente.');
                    return;
                }
                
                console.log('‚úÖ Supabase conectado');
                
                // Criar nome √∫nico global (event-specific)
                // Formato: "Nome_EventID_Timestamp" garante unicidade
                const uniqueDeviceName = `${deviceName}_${currentEvent.id.substring(0, 8)}_${Date.now()}`;
                
                console.log('üìù Criando dispositivo com nome √∫nico:', uniqueDeviceName);
                
                // Criar novo dispositivo espec√≠fico para este evento
                const { data: newDevice, error: deviceError } = await window.supabaseClient.supabase
                    .from('devices')
                    .insert([{
                        device_name: uniqueDeviceName, // Nome √∫nico globalmente
                        device_type: 'mobile',
                        status: 'active'
                    }])
                    .select()
                    .single();
                
                if (deviceError) {
                    console.error('‚ùå Erro ao criar device:', deviceError);
                    throw deviceError;
                }
                
                console.log('‚úÖ Dispositivo criado:', newDevice);
                console.log('üÜî UUID gerado:', newDevice.id);
                
                // Associar ao evento
                console.log('üîó Associando ao evento...');
                console.log('üìä Dados a inserir em event_devices:');
                console.log('   event_id:', currentEvent.id);
                console.log('   device_id:', newDevice.id);
                console.log('   role: detector');
                
                // O access_code ser√° gerado automaticamente pelo trigger no banco
                // Mas podemos tentar gerar manualmente se necess√°rio
                const { data: assocData, error: assocError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .insert([{
                        event_id: currentEvent.id,
                        device_id: newDevice.id,
                        role: 'detector',
                        device_pin: devicePin,
                        max_sessions: maxSessions || 1,
                        active_sessions: 0
                        // access_code ser√° gerado automaticamente pelo trigger
                    }])
                    .select();
                
                console.log('üìä Resultado do INSERT em event_devices:');
                console.log('   Data:', assocData);
                console.log('   Error:', assocError);
                
                if (assocError) {
                    console.error('‚ùå Erro ao associar:', assocError);
                    console.error('   Code:', assocError.code);
                    console.error('   Message:', assocError.message);
                    console.error('   Details:', assocError.details);
                    throw assocError;
                }
                
                if (assocData && assocData.length > 0) {
                    console.log('‚úÖ Dispositivo associado ao evento!');
                    console.log('‚úÖ Registro criado:', assocData[0]);
                    console.log('   ID:', assocData[0].id);
                    console.log('   event_id:', assocData[0].event_id);
                    console.log('   device_id:', assocData[0].device_id);
                } else {
                    console.warn('‚ö†Ô∏è INSERT retornou sem erro mas sem dados');
                }
                
                // Verificar se foi realmente salvo (double-check)
                console.log('üîç Verificando se foi realmente salvo...');
                const { data: verification, error: verifyError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', newDevice.id)
                    .single();
                
                console.log('üîç Verifica√ß√£o:');
                console.log('   Data:', verification);
                console.log('   Error:', verifyError);
                
                if (verification) {
                    console.log('‚úÖ‚úÖ CONFIRMADO: Dispositivo est√° em event_devices!');
                } else {
                    console.error('‚ùå‚ùå PROBLEMA: Dispositivo N√ÉO est√° em event_devices!');
                    console.error('   Poss√≠vel problema de RLS (Row Level Security)');
                }
                
                showSuccess(`Dispositivo "${deviceName}" adicionado ao evento com sucesso!`);
                
                // Recarregar lista (QR Code ser√° gerado automaticamente inline no card)
                console.log('üîÑ Recarregando lista de dispositivos...');
                await loadDevices();
                console.log('‚úÖ Lista recarregada')
                
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                showError(`Erro: ${error.message || error.code || 'Desconhecido'}`);
            }
        }
        
        async function editMaxSessions(deviceId, currentMax) {
            const newMax = prompt(`Quantas sess√µes simult√¢neas permitir? (1-10):`, currentMax || '1');
            
            if (newMax === null) return;
            
            const maxSessions = parseInt(newMax);
            
            if (isNaN(maxSessions) || maxSessions < 1 || maxSessions > 10) {
                showError('N√∫mero de sess√µes deve ser entre 1 e 10');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .update({ max_sessions: maxSessions })
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId);
                
                if (error) throw error;
                
                showSuccess(`Limite de sess√µes atualizado para ${maxSessions}!`);
                await loadDevices();
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar limite:', error);
                showError('Erro ao atualizar');
            }
        }
        
        async function editDevicePin(deviceId, currentPin) {
            const newPin = prompt(`${currentPin ? 'Alterar' : 'Definir'} PIN de seguran√ßa (4-6 d√≠gitos):`, currentPin || '');
            
            if (newPin === null) return; // Cancelado
            
            // Validar PIN
            if (newPin.trim() !== '' && !/^\d{4,6}$/.test(newPin)) {
                showError('PIN deve ter 4 a 6 d√≠gitos num√©ricos');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .update({ device_pin: newPin.trim() || null })
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId);
                
                if (error) throw error;
                
                if (newPin.trim()) {
                    showSuccess('PIN atualizado com sucesso!');
                } else {
                    showSuccess('PIN removido');
                }
                
                await loadDevices();
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar PIN:', error);
                showError('Erro ao atualizar PIN');
            }
        }
        
        function openDetection(deviceId) {
            const url = `/detection?event=${currentEvent.id}&device=${deviceId}&eventName=${encodeURIComponent(currentEvent.name)}`;
            window.open(url, '_blank');
        }
        
        function copyDeviceUrl(deviceId) {
            const input = document.getElementById(`deviceUrl-${deviceId}`);
            if (input) {
                input.select();
                document.execCommand('copy');
                showSuccess('URL copiado para √°rea de transfer√™ncia!');
            }
        }
        
        async function clearDeviceSessions(deviceId) {
            const confirmMessage = `‚ö†Ô∏è ATEN√á√ÉO! Isto ir√° encerrar TODAS as sess√µes ativas deste dispositivo.

Todos os operadores ativos ser√£o desconectados e ter√£o que inserir o PIN novamente.

Esta a√ß√£o √© √∫til quando:
‚Ä¢ Dispositivos ficaram "presos" (sess√µes n√£o encerraram)
‚Ä¢ Precisa libertar slots urgentemente
‚Ä¢ Quer resetar acessos

Digite "LIMPAR" (em mai√∫sculas) para confirmar:`;
            
            let confirmation;
            try {
                confirmation = prompt(confirmMessage);
            } catch (error) {
                console.error('Erro ao mostrar prompt:', error);
                return;
            }
            
            if (!confirmation || confirmation !== 'LIMPAR') {
                if (confirmation !== null) { // S√≥ mostrar erro se n√£o foi cancelado
                    showError('Limpeza cancelada. Digite exatamente "LIMPAR" para confirmar.');
                }
                return;
            }
            
            if (!window.supabaseClient || !window.supabaseClient.supabase) {
                console.error('‚ùå Supabase n√£o dispon√≠vel');
                showError('Supabase n√£o dispon√≠vel');
                return;
            }
            
            try {
                console.log('üßπ Limpando sess√µes do dispositivo:', deviceId);
                
                // 1. Marcar todas as sess√µes como inativas (com timeout)
                let sessionError = null;
                try {
                    const queryPromise = window.supabaseClient.supabase
                        .from('device_sessions')
                        .update({ 
                            is_active: false,
                            ended_at: new Date().toISOString()
                        })
                        .eq('device_id', deviceId)
                        .eq('event_id', currentEvent.id);
                    
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 5000)
                    );
                    
                    const result = await Promise.race([queryPromise, timeoutPromise]);
                    sessionError = result.error;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro/timeout ao atualizar device_sessions:', error);
                    sessionError = error;
                }
                
                // Ignorar se tabela n√£o existe ou timeout
                if (sessionError && sessionError.code !== '42P01' && sessionError.message !== 'Timeout') {
                    console.warn('‚ö†Ô∏è Erro ao atualizar device_sessions:', sessionError);
                }
                
                // 2. Resetar contador active_sessions para 0 (com timeout)
                console.log('üîÑ Resetando contador de sess√µes...');
                try {
                    const updatePromise = window.supabaseClient.supabase
                        .from('event_devices')
                        .update({ active_sessions: 0 })
                        .eq('event_id', currentEvent.id)
                        .eq('device_id', deviceId);
                    
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 5000)
                    );
                    
                    const result = await Promise.race([updatePromise, timeoutPromise]);
                    
                    if (result.error) {
                        console.error('‚ùå Erro ao resetar sess√µes:', result.error);
                        throw result.error;
                    }
                } catch (error) {
                    if (error.message === 'Timeout') {
                        console.error('‚ùå Timeout ao atualizar event_devices');
                        showError('Timeout ao limpar sess√µes. Tente novamente.');
                        return;
                    }
                    throw error;
                }
                
                console.log('‚úÖ Sess√µes limpas com sucesso');
                
                // Mostrar sucesso SEM recarregar a p√°gina (evita loop)
                showSuccess('Todas as sess√µes foram encerradas! Operadores ter√£o que inserir PIN novamente.');
                
                // Recarregar dispositivos ap√≥s um delay
                setTimeout(async () => {
                    try {
                        await loadDevices();
                    } catch (error) {
                        console.error('Erro ao recarregar dispositivos:', error);
                    }
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Erro ao limpar sess√µes:', error);
                showError(`Erro ao limpar sess√µes: ${error.message || 'Erro desconhecido'}`);
            }
        }
        
        async function removeDevice(deviceId) {
            if (!confirm(`Tem certeza que deseja remover o dispositivo ${deviceId}?`)) {
                return;
            }
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .delete()
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId);
                
                if (error) throw error;
                
                showSuccess('Dispositivo removido!');
                await loadDevices();
                
            } catch (error) {
                console.error('‚ùå Erro ao remover dispositivo:', error);
                showError('Erro ao remover dispositivo');
            }
        }
        
        // Fun√ß√£o para gerar c√≥digo √∫nico (m√©todo alternativo client-side)
        async function generateUniqueAccessCode(deviceId) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Semelhantes removidos
            let attempts = 0;
            const maxAttempts = 50;
            
            while (attempts < maxAttempts) {
                // Gerar c√≥digo aleat√≥rio de 6 caracteres
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                
                // Verificar se c√≥digo j√° existe no banco
                try {
                    const { data, error } = await window.supabaseClient.supabase
                        .from('event_devices')
                        .select('access_code')
                        .eq('access_code', code)
                        .maybeSingle();
                    
                    if (error && error.code !== 'PGRST116') { // PGRST116 = not found (esperado)
                        console.warn('‚ö†Ô∏è Erro ao verificar c√≥digo:', error);
                        attempts++;
                        continue;
                    }
                    
                    // Se n√£o encontrou (c√≥digo √∫nico), salvar no dispositivo
                    if (!data) {
                        const { error: updateError } = await window.supabaseClient.supabase
                            .from('event_devices')
                            .update({ access_code: code })
                            .eq('event_id', currentEvent.id)
                            .eq('device_id', deviceId);
                        
                        if (!updateError) {
                            console.log('‚úÖ C√≥digo √∫nico gerado:', code);
                            return code;
                        } else {
                            console.warn('‚ö†Ô∏è Erro ao salvar c√≥digo:', updateError);
                        }
                    }
                } catch (checkError) {
                    console.warn('‚ö†Ô∏è Erro ao verificar unicidade:', checkError);
                }
                
                attempts++;
            }
            
            console.error('‚ùå N√£o foi poss√≠vel gerar c√≥digo √∫nico ap√≥s', maxAttempts, 'tentativas');
            return null;
        }
        
        async function showDeviceQRCode(deviceId, devicePin, deviceName) {
            // Buscar ou gerar access_code do dispositivo (mesma l√≥gica do generateInlineQRCode)
            let accessCode = null;
            try {
                const { data: deviceData, error: fetchError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('access_code')
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId)
                    .single();
                
                if (deviceData && !fetchError && deviceData.access_code) {
                    accessCode = deviceData.access_code;
                    console.log('‚úÖ C√≥digo de acesso existente:', accessCode);
                } else {
                    // Gerar novo c√≥digo
                    console.log('üîÑ Gerando novo c√≥digo de acesso...');
                    accessCode = await generateUniqueAccessCode(deviceId);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao buscar/gerar access_code:', error);
                accessCode = await generateUniqueAccessCode(deviceId);
            }
            
            // Criar URL de detec√ß√£o para o QR Code (mais f√°cil de usar no scanner)
            const detectionURL = `${window.location.origin}/detection-kromi.html?event=${currentEvent.id}&device=${deviceId}&eventName=${encodeURIComponent(currentEvent.name || '')}`;
            
            // Criar string para o QR Code (URL em vez de JSON)
            const qrDataString = detectionURL;
            
            console.log('üì± Gerando QR Code com URL:', qrDataString);
            
            // Criar modal com QR Code
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-5); max-width: 500px; width: 90%; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4);">
                        <h2 style="margin: 0; color: var(--text-primary);">üì± QR Code do Dispositivo</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">√ó</button>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: var(--spacing-4);">
                        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-3);">
                            Escaneie este QR Code na p√°gina de detections para autenticar automaticamente:
                        </p>
                        <div id="qrCodeContainer-${deviceId}" style="display: inline-block; padding: var(--spacing-4); background: white; border-radius: var(--radius-base); margin: var(--spacing-3) 0;"></div>
                        
                        <div style="margin-top: var(--spacing-3); padding: var(--spacing-3); background: var(--bg-primary); border-radius: var(--radius-base); border: 1px solid var(--border-color);">
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--spacing-2);">Dispositivo:</div>
                            <div style="font-weight: 600; color: var(--text-primary);">${deviceName}</div>
                            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-top: var(--spacing-2); font-family: var(--font-family-mono);">
                                PIN: ${devicePin}
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid var(--border-color); padding-top: var(--spacing-4);">
                        <p style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--spacing-3);">
                            <strong>Como usar:</strong>
                        </p>
                        <ol style="font-size: var(--font-size-sm); color: var(--text-secondary); padding-left: var(--spacing-5); margin: 0;">
                            <li style="margin-bottom: var(--spacing-2);">Acesse a p√°gina de detections</li>
                            <li style="margin-bottom: var(--spacing-2);">Ative o scanner de QR Code</li>
                            <li style="margin-bottom: var(--spacing-2);">Escaneie este c√≥digo</li>
                            <li>Voc√™ ser√° redirecionado automaticamente para a detec√ß√£o</li>
                        </ol>
                    </div>
                    
                    <div style="margin-top: var(--spacing-4); display: flex; gap: var(--spacing-2);">
                        <button class="btn btn-primary" onclick="copyQRData('${deviceId}')" style="flex: 1;">
                            <i>üìã</i> Copiar Dados
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="flex: 1;">
                            <i>‚úï</i> Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Gerar QR Code usando QRCode.js
            function generateQR() {
                const container = document.getElementById(`qrCodeContainer-${deviceId}`);
                if (!container) {
                    setTimeout(generateQR, 100);
                    return;
                }
                
                // Limpar container
                container.innerHTML = '';
                
                // Verificar se a biblioteca est√° dispon√≠vel
                if (typeof QRCode !== 'undefined') {
                    try {
                        console.log('üì± Gerando QR Code com qrcodejs...');
                        // Criar QR Code usando qrcodejs
                                new QRCode(container, {
                                    text: qrDataString,
                                    width: 256,
                                    height: 256,
                                    colorDark: '#000000',
                                    colorLight: '#ffffff',
                                    correctLevel: QRCode.CorrectLevel.L // L = Mais r√°pido de detectar
                                });
                        
                        console.log('‚úÖ QR Code gerado com sucesso');
                        
                        // Armazenar dados para c√≥pia
                        container.dataset.qrData = qrDataString;
                    } catch (error) {
                        console.error('‚ùå Erro ao gerar QR Code:', error);
                        container.innerHTML = '<p style="color: var(--danger); padding: 20px;">Erro: ' + (error.message || 'Desconhecido') + '</p>';
                    }
                } else {
                    console.warn('‚ö†Ô∏è QRCode library n√£o dispon√≠vel ainda...');
                    // Aguardar evento de carregamento ou tentar novamente
                    let attempts = 0;
                    const checkQRCode = () => {
                        attempts++;
                        if (typeof QRCode !== 'undefined') {
                            generateQR();
                        } else if (attempts < 30) {
                            setTimeout(checkQRCode, 200);
                        } else {
                            container.innerHTML = '<p style="color: var(--danger); padding: 20px;">Biblioteca QR Code n√£o carregou. Recarregue a p√°gina.</p>';
                        }
                    };
                    
                    // Aguardar evento de carregamento
                    window.addEventListener('qrcodeLoaded', generateQR, { once: true });
                    // Tamb√©m tentar verificar periodicamente
                    setTimeout(checkQRCode, 200);
                }
            }
            
            // Aguardar um pouco para garantir que a biblioteca carregou
            setTimeout(generateQR, 500);
        }
        
        async function generateInlineQRCode(deviceId, devicePin, deviceName) {
            // Buscar ou gerar access_code do dispositivo
            let accessCode = null;
            try {
                // Primeiro, verificar se j√° existe um c√≥digo
                const { data: deviceData, error: fetchError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('access_code')
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId)
                    .single();
                
                if (deviceData && !fetchError && deviceData.access_code) {
                    accessCode = deviceData.access_code;
                    console.log('‚úÖ C√≥digo de acesso existente encontrado:', accessCode);
                } else {
                    // Gerar novo c√≥digo usando fun√ß√£o RPC do banco
                    console.log('üîÑ Gerando novo c√≥digo de acesso...');
                    try {
                        const { data: generatedCode, error: generateError } = await window.supabaseClient.supabase
                            .rpc('generate_access_code');
                        
                        if (generateError || !generatedCode) {
                            console.warn('‚ö†Ô∏è Erro ao gerar c√≥digo via RPC, tentando m√©todo alternativo...');
                            // M√©todo alternativo: gerar c√≥digo client-side e validar no banco
                            accessCode = await generateUniqueAccessCode(deviceId);
                        } else {
                            accessCode = generatedCode;
                            // Salvar no banco
                            const { error: updateError } = await window.supabaseClient.supabase
                                .from('event_devices')
                                .update({ access_code: accessCode })
                                .eq('event_id', currentEvent.id)
                                .eq('device_id', deviceId);
                            
                            if (updateError) {
                                console.error('‚ùå Erro ao salvar c√≥digo:', updateError);
                            } else {
                                console.log('‚úÖ C√≥digo gerado e salvo:', accessCode);
                            }
                        }
                    } catch (rpcError) {
                        console.warn('‚ö†Ô∏è RPC n√£o dispon√≠vel, usando m√©todo alternativo...');
                        accessCode = await generateUniqueAccessCode(deviceId);
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao buscar/gerar access_code:', error);
                // Tentar gerar c√≥digo alternativo
                accessCode = await generateUniqueAccessCode(deviceId);
            }
            
            // Criar URL de detec√ß√£o para o QR Code (mais f√°cil de usar no scanner)
            const detectionURL = `${window.location.origin}/detection-kromi.html?event=${currentEvent.id}&device=${deviceId}&eventName=${encodeURIComponent(currentEvent.name || '')}`;
            
            // Criar string para o QR Code (URL em vez de JSON)
            const qrDataString = detectionURL;
            
            console.log('üì± Gerando QR Code inline com URL:', qrDataString);
            
            // Obter container inline
            const container = document.getElementById(`qrCodeInline-${deviceId}`);
            if (!container) {
                console.warn('Container de QR Code inline n√£o encontrado para:', deviceId);
                return;
            }
            
            // Limpar container
            container.innerHTML = '';
            
            // Verificar se a biblioteca est√° dispon√≠vel
            if (typeof QRCode !== 'undefined') {
                try {
                            // Criar QR Code usando qrcodejs (n√≠vel L para detec√ß√£o mais r√°pida)
                            new QRCode(container, {
                                text: qrDataString,
                                width: 120,
                                height: 120,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.L // L = Mais r√°pido de detectar (menos redund√¢ncia)
                            });
                    
                    // Armazenar dados para poss√≠vel c√≥pia
                    container.dataset.qrData = qrDataString;
                    
                    console.log(`‚úÖ QR Code inline gerado para dispositivo ${deviceId.substring(0, 8)}...`);
                } catch (error) {
                    console.error('‚ùå Erro ao gerar QR Code inline:', error);
                    container.innerHTML = '<span style="color: var(--danger); font-size: 10px;">Erro</span>';
                }
            } else {
                // Aguardar biblioteca carregar
                const checkQRCode = () => {
                    if (typeof QRCode !== 'undefined') {
                        try {
                            new QRCode(container, {
                                text: qrDataString,
                                width: 120,
                                height: 120,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H
                            });
                            container.dataset.qrData = qrDataString;
                        } catch (error) {
                            container.innerHTML = '<span style="color: var(--danger); font-size: 10px;">Erro</span>';
                        }
                    } else {
                        setTimeout(checkQRCode, 100);
                    }
                };
                
                // Aguardar evento de carregamento ou tentar periodicamente
                window.addEventListener('qrcodeLoaded', () => {
                    if (typeof QRCode !== 'undefined') {
                        try {
                            new QRCode(container, {
                                text: qrDataString,
                                width: 120,
                                height: 120,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H
                            });
                            container.dataset.qrData = qrDataString;
                        } catch (error) {
                            container.innerHTML = '<span style="color: var(--danger); font-size: 10px;">Erro</span>';
                        }
                    }
                }, { once: true });
                
                setTimeout(checkQRCode, 200);
            }
        }
        
        function getCheckpointTypeLabel(type) {
            const types = {
                'start': 'üèÅ In√≠cio',
                'finish': 'üèÅ Meta',
                'intermediate': 'üìç Interm√©dio',
                'timing': '‚è±Ô∏è Cronometragem',
                'control': '‚úì Controlo',
                'aid_station': 'üíß Abastecimento'
            };
            return types[type] || type || 'N/A';
        }
        
        function copyQRData(deviceId) {
            const container = document.getElementById(`qrCodeContainer-${deviceId}`);
            if (container && container.dataset.qrData) {
                navigator.clipboard.writeText(container.dataset.qrData).then(() => {
                    showSuccess('Dados do QR Code copiados!');
                }).catch(() => {
                    showError('Erro ao copiar dados');
                });
            }
        }
        
        // Fun√ß√£o para limpar texto (remover emojis e caracteres especiais problem√°ticos)
        function cleanTextForPDF(text) {
            if (!text) return '';
            
            // Converter para string
            let cleaned = String(text);
            
            // Remover emojis e s√≠mbolos especiais
            cleaned = cleaned.replace(/[\u{1F300}-\u{1F9FF}]/gu, ''); // Emojis gerais
            cleaned = cleaned.replace(/[\u{2600}-\u{26FF}]/gu, ''); // S√≠mbolos diversos
            cleaned = cleaned.replace(/[\u{2700}-\u{27BF}]/gu, ''); // S√≠mbolos diversos
            cleaned = cleaned.replace(/[üì±üèÅüìç‚è±Ô∏è‚úìüíßüîêüîì]/g, ''); // Emojis espec√≠ficos
            
            // Remover tags HTML se houver
            cleaned = cleaned.replace(/<[^>]*>/g, '');
            
            // Limpar espa√ßos extras
            cleaned = cleaned.trim().replace(/\s+/g, ' ');
            
            return cleaned;
        }
        
        // Fun√ß√£o para obter label do tipo de checkpoint sem emoji
        function getCheckpointTypeLabelForPDF(type) {
            const types = {
                'start': 'Inicio',
                'finish': 'Meta',
                'intermediate': 'Intermedio',
                'timing': 'Cronometragem',
                'control': 'Controlo',
                'aid_station': 'Abastecimento'
            };
            return types[type] || type || 'N/A';
        }
        
        async function generateDevicesPDF() {
            try {
                console.log('üìÑ Iniciando gera√ß√£o de PDF...');
                
                // Obter todos os dispositivos renderizados
                const deviceCards = document.querySelectorAll('.device-card');
                if (deviceCards.length === 0) {
                    showError('Nenhum dispositivo para gerar PDF');
                    return;
                }
                
                // Mostrar loading
                const loadingMsg = 'Gerando PDF... Aguarde.';
                showSuccess(loadingMsg);
                
                // Usar jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });
                
                // Habilitar UTF-8 (importante para caracteres especiais)
                doc.setLanguage('pt');
                
                // Configura√ß√µes
                const pageWidth = 210; // A4 width em mm
                const pageHeight = 297; // A4 height em mm
                const margin = 10;
                const contentWidth = pageWidth - (margin * 2);
                let yPos = margin;
                
                // T√≠tulo (limpar texto)
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(cleanTextForPDF('Dispositivos - VisionKrono'), margin, yPos);
                yPos += 10;
                
                // Informa√ß√µes do evento (limpar texto)
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const eventNameClean = cleanTextForPDF(currentEvent.name || currentEvent.id.substring(0, 20) + '...');
                doc.text(`Evento: ${eventNameClean}`, margin, yPos);
                yPos += 8;
                doc.text(`Data: ${new Date().toLocaleDateString('pt-PT')}`, margin, yPos);
                yPos += 12;
                
                // Linha separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 8;
                
                // Buscar dados completos dos dispositivos do banco para ter informa√ß√µes atualizadas
                const { data: devicesData, error: devicesError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select(`
                        *,
                        devices (
                            device_name
                        ),
                        events (
                            name
                        )
                    `)
                    .eq('event_id', currentEvent.id)
                    .order('checkpoint_order', { ascending: true, nullsLast: true });
                
                if (devicesError) {
                    console.error('Erro ao buscar dados dos dispositivos:', devicesError);
                }
                
                // Criar mapa de dispositivos por ID para acesso r√°pido
                const devicesMap = new Map();
                if (devicesData) {
                    devicesData.forEach(d => {
                        devicesMap.set(d.device_id, d);
                    });
                }
                
                // Iterar pelos dispositivos
                for (let i = 0; i < deviceCards.length; i++) {
                    const card = deviceCards[i];
                    const deviceId = card.querySelector('[id^="qrCodeInline-"]')?.id.replace('qrCodeInline-', '');
                    
                    if (!deviceId) continue;
                    
                    // Buscar dados do dispositivo
                    const deviceData = devicesMap.get(deviceId);
                    
                    // Obter informa√ß√µes do dispositivo (limpar todos os textos)
                    const deviceTitleRaw = card.querySelector('.device-title')?.textContent?.replace('üì±', '').trim() || deviceData?.devices?.device_name || 'Dispositivo';
                    const deviceTitle = cleanTextForPDF(deviceTitleRaw);
                    
                    const roleText = cleanTextForPDF(deviceData?.role || 'detector');
                    const sessionsText = `${deviceData?.active_sessions || 0}/${deviceData?.max_sessions || 1}`;
                    const pinText = deviceData?.device_pin ? '****' : 'Sem PIN';
                    
                    // Informa√ß√µes do checkpoint (do banco de dados, limpar texto)
                    const checkpointName = cleanTextForPDF(deviceData?.checkpoint_name || 'N/A');
                    const checkpointOrder = deviceData?.checkpoint_order || null;
                    const checkpointType = deviceData?.checkpoint_type || null;
                    const checkpointText = `${checkpointName}${checkpointOrder ? ` (#${checkpointOrder})` : ''}`;
                    
                    // Verificar se conta voltas (intermediate e finish contam voltas)
                    const contaVoltas = checkpointType === 'intermediate' || checkpointType === 'finish';
                    const checkpointTypeLabel = getCheckpointTypeLabelForPDF(checkpointType);
                    const checkpointTypeText = `${checkpointTypeLabel} (${contaVoltas ? 'Conta voltas' : 'Nao conta voltas'})`;
                    
                    // Obter nome do evento (do banco, limpar texto)
                    const eventNameText = cleanTextForPDF(deviceData?.events?.name || currentEvent.name || 'N/A');
                    
                    // Verificar se precisa de nova p√°gina (deixar espa√ßo para pr√≥ximo dispositivo)
                    if (yPos > pageHeight - 60) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    // Layout linha a linha: QR Code √† esquerda, informa√ß√µes √† direita
                    const qrSize = 40; // Tamanho do QR Code (mm)
                    const infoStartX = margin + qrSize + 8; // In√≠cio das informa√ß√µes (ap√≥s QR Code)
                    const infoWidth = pageWidth - infoStartX - margin; // Largura dispon√≠vel para informa√ß√µes
                    
                    // Verificar se precisa de nova p√°gina (deixar espa√ßo para dispositivo completo)
                    if (yPos + qrSize + 10 > pageHeight - margin - 10) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    // Tentar obter QR Code como imagem
                    const qrContainer = document.getElementById(`qrCodeInline-${deviceId}`);
                    let qrAdded = false;
                    
                    if (qrContainer && qrContainer.querySelector('canvas')) {
                        try {
                            const canvas = qrContainer.querySelector('canvas');
                            if (canvas) {
                                // Converter canvas para imagem
                                const imgData = canvas.toDataURL('image/png');
                                
                                // Adicionar QR Code √† esquerda
                                doc.addImage(imgData, 'PNG', margin, yPos, qrSize, qrSize);
                                qrAdded = true;
                            }
                        } catch (error) {
                            console.error('Erro ao adicionar QR Code ao PDF:', error);
                        }
                    }
                    
                    if (!qrAdded) {
                        // Desenhar placeholder se QR Code n√£o dispon√≠vel
                        doc.setFillColor(240, 240, 240);
                        doc.rect(margin, yPos, qrSize, qrSize, 'F');
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.text('QR', margin + qrSize/2 - 3, yPos + qrSize/2);
                        doc.text('Code', margin + qrSize/2 - 5, yPos + qrSize/2 + 4);
                    }
                    
                    // Informa√ß√µes do dispositivo ao lado do QR Code
                    let infoY = yPos;
                    
                    // Nome do dispositivo (negrito, maior) - texto j√° limpo
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${i + 1}. ${deviceTitle}`, infoStartX, infoY);
                    infoY += 6;
                    
                    // Nome do evento (em destaque) - texto j√° limpo
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Evento: ${eventNameText}`, infoStartX, infoY);
                    infoY += 6;
                    
                    // Informa√ß√µes em duas colunas
                    const col1X = infoStartX;
                    const col2X = infoStartX + 60;
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Role: ${roleText}`, col1X, infoY);
                    doc.text(`Sessoes: ${sessionsText}`, col2X, infoY);
                    infoY += 6;
                    
                    doc.text(`PIN: ${pinText}`, col1X, infoY);
                    doc.text(`Checkpoint: ${checkpointText}`, col2X, infoY);
                    infoY += 6;
                    
                    doc.text(`Tipo: ${checkpointTypeText}`, col1X, infoY);
                    doc.text(`UUID: ${deviceId.substring(0, 10)}...`, col2X, infoY);
                    infoY += 6;
                    
                    // Linha informativa sobre QR Code
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Escaneie o QR Code para autenticacao automatica', col1X, infoY);
                    
                    // Avan√ßar Y para pr√≥ximo dispositivo (usar maior entre QR Code e informa√ß√µes)
                    yPos += Math.max(qrSize, infoY - yPos) + 10;
                    
                    // Linha separadora entre dispositivos
                    doc.setDrawColor(220, 220, 220);
                    doc.line(margin, yPos - 5, pageWidth - margin, yPos - 5);
                    yPos += 5;
                }
                
                // Rodap√©
                const totalPages = doc.internal.getNumberOfPages();
                for (let p = 1; p <= totalPages; p++) {
                    doc.setPage(p);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'italic');
                    doc.text(
                        `P√°gina ${p} de ${totalPages} - VisionKrono`,
                        pageWidth / 2,
                        pageHeight - 5,
                        { align: 'center' }
                    );
                }
                
                // Salvar PDF
                const fileName = `dispositivos_${currentEvent.name?.replace(/[^a-z0-9]/gi, '_') || currentEvent.id.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                console.log('‚úÖ PDF gerado com sucesso:', fileName);
                showSuccess('PDF gerado com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar PDF:', error);
                showError(`Erro ao gerar PDF: ${error.message}`);
            }
        }
        
        function showError(message) {
            alert(`‚ùå ${message}`);
        }
        
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) return;
            
            const isConnected = window.supabaseClient && window.supabaseClient.supabase && window.supabaseClient.isConnected;
            
            if (isConnected) {
                statusDiv.innerHTML = `
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></div>
                    <span style="color: var(--success);">Conectado</span>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--danger);"></div>
                    <span style="color: var(--danger);">Desconectado</span>
                `;
            }
            
            // Atualizar a cada 5 segundos
            setTimeout(updateConnectionStatus, 5000);
        }
        
        function showError(message) {
            alert(`‚ùå ${message}`);
        }
        
        function showSuccess(message) {
            alert(`‚úÖ ${message}`);
        }
    </script>
</body>
</html>
