<!DOCTYPE html>
<html lang="pt-PT" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivos - VisionKrono</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fc6b03">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VisionKrono">
    <meta name="description" content="Sistema de detec√ß√£o de dorsais VisionKrono">
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
        /* Layout with Sidebar Structure */
        .layout-with-sidebar {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
        }
        
        /* Sidebar styles */
        .layout-with-sidebar .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1050;
            overflow-y: auto;
            transition: transform var(--transition-slow);
        }
        
        /* Header styles */
        .layout-with-sidebar .header {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 1040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-5);
            transition: left var(--transition-slow);
        }
        
        /* Main content area */
        .layout-with-sidebar .main {
            margin-left: 280px;
            margin-top: 60px;
            width: calc(100% - 280px);
            min-height: calc(100vh - 60px);
            transition: margin-left var(--transition-slow), width var(--transition-slow);
        }
        
        /* Mobile adjustments */
        @media (max-width: 1024px) {
            body {
                overflow-x: hidden;
            }
            
            .layout-with-sidebar .sidebar {
                transform: translateX(-100%);
            }
            
            .layout-with-sidebar .sidebar.sidebar-open {
                transform: translateX(0);
            }
            
            .layout-with-sidebar .header {
                left: 0;
            }
            
            .layout-with-sidebar .main {
                margin-left: 0 !important;
                margin-top: 60px !important;
                width: 100% !important;
                min-height: calc(100vh - 60px) !important;
                padding-bottom: 80px !important;
            }
            
            /* Ensure content fills the screen */
            #mainContent {
                min-height: calc(100vh - 60px - 80px);
                padding: var(--spacing-4);
            }
            
            #menuToggle {
                display: block !important;
            }
            
            .app-bottom-nav {
                display: flex !important;
            }
        }
        
        /* Devices page styles */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .device-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-base), box-shadow var(--transition-base);
        }
        
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-4);
        }
        
        .device-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-1);
        }
        
        .device-id {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-family: var(--font-family-mono);
        }
        
        .device-status {
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-base);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }
        
        .status-online {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .status-offline {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .device-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-3);
            margin-top: var(--spacing-4);
            padding-top: var(--spacing-4);
            border-top: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .device-info {
                grid-template-columns: 1fr;
            }
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-1);
        }
        
        .info-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .device-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-4);
            flex-wrap: wrap;
        }
        
        .device-actions .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-12);
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-4);
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
        }
        
        .empty-state p {
            color: var(--text-secondary);
            max-width: 400px;
            margin-bottom: var(--spacing-4);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .device-info {
                grid-template-columns: 1fr;
            }
            
            .device-actions {
                flex-direction: column;
            }
            
            .device-actions .btn {
                width: 100%;
                min-width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- App Container -->
    <div class="layout-with-sidebar">
        <!-- Sidebar -->
        <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
        <div class="sidebar" id="sidebar"></div>
            
            <!-- Event Info Panel -->
            <div id="eventInfoPanel" style="padding: var(--spacing-4); border-top: 1px solid var(--border-color); display: none;">
                <div class="nav-category">Evento Atual</div>
                <div id="currentEventInfo" style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
        </nav>
        
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="header-title">üì± Dispositivos F√≠sicos</h1>
            </div>
            <div class="header-right">
                <div id="connectionStatus" style="font-size: var(--font-size-xs); padding: var(--spacing-2); border-radius: var(--radius-full); display: flex; align-items: center; gap: var(--spacing-1);">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--danger);"></div>
                    <span>Verificando...</span>
                </div>
                <button class="btn btn-sm btn-primary" id="addDeviceBtn">
                    <i>‚ûï</i> Adicionar Dispositivo
                </button>
                <button class="btn btn-sm btn-secondary" id="refreshDevices" title="Clique para recarregar do Supabase">
                    <i>üîÑ</i> Atualizar
                </button>
                <button class="btn btn-sm btn-secondary" onclick="window.location.reload()" title="Recarregar p√°gina completa">
                    <i>‚Üª</i> Reload
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main">
            <div style="flex: 1; overflow-y: auto; padding: var(--spacing-5);" id="mainContent">
                
                <!-- Info Section -->
                <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-4); margin-bottom: var(--spacing-5); border: 1px solid var(--border-color);">
                    <p style="margin: 0 0 var(--spacing-2) 0; color: var(--text-secondary); font-size: var(--font-size-sm);">
                        üì± Gerencie os <strong>dispositivos f√≠sicos</strong> (smartphones, tablets) associados ao evento.
                        Para configurar a <strong>ordem dos checkpoints</strong>, v√° em 
                        <a href="#" id="goToCheckpointOrder" style="color: var(--primary); text-decoration: underline;">Ordem dos Checkpoints</a>.
                    </p>
                    <p style="margin: var(--spacing-2) 0 0 0; padding-top: var(--spacing-2); border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: var(--font-size-xs);">
                        üîê <strong>Seguran√ßa:</strong> Cada dispositivo requer um PIN (4-6 d√≠gitos) para acesso. 
                        O operador ter√° que inserir o PIN ao abrir o link de detec√ß√£o.
                    </p>
                    <div id="debugInfo" style="margin-top: var(--spacing-3); padding: var(--spacing-2); background: var(--bg-primary); border-radius: var(--radius-base); font-size: var(--font-size-xs); color: var(--text-secondary); font-family: var(--font-family-mono);">
                        Event ID: <span id="debugEventId">...</span><br>
                        Query Status: <span id="debugQueryStatus">...</span><br>
                        Dispositivos Encontrados: <span id="debugDeviceCount">...</span>
                    </div>
                </div>
                
                <!-- Devices Grid -->
                <div id="devicesContainer">
                    <h3 style="margin: 0 0 var(--spacing-4) 0; color: var(--text-primary);">
                        üì± Dispositivos Associados
                    </h3>
                    <div class="devices-grid" id="devicesGrid">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üì±</div>
                    <h3>Nenhum dispositivo associado</h3>
                    <p>Adicione dispositivos f√≠sicos para come√ßar a capturar dorsais durante o evento.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('addDeviceBtn').click()">
                        ‚ûï Adicionar Primeiro Dispositivo
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="app-bottom-nav" id="bottomNav">
            <!-- Ser√° preenchido por navigation.js -->
        </nav>
    </div>
    
    <!-- Scripts -->
    <!-- Scripts de Autentica√ß√£o -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102601" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="/universal-route-protection.js?v=2025102618" defer></script>
    
    <!-- Devices Logic -->
    <script>
        let currentEvent = null;
        
        // Aguardar navega√ß√£o estar pronta
        async function waitForNavigation() {
            return new Promise((resolve) => {
                if (window.NavigationUtils) {
                    resolve();
                } else {
                    window.addEventListener('navigationReady', resolve);
                }
            });
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Aguardar Supabase
                if (window.supabaseClient?.init) {
                    await window.supabaseClient.init();
                    await window.supabaseClient.ready();
                }
                
                // Verificar autentica√ß√£o
                const autenticado = await verificarAutenticacao(['admin', 'moderator', 'event_manager']);
                if (!autenticado) return;
                
                console.log('üöÄ Inicializando p√°gina devices...');
                
                // Aguardar navega√ß√£o estar pronta
                await waitForNavigation();
                console.log('‚úÖ Navega√ß√£o pronta');
                
                // Get event from URL
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('event');
                const eventName = urlParams.get('eventName');
                
                if (!eventId) {
                    showError('Nenhum evento selecionado');
                    setTimeout(() => window.location.href = '/events', 2000);
                    return;
                }
                
                currentEvent = { id: eventId, name: eventName };
                
                // Atualizar contexto de evento
                if (window.navigationService) {
                    window.navigationService.setEventContext(eventId, eventName);
                }
                
                // Update UI
                updateEventInfo(eventName);
            
            // Verificar conex√£o Supabase
            console.log('üîç Verificando conex√£o Supabase...');
            console.log('  - window.supabaseClient:', !!window.supabaseClient);
            console.log('  - supabase:', !!window.supabaseClient?.supabase);
            console.log('  - isConnected:', window.supabaseClient?.isConnected);
            
            // Load devices
            await loadDevices();
            
            // Update connection status
            updateConnectionStatus();
            
                // Setup event listeners
                setupEventListeners();
                
                console.log('‚úÖ P√°gina inicializada');
                
            } catch (error) {
                console.error('‚ùå Erro fatal na inicializa√ß√£o:', error);
                const main = document.querySelector('.main');
                if (main) {
                    main.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h2 style="color: var(--danger);">Erro ao Carregar P√°gina</h2>
                            <p>${error.message}</p>
                            <button onclick="window.location.reload()" class="btn-primary">Recarregar</button>
                        </div>
                    `;
                }
            }
        });
        
        function setupEventListeners() {
            document.getElementById('addDeviceBtn').addEventListener('click', showAddDeviceModal);
            document.getElementById('refreshDevices').addEventListener('click', () => {
                console.log('üîÑ Refresh manual acionado');
                loadDevices();
            });
            
            // Link para checkpoint order
            document.getElementById('goToCheckpointOrder').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `/checkpoint-order?event=${currentEvent.id}&eventName=${encodeURIComponent(currentEvent.name)}`;
            });
            
            // Menu toggle mobile
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('sidebar-open');
                });
            }
        }
        
        function updateEventInfo(eventName) {
            document.getElementById('pageTitle').textContent = `üì± Dispositivos - ${eventName || 'Evento'}`;
            
            const eventInfoPanel = document.getElementById('eventInfoPanel');
            const currentEventInfo = document.getElementById('currentEventInfo');
            
            if (eventInfoPanel && eventName) {
                eventInfoPanel.style.display = 'block';
                currentEventInfo.innerHTML = `
                    <strong>${eventName}</strong><br>
                    Gest√£o de Dispositivos F√≠sicos
                `;
            }
        }
        
        async function loadDevices() {
            try {
                console.log('üìã loadDevices: Iniciando...');
                console.log('üìã Event ID:', currentEvent.id);
                
                // Update debug info
                if (document.getElementById('debugEventId')) {
                    document.getElementById('debugEventId').textContent = currentEvent.id;
                }
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.error('‚ùå Supabase n√£o dispon√≠vel');
                    if (document.getElementById('debugQueryStatus')) {
                        document.getElementById('debugQueryStatus').textContent = 'Supabase n√£o conectado';
                        document.getElementById('debugQueryStatus').style.color = 'var(--danger)';
                    }
                    showError('Supabase n√£o dispon√≠vel');
                    return;
                }
                
                console.log('‚úÖ Supabase dispon√≠vel, fazendo query...');
                console.log('üìä Query: SELECT * FROM event_devices WHERE event_id = ' + currentEvent.id);
                
                // Tentar query simples primeiro
                const { data: testData, error: testError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('*')
                    .eq('event_id', currentEvent.id);
                
                console.log('üß™ Teste query simples:');
                console.log('   Data:', testData);
                console.log('   Error:', testError);
                console.log('   Count:', testData?.length || 0);
                
                if (testError) {
                    console.error('‚ùå Erro em query simples - Poss√≠vel problema de RLS!');
                    showError('Erro de permiss√µes. Execute fix-rls-policies.sql no Supabase.');
                    return;
                }
                
                // Agora query com JOIN
                const { data: devices, error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select(`
                        *,
                        devices (
                            id,
                            device_name,
                            device_type,
                            status,
                            last_seen
                        )
                    `)
                    .eq('event_id', currentEvent.id)
                    .order('assigned_at', { ascending: true });
                
                console.log('üìä Resultado da query:');
                console.log('  - Error:', error);
                console.log('  - Devices:', devices);
                console.log('  - Quantidade:', devices?.length || 0);
                
                // Update debug info
                if (document.getElementById('debugQueryStatus')) {
                    document.getElementById('debugQueryStatus').textContent = error ? `Erro: ${error.message}` : 'Success';
                    document.getElementById('debugQueryStatus').style.color = error ? 'var(--danger)' : 'var(--success)';
                }
                if (document.getElementById('debugDeviceCount')) {
                    document.getElementById('debugDeviceCount').textContent = devices?.length || 0;
                    document.getElementById('debugDeviceCount').style.color = (devices?.length || 0) > 0 ? 'var(--success)' : 'var(--danger)';
                }
                
                if (error) {
                    console.error('‚ùå Erro na query:', error);
                    throw error;
                }
                
                // Log detalhado de cada dispositivo
                if (devices && devices.length > 0) {
                    console.log('üì± Dispositivos encontrados:');
                    devices.forEach((d, i) => {
                        console.log(`  ${i+1}. UUID: ${d.device_id}`);
                        console.log(`     Nome: ${d.devices?.device_name || 'N/A'}`);
                        console.log(`     Role: ${d.role}`);
                        console.log(`     Associado: ${d.assigned_at}`);
                    });
                } else {
                    console.log('‚ö†Ô∏è Nenhum dispositivo encontrado em event_devices para este evento');
                    console.log('üí° Execute no Supabase SQL:');
                    console.log(`   SELECT * FROM event_devices WHERE event_id = '${currentEvent.id}';`);
                }
                
                console.log('‚úÖ Renderizando', devices?.length || 0, 'dispositivos');
                renderDevices(devices || []);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dispositivos:', error);
                showError(`Erro ao carregar: ${error.message}`);
            }
        }
        
        function renderDevices(devices) {
            const grid = document.getElementById('devicesGrid');
            const container = document.getElementById('devicesContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (devices.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            grid.innerHTML = devices.map((device, index) => {
                const deviceInfo = device.devices || {};
                
                // Extrair nome original (remover sufixo _EventID_Timestamp)
                let displayName = deviceInfo.device_name || 'Dispositivo';
                const nameParts = displayName.split('_');
                if (nameParts.length >= 3) {
                    // Se tem formato Nome_EventID_Timestamp, pegar s√≥ o Nome
                    displayName = nameParts.slice(0, -2).join('_');
                }
                
                return `
                <div class="device-card">
                    <div class="device-header">
                        <div>
                            <div class="device-title">üì± ${displayName}</div>
                            <div class="device-id">UUID: ${device.device_id.substring(0, 12)}...</div>
                        </div>
                        <span class="device-status status-offline">
                            Offline
                        </span>
                    </div>
                    
                    <div class="device-info">
                        <div class="info-item">
                            <div class="info-label">Tipo</div>
                            <div class="info-value">${deviceInfo.device_type || 'mobile'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Role</div>
                            <div class="info-value">${device.role || 'detector'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">PIN</div>
                            <div class="info-value">${device.device_pin ? 'üîê ****' : 'üîì Sem PIN'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Sess√µes</div>
                            <div class="info-value">
                                <span style="color: ${(device.active_sessions || 0) >= (device.max_sessions || 1) ? 'var(--danger)' : 'var(--success)'}">
                                    ${device.active_sessions || 0}/${device.max_sessions || 1}
                                </span>
                                <button onclick="editMaxSessions('${device.device_id}', ${device.max_sessions || 1})" 
                                    style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; margin-left: 4px;" 
                                    title="Alterar limite de sess√µes">
                                    ‚úèÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- URL de Detec√ß√£o -->
                    <div style="margin-top: var(--spacing-4); padding-top: var(--spacing-4); border-top: 1px solid var(--border-color);">
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: var(--spacing-2);">üîó Link de Detec√ß√£o:</div>
                        <input type="text" readonly value="${window.location.origin}/detection?event=${currentEvent.id}&device=${device.device_id}&eventName=${encodeURIComponent(currentEvent.name)}" 
                            id="deviceUrl-${device.device_id}"
                            style="width: 100%; padding: var(--spacing-2); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-base); color: var(--text-primary); font-size: var(--font-size-xs); font-family: var(--font-family-mono); margin-bottom: var(--spacing-2);">
                        <div style="display: flex; gap: var(--spacing-2);">
                            <button class="btn btn-sm btn-primary" onclick="openDetection('${device.device_id}')">
                                <i>üì±</i> Abrir Detec√ß√£o
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="copyDeviceUrl('${device.device_id}')">
                                <i>üìã</i> Copiar URL
                            </button>
                        </div>
                    </div>
                    
                    <div class="device-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editDevicePin('${device.device_id}', '${device.device_pin || ''}')">
                            <i>üîê</i> ${device.device_pin ? 'Alterar PIN' : 'Definir PIN'}
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="clearDeviceSessions('${device.device_id}')" 
                            ${(device.active_sessions || 0) === 0 ? 'disabled' : ''}>
                            <i>üßπ</i> Limpar Sess√µes ${(device.active_sessions || 0) > 0 ? `(${device.active_sessions})` : ''}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeDevice('${device.device_id}')">
                            <i>üóëÔ∏è</i> Remover
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function showAddDeviceModal() {
            const deviceName = prompt('Digite o nome do dispositivo (ex: iPhone de Jo√£o, Samsung Galaxy):');
            
            if (!deviceName || deviceName.trim() === '') {
                showError('Nome do dispositivo √© obrigat√≥rio');
                return;
            }
            
            const devicePin = prompt('Digite um PIN de seguran√ßa (4-6 d√≠gitos):');
            
            if (!devicePin || devicePin.trim() === '') {
                showError('PIN √© obrigat√≥rio para seguran√ßa');
                return;
            }
            
            // Validar PIN (4-6 d√≠gitos)
            if (!/^\d{4,6}$/.test(devicePin)) {
                showError('PIN deve ter 4 a 6 d√≠gitos num√©ricos');
                return;
            }
            
            const maxSessions = prompt('Quantas sess√µes simult√¢neas permitir? (1-10):', '1');
            
            if (!maxSessions || isNaN(parseInt(maxSessions))) {
                showError('N√∫mero de sess√µes inv√°lido');
                return;
            }
            
            const sessionsLimit = parseInt(maxSessions);
            if (sessionsLimit < 1 || sessionsLimit > 10) {
                showError('N√∫mero de sess√µes deve ser entre 1 e 10');
                return;
            }
            
            addDevice(deviceName.trim(), devicePin, sessionsLimit);
        }
        
        async function addDevice(deviceName, devicePin, maxSessions) {
            try {
                console.log('üîÑ Iniciando adi√ß√£o de dispositivo:', deviceName);
                console.log('üîó Event ID:', currentEvent.id);
                console.log('üîê PIN definido:', devicePin ? '****' : 'Nenhum');
                console.log('üìä Max sess√µes:', maxSessions);
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    showError('Supabase n√£o conectado. Aguarde e tente novamente.');
                    return;
                }
                
                console.log('‚úÖ Supabase conectado');
                
                // Criar nome √∫nico global (event-specific)
                // Formato: "Nome_EventID_Timestamp" garante unicidade
                const uniqueDeviceName = `${deviceName}_${currentEvent.id.substring(0, 8)}_${Date.now()}`;
                
                console.log('üìù Criando dispositivo com nome √∫nico:', uniqueDeviceName);
                
                // Criar novo dispositivo espec√≠fico para este evento
                const { data: newDevice, error: deviceError } = await window.supabaseClient.supabase
                    .from('devices')
                    .insert([{
                        device_name: uniqueDeviceName, // Nome √∫nico globalmente
                        device_type: 'mobile',
                        status: 'active'
                    }])
                    .select()
                    .single();
                
                if (deviceError) {
                    console.error('‚ùå Erro ao criar device:', deviceError);
                    throw deviceError;
                }
                
                console.log('‚úÖ Dispositivo criado:', newDevice);
                console.log('üÜî UUID gerado:', newDevice.id);
                
                // Associar ao evento
                console.log('üîó Associando ao evento...');
                console.log('üìä Dados a inserir em event_devices:');
                console.log('   event_id:', currentEvent.id);
                console.log('   device_id:', newDevice.id);
                console.log('   role: detector');
                
                const { data: assocData, error: assocError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .insert([{
                        event_id: currentEvent.id,
                        device_id: newDevice.id,
                        role: 'detector',
                        device_pin: devicePin,
                        max_sessions: maxSessions || 1,
                        active_sessions: 0
                    }])
                    .select();
                
                console.log('üìä Resultado do INSERT em event_devices:');
                console.log('   Data:', assocData);
                console.log('   Error:', assocError);
                
                if (assocError) {
                    console.error('‚ùå Erro ao associar:', assocError);
                    console.error('   Code:', assocError.code);
                    console.error('   Message:', assocError.message);
                    console.error('   Details:', assocError.details);
                    throw assocError;
                }
                
                if (assocData && assocData.length > 0) {
                    console.log('‚úÖ Dispositivo associado ao evento!');
                    console.log('‚úÖ Registro criado:', assocData[0]);
                    console.log('   ID:', assocData[0].id);
                    console.log('   event_id:', assocData[0].event_id);
                    console.log('   device_id:', assocData[0].device_id);
                } else {
                    console.warn('‚ö†Ô∏è INSERT retornou sem erro mas sem dados');
                }
                
                // Verificar se foi realmente salvo (double-check)
                console.log('üîç Verificando se foi realmente salvo...');
                const { data: verification, error: verifyError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .select('*')
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', newDevice.id)
                    .single();
                
                console.log('üîç Verifica√ß√£o:');
                console.log('   Data:', verification);
                console.log('   Error:', verifyError);
                
                if (verification) {
                    console.log('‚úÖ‚úÖ CONFIRMADO: Dispositivo est√° em event_devices!');
                } else {
                    console.error('‚ùå‚ùå PROBLEMA: Dispositivo N√ÉO est√° em event_devices!');
                    console.error('   Poss√≠vel problema de RLS (Row Level Security)');
                }
                
                showSuccess(`Dispositivo "${deviceName}" adicionado ao evento com sucesso!`);
                
                // Recarregar lista
                console.log('üîÑ Recarregando lista de dispositivos...');
                await loadDevices();
                console.log('‚úÖ Lista recarregada');
                
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                showError(`Erro: ${error.message || error.code || 'Desconhecido'}`);
            }
        }
        
        async function editMaxSessions(deviceId, currentMax) {
            const newMax = prompt(`Quantas sess√µes simult√¢neas permitir? (1-10):`, currentMax || '1');
            
            if (newMax === null) return;
            
            const maxSessions = parseInt(newMax);
            
            if (isNaN(maxSessions) || maxSessions < 1 || maxSessions > 10) {
                showError('N√∫mero de sess√µes deve ser entre 1 e 10');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .update({ max_sessions: maxSessions })
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId);
                
                if (error) throw error;
                
                showSuccess(`Limite de sess√µes atualizado para ${maxSessions}!`);
                await loadDevices();
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar limite:', error);
                showError('Erro ao atualizar');
            }
        }
        
        async function editDevicePin(deviceId, currentPin) {
            const newPin = prompt(`${currentPin ? 'Alterar' : 'Definir'} PIN de seguran√ßa (4-6 d√≠gitos):`, currentPin || '');
            
            if (newPin === null) return; // Cancelado
            
            // Validar PIN
            if (newPin.trim() !== '' && !/^\d{4,6}$/.test(newPin)) {
                showError('PIN deve ter 4 a 6 d√≠gitos num√©ricos');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .update({ device_pin: newPin.trim() || null })
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId);
                
                if (error) throw error;
                
                if (newPin.trim()) {
                    showSuccess('PIN atualizado com sucesso!');
                } else {
                    showSuccess('PIN removido');
                }
                
                await loadDevices();
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar PIN:', error);
                showError('Erro ao atualizar PIN');
            }
        }
        
        function openDetection(deviceId) {
            const url = `/detection?event=${currentEvent.id}&device=${deviceId}&eventName=${encodeURIComponent(currentEvent.name)}`;
            window.open(url, '_blank');
        }
        
        function copyDeviceUrl(deviceId) {
            const input = document.getElementById(`deviceUrl-${deviceId}`);
            if (input) {
                input.select();
                document.execCommand('copy');
                showSuccess('URL copiado para √°rea de transfer√™ncia!');
            }
        }
        
        async function clearDeviceSessions(deviceId) {
            const confirmMessage = `‚ö†Ô∏è ATEN√á√ÉO! Isto ir√° encerrar TODAS as sess√µes ativas deste dispositivo.

Todos os operadores ativos ser√£o desconectados e ter√£o que inserir o PIN novamente.

Esta a√ß√£o √© √∫til quando:
‚Ä¢ Dispositivos ficaram "presos" (sess√µes n√£o encerraram)
‚Ä¢ Precisa libertar slots urgentemente
‚Ä¢ Quer resetar acessos

Digite "LIMPAR" (em mai√∫sculas) para confirmar:`;
            
            const confirmation = prompt(confirmMessage);
            
            if (confirmation !== 'LIMPAR') {
                showError('Limpeza cancelada. Digite exatamente "LIMPAR" para confirmar.');
                return;
            }
            
            try {
                console.log('üßπ Limpando sess√µes do dispositivo:', deviceId);
                
                // 1. Marcar todas as sess√µes como inativas
                const { error: sessionError } = await window.supabaseClient.supabase
                    .from('device_sessions')
                    .update({ 
                        is_active: false,
                        ended_at: new Date().toISOString()
                    })
                    .eq('device_id', deviceId)
                    .eq('event_id', currentEvent.id);
                
                if (sessionError && sessionError.code !== '42P01') { // Ignorar se tabela n√£o existe
                    console.warn('‚ö†Ô∏è Erro ao atualizar device_sessions:', sessionError);
                }
                
                // 2. Resetar contador active_sessions para 0
                const { error: updateError } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .update({ active_sessions: 0 })
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId);
                
                if (updateError) throw updateError;
                
                console.log('‚úÖ Sess√µes limpas');
                showSuccess('Todas as sess√µes foram encerradas! Operadores ter√£o que inserir PIN novamente.');
                
                await loadDevices();
                
            } catch (error) {
                console.error('‚ùå Erro ao limpar sess√µes:', error);
                showError('Erro ao limpar sess√µes');
            }
        }
        
        async function removeDevice(deviceId) {
            if (!confirm(`Tem certeza que deseja remover o dispositivo ${deviceId}?`)) {
                return;
            }
            
            try {
                const { error } = await window.supabaseClient.supabase
                    .from('event_devices')
                    .delete()
                    .eq('event_id', currentEvent.id)
                    .eq('device_id', deviceId);
                
                if (error) throw error;
                
                showSuccess('Dispositivo removido!');
                await loadDevices();
                
            } catch (error) {
                console.error('‚ùå Erro ao remover dispositivo:', error);
                showError('Erro ao remover dispositivo');
            }
        }
        
        function showError(message) {
            alert(`‚ùå ${message}`);
        }
        
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) return;
            
            const isConnected = window.supabaseClient && window.supabaseClient.supabase && window.supabaseClient.isConnected;
            
            if (isConnected) {
                statusDiv.innerHTML = `
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></div>
                    <span style="color: var(--success);">Conectado</span>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--danger);"></div>
                    <span style="color: var(--danger);">Desconectado</span>
                `;
            }
            
            // Atualizar a cada 5 segundos
            setTimeout(updateConnectionStatus, 5000);
        }
        
        function showError(message) {
            alert(`‚ùå ${message}`);
        }
        
        function showSuccess(message) {
            alert(`‚úÖ ${message}`);
        }
    </script>
</body>
</html>
