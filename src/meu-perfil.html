<!DOCTYPE html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Kromi.online</title>
    
    <!-- KROMI Design System -->
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    <link rel="stylesheet" href="/dashboard-styles.css?v=2025102609">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    <link rel="stylesheet" href="/logo-integration.css?v=2025012701">
</head>
<body data-theme="dark" class="layout-with-sidebar">
    <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
    <div class="sidebar" id="sidebar"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1 class="header-title">üë§ Meu Perfil</h1>
        </div>
        <div class="header-right">
            <!-- A√ß√µes do header se necess√°rio -->
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main">
        <div id="mainContent" style="padding: var(--spacing-6);">
                <div class="user-profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">U</div>
                        <div class="profile-info">
                            <h4 id="profileName">Nome do Utilizador</h4>
                            <p id="profileEmail">email@exemplo.com</p>
                            <span class="profile-badge" id="profileRole">admin</span>
                        </div>
                    </div>
                    
                    <div class="profile-details">
                        <h3>Informa√ß√µes Pessoais</h3>
                        
                        <form id="profileEditForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="profileEditName">Nome Completo</label>
                                    <input type="text" id="profileEditName" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileEditEmail">Email</label>
                                    <input type="email" id="profileEditEmail" name="email" readonly>
                                    <span class="helper-text">Email n√£o pode ser alterado</span>
                                </div>
                                <div class="form-group">
                                    <label for="profileEditPhone">Telefone</label>
                                    <input type="tel" id="profileEditPhone" name="phone" placeholder="+351 912 345 678">
                                </div>
                                <div class="form-group">
                                    <label for="profileEditOrganization">Organiza√ß√£o</label>
                                    <input type="text" id="profileEditOrganization" name="organization">
                                </div>
                            </div>
                            
                            <!-- Alterar Password -->
                            <div class="password-section">
                                <h4>üîë Alterar Palavra-passe</h4>
                                <div class="password-toggle">
                                    <input type="checkbox" id="changeMyPassword">
                                    <label for="changeMyPassword">Quero alterar minha palavra-passe</label>
                                </div>
                                <div id="myPasswordFields" style="display: none;">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="currentPassword">Palavra-passe Atual</label>
                                            <input type="password" id="currentPassword" name="currentPassword" autocomplete="current-password">
                                        </div>
                                        <div class="form-group">
                                            <label for="newPassword">Nova Palavra-passe</label>
                                            <input type="password" id="newPassword" name="newPassword" autocomplete="new-password" minlength="8">
                                        </div>
                                        <div class="form-group full-width">
                                            <label for="confirmPassword">Confirmar Nova Palavra-passe</label>
                                            <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password" minlength="8">
                                            <span class="helper-text">M√≠nimo 8 caracteres</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button type="submit" class="btn-primary">üíæ Guardar Altera√ß√µes</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Sess√µes Ativas -->
                    <div class="profile-sessions">
                        <h3>üîí Sess√µes Ativas</h3>
                        <div id="sessionsList"></div>
                        <button type="button" class="btn-secondary" onclick="logoutOthers()">
                            üóëÔ∏è Terminar Outras Sess√µes
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102601" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <!-- Logo Loader (carregar ANTES da navega√ß√£o, SEM defer para garantir ordem) -->
    <script src="/logo-loader.js?v=2025012702"></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="/universal-route-protection.js?v=2025102618" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar autentica√ß√£o (todos os perfis podem ver seu pr√≥prio perfil)
            const autenticado = await verificarAutenticacao(['admin', 'moderator', 'user']);
            if (!autenticado) return;
            
            loadProfileData();
            loadActiveSessions();
            
            // Toggle password fields
            const changePasswordCheckbox = document.getElementById('changeMyPassword');
            const passwordFields = document.getElementById('myPasswordFields');
            
            if (changePasswordCheckbox && passwordFields) {
                changePasswordCheckbox.addEventListener('change', function() {
                    passwordFields.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            // Form submit
            const profileForm = document.getElementById('profileEditForm');
            if (profileForm) {
                profileForm.addEventListener('submit', handleProfileUpdate);
            }
        });
        
        async function loadProfileData() {
            if (!window.authSystem) {
                // Aguardar authSystem estar pronto
                setTimeout(loadProfileData, 100);
                return;
            }
            
            // Aguardar perfil estar carregado
            if (!window.authSystem.userProfile) {
                // Aguardar mais um pouco
                setTimeout(loadProfileData, 100);
                return;
            }
            
            const profile = window.authSystem.userProfile;
            const user = window.authSystem.currentUser || { email: profile.email };
            
            // Atualizar header do perfil
            const displayName = profile.name || user.email || 'Utilizador';
            document.getElementById('profileName').textContent = displayName;
            document.getElementById('profileEmail').textContent = user.email || profile.email || '';
            document.getElementById('profileRole').textContent = profile.role || 'user';
            
            // Atualizar formul√°rio
            document.getElementById('profileEditName').value = profile.name || '';
            document.getElementById('profileEditEmail').value = user.email || profile.email || '';
            document.getElementById('profileEditPhone').value = profile.phone || '';
            document.getElementById('profileEditOrganization').value = profile.organization || '';
            
            // Atualizar avatar
            const avatar = document.getElementById('profileAvatar');
            avatar.textContent = displayName.charAt(0).toUpperCase();
        }
        
        async function loadActiveSessions() {
            if (!window.authSystem) {
                setTimeout(loadActiveSessions, 100);
                return;
            }
            
            try {
                const response = await fetch('/api/auth/sessions', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.error('Erro ao carregar sess√µes:', response.status);
                    return;
                }
                
                const data = await response.json();
                const sessions = data.sessions || [];
                const currentSessionId = data.currentSession || '';
                
                const container = document.getElementById('sessionsList');
                if (!container) return;
                
                if (sessions.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: var(--spacing-4);">Apenas esta sess√£o ativa</p>';
                } else {
                    container.innerHTML = sessions.map(session => {
                        const isCurrent = session.id && currentSessionId && session.id.includes(currentSessionId.substring(0, 8));
                        const createdAt = session.createdAt ? new Date(session.createdAt).toLocaleString('pt-PT') : 'N/A';
                        const lastActivity = session.lastActivity ? new Date(session.lastActivity).toLocaleString('pt-PT') : 'N/A';
                        const sessionId = session.id ? session.id.substring(0, 16) + '...' : 'N/A';
                        
                        return `
                            <div class="session-item" style="background: var(--bg-secondary); padding: var(--spacing-4); border-radius: var(--radius-md); margin-bottom: var(--spacing-2); border-left: 4px solid ${isCurrent ? 'var(--primary)' : 'var(--border-color)'};">
                                <div>
                                    <strong>Sess√£o:</strong> ${sessionId} ${isCurrent ? '<span style="color: var(--primary);">(Atual)</span>' : ''}<br>
                                    <small style="color: var(--text-secondary);">Criada: ${createdAt}</small><br>
                                    <small style="color: var(--text-secondary);">√öltima atividade: ${lastActivity}</small>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar sess√µes:', error);
                const container = document.getElementById('sessionsList');
                if (container) {
                    container.innerHTML = '<p style="color: var(--error);">Erro ao carregar sess√µes</p>';
                }
            }
        }
        
        async function handleProfileUpdate(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'üíæ A guardar...';
                
                const formData = new FormData(event.target);
                const changePassword = document.getElementById('changeMyPassword').checked;
                
                // Preparar dados do perfil
                const profileData = {
                    name: formData.get('name'),
                    phone: formData.get('phone') || null,
                    organization: formData.get('organization') || null
                };
                
                // Valida√ß√£o b√°sica
                if (!profileData.name || profileData.name.trim() === '') {
                    throw new Error('O nome √© obrigat√≥rio');
                }
                
                // Se quer alterar password, validar campos de password
                if (changePassword) {
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        throw new Error('Preencha todos os campos de palavra-passe');
                    }
                    
                    if (newPassword.length < 8) {
                        throw new Error('A nova palavra-passe deve ter pelo menos 8 caracteres');
                    }
                    
                    if (newPassword !== confirmPassword) {
                        throw new Error('As palavras-passe n√£o coincidem');
                    }
                }
                
                // Atualizar perfil
                const profileResponse = await fetch('/api/profile/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(profileData)
                });
                
                const profileResult = await profileResponse.json();
                
                if (!profileResponse.ok) {
                    throw new Error(profileResult.error || 'Erro ao atualizar perfil');
                }
                
                // Se quer alterar password, fazer isso tamb√©m
                if (changePassword) {
                    const passwordResponse = await fetch('/api/auth/password/change', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            currentPassword: document.getElementById('currentPassword').value,
                            newPassword: document.getElementById('newPassword').value,
                            confirmPassword: document.getElementById('confirmPassword').value
                        })
                    });
                    
                    const passwordResult = await passwordResponse.json();
                    
                    if (!passwordResponse.ok) {
                        throw new Error(passwordResult.error || 'Erro ao alterar palavra-passe');
                    }
                    
                    // Limpar campos de password
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    document.getElementById('changeMyPassword').checked = false;
                    document.getElementById('myPasswordFields').style.display = 'none';
                }
                
                // Atualizar dados na p√°gina
                if (window.authSystem && profileResult.user) {
                    window.authSystem.userProfile = profileResult.user;
                    loadProfileData();
                }
                
                // Mostrar mensagem de sucesso
                alert('Perfil atualizado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao atualizar perfil:', error);
                alert('Erro: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        async function logoutOthers() {
            if (!window.authSystem) return;
            
            if (!confirm('Tem certeza que deseja terminar todas as outras sess√µes? Voc√™ ser√° desconectado de outros dispositivos, mas permanecer√° conectado neste.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/auth/logout-others', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(data.message || 'Outras sess√µes terminadas com sucesso!');
                    await loadActiveSessions();
                } else {
                    throw new Error(data.error || 'Erro ao terminar outras sess√µes');
                }
            } catch (error) {
                console.error('Erro ao terminar outras sess√µes:', error);
                alert('Erro: ' + error.message);
            }
        }
        
        function logout() {
            if (window.authSystem) {
                window.authSystem.signOut();
            }
        }
    </script>
</body>
</html>

