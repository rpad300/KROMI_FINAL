<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionKrono - Mapa Live</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .layout {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }

        .header {
            background: #4F46E5;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .select {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .badge {
            background: rgba(255,255,255,0.2);
            padding: 0.375rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
        }

        .main {
            display: grid;
            grid-template-columns: 1fr 350px;
            height: 100%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            background: white;
            border-left: 1px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #E5E7EB;
            background: #F3F4F6;
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6B7280;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }

        .runners-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .runner-item {
            padding: 0.75rem;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .runner-item:hover {
            background: #F3F4F6;
            border-color: #4F46E5;
        }

        .runner-item.selected {
            background: #EEF2FF;
            border-color: #4F46E5;
        }

        .runner-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #111827;
        }

        .runner-bib {
            font-size: 0.75rem;
            color: #6B7280;
            display: inline-block;
            background: #F3F4F6;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
        }

        .runner-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .runner-stat {
            color: #6B7280;
        }

        .runner-stat strong {
            color: #111827;
        }

        .status-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.6875rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .status-running {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-paused {
            background: #FEF3C7;
            color: #92400E;
        }

        .no-runners {
            text-align: center;
            padding: 3rem 2rem;
            color: #6B7280;
        }

        .last-update {
            font-size: 0.6875rem;
            color: #9CA3AF;
        }

        /* Custom marker styles */
        .runner-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
        }

        .runner-marker.running {
            background: #10B981;
        }

        .runner-marker.paused {
            background: #F59E0B;
        }
    </style>
</head>
<body>
    <div class="layout">
        <div class="header">
            <h1>üó∫Ô∏è Mapa Live - Tracking em Tempo Real</h1>
            <div class="header-controls">
                <select id="route-filter" class="select">
                    <option value="">Todas as rotas</option>
                </select>
                <span class="badge" id="live-counter">0 atletas ativos</span>
                <span class="badge" id="last-update">Aguardando...</span>
            </div>
        </div>

        <div class="main">
            <div id="map"></div>
            
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">Atletas Ativos</div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-label">Em Corrida</div>
                            <div class="stat-value" id="stat-running">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Pausados</div>
                            <div class="stat-value" id="stat-paused">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="runners-list" id="runners-list">
                    <div class="no-runners">
                        <p>Nenhum atleta ativo no momento</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SUPABASE_URL = 'https://mdrvgbztadnluhrrnlob.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kcnZnYnp0YWRubHVocnJubG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5OTQ1MDUsImV4cCI6MjA3NjU3MDUwNX0.x2po57tZOQ443NLVURBWDIYQnYbJ4D6O45FlZ5qwmp4';
        const EVENT_ID = 'YOUR_EVENT_ID';
        const REFRESH_INTERVAL = 5000; // 5 segundos

        let supabase;
        let map;
        let markers = {};
        let selectedRunner = null;
        let realtimeChannel = null;

        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            // supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            initMap();
            await loadRoutes();
            await loadLivePositions();
            
            // Atualizar periodicamente
            setInterval(loadLivePositions, REFRESH_INTERVAL);
            
            // Subscrever a mudan√ßas em tempo real
            subscribeToUpdates();
            
            // Event listeners
            document.getElementById('route-filter').addEventListener('change', loadLivePositions);
        });

        function initMap() {
            // Inicializar mapa centrado em Lisboa (ajustar conforme necess√°rio)
            map = L.map('map').setView([38.7223, -9.1393], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        async function loadRoutes() {
            try {
                const { data, error } = await supabase
                    .from('track_routes')
                    .select('id, name')
                    .eq('event_id', EVENT_ID)
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('route-filter');
                data.forEach(route => {
                    const option = document.createElement('option');
                    option.value = route.id;
                    option.textContent = route.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar rotas:', error);
            }
        }

        async function loadLivePositions() {
            const routeFilter = document.getElementById('route-filter').value;
            
            try {
                const { data, error } = await supabase.rpc('track_get_live_positions', {
                    p_event_id: EVENT_ID,
                    p_route_id: routeFilter || null
                });

                if (error) throw error;

                updateMap(data);
                updateSidebar(data);
                updateStats(data);
                updateLastUpdate();
            } catch (error) {
                console.error('Erro ao carregar posi√ß√µes:', error);
            }
        }

        function updateMap(runners) {
            // Remover markers de atletas que n√£o est√£o mais ativos
            const activeIds = new Set(runners.map(r => r.activity_id));
            Object.keys(markers).forEach(id => {
                if (!activeIds.has(id)) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
            });

            // Atualizar ou criar markers
            runners.forEach(runner => {
                if (!runner.lat || !runner.lng) return;

                const position = [runner.lat, runner.lng];
                
                if (markers[runner.activity_id]) {
                    // Atualizar posi√ß√£o existente
                    markers[runner.activity_id].setLatLng(position);
                } else {
                    // Criar novo marker
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="runner-marker ${runner.status}">${runner.bib_number || '?'}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    const marker = L.marker(position, { icon })
                        .bindPopup(createPopupContent(runner))
                        .addTo(map);

                    marker.on('click', () => selectRunner(runner.activity_id));
                    markers[runner.activity_id] = marker;
                }
            });

            // Ajustar bounds se houver markers
            if (runners.length > 0 && Object.keys(markers).length > 0) {
                const group = L.featureGroup(Object.values(markers));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function createPopupContent(runner) {
            return `
                <div style="min-width: 200px">
                    <strong>${runner.participant_name}</strong><br>
                    <small>Dorsal: #${runner.bib_number}</small><br>
                    <small>Rota: ${runner.route_name}</small><br>
                    <hr style="margin: 0.5rem 0">
                    <small>
                        ‚è±Ô∏è ${formatTime(runner.elapsed_sec)}<br>
                        üèÉ ${runner.speed_kmh ? runner.speed_kmh.toFixed(1) + ' km/h' : '-'}<br>
                        üìç √öltima atualiza√ß√£o: ${new Date(runner.last_update).toLocaleTimeString('pt-PT')}
                    </small>
                </div>
            `;
        }

        function updateSidebar(runners) {
            const list = document.getElementById('runners-list');
            
            if (runners.length === 0) {
                list.innerHTML = '<div class="no-runners"><p>Nenhum atleta ativo no momento</p></div>';
                return;
            }

            list.innerHTML = runners.map(runner => `
                <div class="runner-item ${selectedRunner === runner.activity_id ? 'selected' : ''}" 
                     onclick="selectRunner('${runner.activity_id}')">
                    <div class="runner-name">
                        ${runner.participant_name}
                        <span class="status-badge status-${runner.status}">${runner.status === 'running' ? 'Em Corrida' : 'Pausado'}</span>
                    </div>
                    <span class="runner-bib">#${runner.bib_number}</span>
                    <span style="font-size: 0.75rem; color: #6B7280"> ‚Ä¢ ${runner.route_name}</span>
                    
                    <div class="runner-stats">
                        <div class="runner-stat">‚è±Ô∏è <strong>${formatTime(runner.elapsed_sec)}</strong></div>
                        <div class="runner-stat">üèÉ <strong>${runner.speed_kmh ? runner.speed_kmh.toFixed(1) : '-'} km/h</strong></div>
                    </div>
                    
                    <div class="last-update">
                        Atualizado ${getRelativeTime(runner.last_update)}
                    </div>
                </div>
            `).join('');
        }

        function updateStats(runners) {
            const running = runners.filter(r => r.status === 'running').length;
            const paused = runners.filter(r => r.status === 'paused').length;
            
            document.getElementById('stat-running').textContent = running;
            document.getElementById('stat-paused').textContent = paused;
            document.getElementById('live-counter').textContent = `${runners.length} atleta${runners.length !== 1 ? 's' : ''} ativo${runners.length !== 1 ? 's' : ''}`;
        }

        function updateLastUpdate() {
            document.getElementById('last-update').textContent = `Atualizado ${new Date().toLocaleTimeString('pt-PT')}`;
        }

        function selectRunner(activityId) {
            selectedRunner = activityId;
            
            if (markers[activityId]) {
                map.setView(markers[activityId].getLatLng(), 16);
                markers[activityId].openPopup();
            }
            
            // Atualizar sidebar
            document.querySelectorAll('.runner-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget?.classList.add('selected');
        }

        function subscribeToUpdates() {
            // Subscrever a novos pontos GPS
            realtimeChannel = supabase
                .channel('gps-updates')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'track_gps_live'
                    },
                    (payload) => {
                        console.log('Novo ponto GPS:', payload.new);
                        // Recarregar posi√ß√µes
                        loadLivePositions();
                    }
                )
                .subscribe();
        }

        // Utilidades
        function formatTime(seconds) {
            if (!seconds) return '-';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function getRelativeTime(timestamp) {
            if (!timestamp) return 'nunca';
            const diff = Date.now() - new Date(timestamp).getTime();
            const seconds = Math.floor(diff / 1000);
            
            if (seconds < 10) return 'agora mesmo';
            if (seconds < 60) return `h√° ${seconds}s`;
            if (seconds < 3600) return `h√° ${Math.floor(seconds / 60)}min`;
            return `h√° ${Math.floor(seconds / 3600)}h`;
        }
    </script>
</body>
</html>

