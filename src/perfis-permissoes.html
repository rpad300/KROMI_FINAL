<!DOCTYPE html>
<html lang="pt" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfis & Permiss√µes - Kromi.online</title>
    
    <link rel="stylesheet" href="/kromi-design-system.css">
    <link rel="stylesheet" href="/kromi-layout-fixes.css">
    <link rel="stylesheet" href="/dashboard-styles.css?v=2025102609">
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <link rel="stylesheet" href="/navigation-component.css?v=2025102601">
    <link rel="stylesheet" href="/unified-sidebar-styles.css?v=2025102601">
    
    <!-- Logo Integration Styles -->
    <link rel="stylesheet" href="/logo-integration.css?v=2025012701">
    
    <style>
        /* Dashboard Stats Cards */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            transition: all var(--transition-base);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            min-width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--radius-md);
        }
        
        .stat-info {
            flex: 1;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-1);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Section styling */
        .section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
            margin-bottom: var(--spacing-5);
        }
        
        .section h3 {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-5) 0;
            padding-bottom: var(--spacing-3);
            border-bottom: 2px solid var(--border-color);
        }
        
        /* Role description cards */
        .role-description {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-5);
            margin-bottom: var(--spacing-4);
            transition: all var(--transition-base);
        }
        
        .role-description:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(252, 107, 3, 0.1);
        }
        
        .role-description h4 {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 var(--spacing-3) 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .role-description p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-4);
            line-height: 1.6;
        }
        
        .role-description ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-2);
        }
        
        .role-description li {
            padding: var(--spacing-2);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        /* Users List */
        .users-list {
            display: grid;
            gap: var(--spacing-3);
        }
        
        .user-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            transition: all var(--transition-base);
        }
        
        .user-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(252, 107, 3, 0.1);
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .user-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-1);
        }
        
        .user-email {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .user-role-badge {
            display: inline-block;
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .user-role-badge.admin {
            background: rgba(252, 107, 3, 0.2);
            color: var(--primary);
        }
        
        .user-role-badge.moderator {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .user-role-badge.user {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }
        
        .user-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .btn-icon {
            padding: var(--spacing-2);
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            padding: var(--spacing-5);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--transition-base);
        }
        
        .modal-close:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: var(--spacing-5);
        }
        
        .user-info-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            padding: var(--spacing-4);
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-5);
        }
        
        .user-avatar-large {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .user-info-text h4 {
            margin: 0 0 var(--spacing-1) 0;
            color: var(--text-primary);
        }
        
        .user-info-text p {
            margin: 0;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }
        
        .form-group {
            margin-bottom: var(--spacing-4);
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-2);
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .form-group select {
            width: 100%;
            padding: var(--spacing-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }
        
        .helper-text {
            display: block;
            margin-top: var(--spacing-1);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .modal-footer {
            padding: var(--spacing-5);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-3);
        }
        
        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-secondary);
        }
        
        .loading-state {
            text-align: center;
            padding: var(--spacing-6);
            color: var(--text-secondary);
        }
        
        /* Roles List */
        .roles-list {
            display: grid;
            gap: var(--spacing-3);
        }
        
        .role-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            transition: all var(--transition-base);
        }
        
        .role-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(252, 107, 3, 0.1);
        }
        
        .role-icon-display {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .role-info-details {
            flex: 1;
            min-width: 0;
        }
        
        .role-name-display {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-1);
            font-size: var(--font-size-lg);
        }
        
        .role-description-display {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-2);
        }
        
        .role-permissions-display {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-1);
        }
        
        .permission-tag {
            background: var(--bg-secondary);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-sm);
        }
        
        .role-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .role-info-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            padding: var(--spacing-4);
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-5);
        }
        
        .role-avatar-large {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .role-info-text h4 {
            margin: 0 0 var(--spacing-1) 0;
            color: var(--text-primary);
        }
        
        .role-info-text p {
            margin: 0;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }
        
        .permissions-list {
            display: grid;
            gap: var(--spacing-2);
            max-height: 300px;
            overflow-y: auto;
            padding: var(--spacing-3);
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }
        
        .permission-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .permission-item label {
            flex: 1;
            margin: 0;
            cursor: pointer;
            color: var(--text-primary);
        }
        
        .permission-description {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-left: var(--spacing-8);
        }
        
        @media (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .role-description ul {
                grid-template-columns: 1fr;
            }
            
            .user-card {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body data-theme="dark" class="layout-with-sidebar">
    <!-- Sidebar (renderizada automaticamente pelo NavigationComponent) -->
    <div class="sidebar" id="sidebar"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1 class="header-title">üîê Perfis & Permiss√µes</h1>
        </div>
        <div class="header-right">
            <!-- A√ß√µes do header se necess√°rio -->
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main">
        <div id="mainContent" style="padding: var(--spacing-6);">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon">üëë</div>
                        <div class="stat-info">
                            <div class="stat-value" id="adminCount">0</div>
                            <div class="stat-label">Administradores</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚öôÔ∏è</div>
                        <div class="stat-info">
                            <div class="stat-value" id="moderatorCount">0</div>
                            <div class="stat-label">Moderadores</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë§</div>
                        <div class="stat-info">
                            <div class="stat-value" id="userCount">0</div>
                            <div class="stat-label">Utilizadores</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Descri√ß√£o dos Perfis</h3>
                    
                    <div class="role-description">
                        <h4>üëë Administrador</h4>
                        <p>Acesso total ao sistema. Pode gerir utilizadores, eventos, configura√ß√µes e todas as funcionalidades.</p>
                        <ul>
                            <li>‚úÖ Gest√£o de Utilizadores</li>
                            <li>‚úÖ Gest√£o de Perfis e Permiss√µes</li>
                            <li>‚úÖ Configura√ß√µes do Sistema</li>
                            <li>‚úÖ Auditoria e Logs</li>
                            <li>‚úÖ Gest√£o de Eventos</li>
                            <li>‚úÖ Todas as funcionalidades</li>
                        </ul>
                    </div>
                    
                    <div class="role-description">
                        <h4>‚öôÔ∏è Moderador (Gestor de Eventos)</h4>
                        <p>Pode criar e gerir eventos, configurar dispositivos e gerir participantes.</p>
                        <ul>
                            <li>‚úÖ Criar e Editar Eventos</li>
                            <li>‚úÖ Configurar Dispositivos</li>
                            <li>‚úÖ Gerir Participantes</li>
                            <li>‚úÖ Ver Classifica√ß√µes</li>
                            <li>‚ùå Gest√£o de Utilizadores</li>
                            <li>‚ùå Configura√ß√µes do Sistema</li>
                        </ul>
                    </div>
                    
                    <div class="role-description">
                        <h4>üë§ Utilizador (Participante)</h4>
                        <p>Pode ver classifica√ß√µes e gerir sua pr√≥pria inscri√ß√£o.</p>
                        <ul>
                            <li>‚úÖ Ver Classifica√ß√µes</li>
                            <li>‚úÖ Ver Participantes</li>
                            <li>‚úÖ Editar Pr√≥prio Perfil</li>
                            <li>‚ùå Criar Eventos</li>
                            <li>‚ùå Configurar Sistema</li>
                            <li>‚ùå Gerir Outros Utilizadores</li>
                        </ul>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üìã Gest√£o de Utilizadores</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
                        Gerir perfis e permiss√µes dos utilizadores do sistema.
                    </p>
                    
                    <div id="usersList" class="users-list">
                        <div class="loading-state">Carregando utilizadores...</div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>‚öôÔ∏è Gest√£o de Perfis</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
                        Gerir e editar as permiss√µes de cada perfil (Admin, Moderador, Utilizador).
                    </p>
                    
                    <div id="rolesList" class="roles-list">
                        <div class="loading-state">Carregando perfis...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal de Edi√ß√£o de Permiss√µes do Utilizador -->
    <div id="editRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Permiss√µes do Utilizador</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-info-display">
                    <div class="user-avatar-large" id="modalUserAvatar">üë§</div>
                    <div class="user-info-text">
                        <h4 id="modalUserName">Nome do Utilizador</h4>
                        <p id="modalUserEmail">email@exemplo.com</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Perfil / Role</label>
                    <select id="modalUserRole" class="role-select">
                        <option value="user">üë§ Utilizador</option>
                        <option value="moderator">‚öôÔ∏è Moderador</option>
                        <option value="admin">üëë Administrador</option>
                    </select>
                    <span class="helper-text">Selecione o perfil do utilizador</span>
                </div>
                
                <div class="form-group">
                    <label>Estado da Conta</label>
                    <select id="modalUserStatus" class="status-select">
                        <option value="active">‚úÖ Ativo</option>
                        <option value="inactive">‚è∏Ô∏è Inativo</option>
                        <option value="suspended">üö´ Suspenso</option>
                    </select>
                    <span class="helper-text">Estado atual da conta</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveUserChanges()">
                    üíæ Guardar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edi√ß√£o de Permiss√µes do Perfil -->
    <div id="editProfilePermissionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Permiss√µes do Perfil</h3>
                <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="role-info-display">
                    <div class="role-avatar-large" id="modalRoleIcon">üëë</div>
                    <div class="role-info-text">
                        <h4 id="modalRoleName">Administrador</h4>
                        <p id="modalRoleDescription">Descri√ß√£o do perfil</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Permiss√µes Dispon√≠veis</label>
                    <div id="permissionsList" class="permissions-list">
                        <!-- Permiss√µes ser√£o carregadas aqui -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditProfileModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveProfilePermissions()">
                    üíæ Guardar Permiss√µes
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="/supabase.js?v=2025102605" defer></script>
    <script src="/auth-client.js?v=2025102616" defer></script>
    <script src="/auth-helper.js?v=2025102620" defer></script>
    
    <!-- Logo Loader (carregar ANTES da navega√ß√£o, SEM defer para garantir ordem) -->
    <script src="/logo-loader.js?v=2025012702"></script>
    
    <!-- Sistema de Navega√ß√£o Unificado -->
    <script src="/navigation-config.js?v=2025102601" defer></script>
    <script src="/navigation-service.js?v=2025102601" defer></script>
    <script src="/navigation-component.js?v=2025102601" defer></script>
    <script src="/navigation-init.js?v=2025102601" defer></script>
    
    <!-- Prote√ß√£o de Rotas -->
    <script src="/universal-route-protection.js?v=2025102618" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const autenticado = await verificarAutenticacao(['admin']);
            if (!autenticado) return;
            
            loadRoleStats();
            loadUsers();
            loadRoles();
        });
        
        async function loadRoleStats() {
            try {
                // Garantir que o Supabase est√° inicializado
                if (window.supabaseClient) {
                    if (!window.supabaseClient.initialized) {
                        console.log('‚è≥ Inicializando Supabase...');
                        await window.supabaseClient.init();
                    }
                }
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('‚ö†Ô∏è Supabase n√£o dispon√≠vel para estat√≠sticas');
                    return;
                }
                
                // Usar Supabase para contar por role
                const { data, error } = await window.supabaseClient.supabase
                    .from('user_profiles')
                    .select('role');
                
                if (error) throw error;
                
                const counts = {
                    admin: 0,
                    moderator: 0,
                    user: 0
                };
                
                data.forEach(profile => {
                    if (counts.hasOwnProperty(profile.role)) {
                        counts[profile.role]++;
                    }
                });
                
                document.getElementById('adminCount').textContent = counts.admin;
                document.getElementById('moderatorCount').textContent = counts.moderator;
                document.getElementById('userCount').textContent = counts.user;
                
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }
        
        // ==================== GEST√ÉO DE UTILIZADORES ====================
        
        let currentEditingUserId = null;
        
        async function loadUsers() {
            try {
                // Garantir que o Supabase est√° inicializado
                if (window.supabaseClient) {
                    if (!window.supabaseClient.initialized) {
                        await window.supabaseClient.init();
                    }
                }
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('‚ö†Ô∏è Supabase n√£o dispon√≠vel');
                    document.getElementById('usersList').innerHTML = 
                        '<div class="loading-state">‚ö†Ô∏è Erro ao carregar utilizadores</div>';
                    return;
                }
                
                // Buscar todos os utilizadores
                const { data, error } = await window.supabaseClient.supabase
                    .from('user_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    document.getElementById('usersList').innerHTML = 
                        '<div class="loading-state">Nenhum utilizador encontrado</div>';
                    return;
                }
                
                // Renderizar lista de utilizadores
                const usersHtml = data.map(user => `
                    <div class="user-card">
                        <div class="user-avatar">üë§</div>
                        <div class="user-info">
                            <div class="user-name">${user.name || user.email}</div>
                            <div class="user-email">${user.email}</div>
                        </div>
                        <div class="user-role-badge ${user.role}">
                            ${getRoleName(user.role)}
                        </div>
                        <div class="user-actions">
                            <button class="btn-icon" onclick="editUserRole('${user.id}', '${user.name || user.email}', '${user.email}', '${user.role}', '${user.status || 'active'}')" title="Editar permiss√µes">
                                ‚úèÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('usersList').innerHTML = usersHtml;
                
            } catch (error) {
                console.error('Erro ao carregar utilizadores:', error);
                document.getElementById('usersList').innerHTML = 
                    '<div class="loading-state">Erro ao carregar utilizadores</div>';
            }
        }
        
        function getRoleName(role) {
            const names = {
                'admin': 'üëë Admin',
                'moderator': '‚öôÔ∏è Moderador',
                'user': 'üë§ Utilizador'
            };
            return names[role] || role;
        }
        
        function editUserRole(userId, name, email, role, status) {
            currentEditingUserId = userId;
            
            // Preencher modal com dados do utilizador
            document.getElementById('modalUserName').textContent = name;
            document.getElementById('modalUserEmail').textContent = email;
            document.getElementById('modalUserRole').value = role;
            document.getElementById('modalUserStatus').value = status;
            
            // Mostrar modal
            document.getElementById('editRoleModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editRoleModal').classList.remove('active');
            currentEditingUserId = null;
        }
        
        async function saveUserChanges() {
            if (!currentEditingUserId) return;
            
            try {
                const newRole = document.getElementById('modalUserRole').value;
                const newStatus = document.getElementById('modalUserStatus').value;
                
                // Garantir que o Supabase est√° inicializado
                if (window.supabaseClient) {
                    if (!window.supabaseClient.initialized) {
                        await window.supabaseClient.init();
                    }
                }
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    alert('‚ùå Supabase n√£o dispon√≠vel');
                    return;
                }
                
                // Atualizar utilizador
                const { error } = await window.supabaseClient.supabase
                    .from('user_profiles')
                    .update({
                        role: newRole,
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentEditingUserId);
                
                if (error) throw error;
                
                alert('‚úÖ Permiss√µes atualizadas com sucesso!');
                
                // Recarregar lista de utilizadores e estat√≠sticas
                closeEditModal();
                loadUsers();
                loadRoleStats();
                
            } catch (error) {
                console.error('Erro ao atualizar utilizador:', error);
                alert('‚ùå Erro ao atualizar permiss√µes: ' + error.message);
            }
        }
        
        // ==================== GEST√ÉO DE PERFIS ====================
        
        let currentEditingRoleName = null;
        let currentEditingPermissions = [];
        
        // Defini√ß√µes de permiss√µes dispon√≠veis no sistema
        const ALL_PERMISSIONS = {
            'users': {
                'read_users': 'Ver utilizadores',
                'create_users': 'Criar utilizadores',
                'update_users': 'Editar utilizadores',
                'delete_users': 'Eliminar utilizadores'
            },
            'events': {
                'read_events': 'Ver eventos',
                'create_events': 'Criar eventos',
                'update_events': 'Editar eventos',
                'delete_events': 'Eliminar eventos'
            },
            'participants': {
                'read_participants': 'Ver participantes',
                'create_participants': 'Criar participantes',
                'update_participants': 'Editar participantes',
                'delete_participants': 'Eliminar participantes'
            },
            'detections': {
                'read_detections': 'Ver detec√ß√µes',
                'create_detections': 'Criar detec√ß√µes',
                'update_detections': 'Editar detec√ß√µes',
                'delete_detections': 'Eliminar detec√ß√µes'
            },
            'system': {
                'read_settings': 'Ver configura√ß√µes',
                'update_settings': 'Editar configura√ß√µes',
                'read_logs': 'Ver logs',
                'manage_permissions': 'Gerir permiss√µes'
            },
            'profile': {
                'read_own_profile': 'Ver pr√≥prio perfil',
                'update_own_profile': 'Editar pr√≥prio perfil'
            },
            'all': {
                '*': 'Acesso total ao sistema'
            }
        };
        
        async function loadRoles() {
            try {
                // Garantir que o Supabase est√° inicializado
                if (window.supabaseClient) {
                    if (!window.supabaseClient.initialized) {
                        await window.supabaseClient.init();
                    }
                }
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    console.log('‚ö†Ô∏è Supabase n√£o dispon√≠vel');
                    document.getElementById('rolesList').innerHTML = 
                        '<div class="loading-state">‚ö†Ô∏è Erro ao carregar perfis</div>';
                    return;
                }
                
                // Buscar todos os perfis
                const { data, error } = await window.supabaseClient.supabase
                    .from('role_definitions')
                    .select('*')
                    .order('role_name', { ascending: true });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    document.getElementById('rolesList').innerHTML = 
                        '<div class="loading-state">Nenhum perfil encontrado</div>';
                    return;
                }
                
                // Renderizar lista de perfis
                const rolesHtml = data.map(role => {
                    const permissionsList = typeof role.permissions === 'string' 
                        ? JSON.parse(role.permissions) 
                        : role.permissions || [];
                    
                    const permissionsDisplay = permissionsList.length > 0 
                        ? permissionsList.slice(0, 3).join(', ') + (permissionsList.length > 3 ? '...' : '')
                        : 'Sem permiss√µes espec√≠ficas';
                    
                    const roleIcon = role.role_name === 'admin' ? 'üëë' : 
                                   role.role_name === 'moderator' ? '‚öôÔ∏è' : 'üë§';
                    
                    return `
                        <div class="role-card">
                            <div class="role-icon-display">${roleIcon}</div>
                            <div class="role-info-details">
                                <div class="role-name-display">${role.display_name}</div>
                                <div class="role-description-display">${role.description || ''}</div>
                                <div class="role-permissions-display">
                                    ${permissionsList.length > 0 
                                        ? permissionsList.map(p => `<span class="permission-tag">${p}</span>`).join('') 
                                        : ''}
                                </div>
                            </div>
                            <div class="role-actions">
                                <button class="btn-icon" onclick="editProfilePermissions('${role.role_name}', '${escapeHtml(role.display_name)}', '${escapeHtml(role.description || '')}', ${JSON.stringify(permissionsList).replace(/"/g, '&quot;')})" title="Editar permiss√µes">
                                    ‚öôÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('rolesList').innerHTML = rolesHtml;
                
            } catch (error) {
                console.error('Erro ao carregar perfis:', error);
                document.getElementById('rolesList').innerHTML = 
                    '<div class="loading-state">Erro ao carregar perfis</div>';
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            return text.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        function editProfilePermissions(roleName, displayName, description, permissions) {
            currentEditingRoleName = roleName;
            currentEditingPermissions = permissions || [];
            
            // Preencher modal com dados do perfil
            document.getElementById('modalRoleName').textContent = displayName;
            document.getElementById('modalRoleDescription').textContent = description || 'Sem descri√ß√£o';
            
            const roleIcon = roleName === 'admin' ? 'üëë' : 
                           roleName === 'moderator' ? '‚öôÔ∏è' : 'üë§';
            document.getElementById('modalRoleIcon').textContent = roleIcon;
            
            // Renderizar lista de permiss√µes
            renderPermissionsChecklist(roleName === 'admin');
            
            // Mostrar modal
            document.getElementById('editProfilePermissionsModal').classList.add('active');
        }
        
        function renderPermissionsChecklist(isAdmin) {
            const container = document.getElementById('permissionsList');
            
            let html = '';
            
            // Se for admin, adicionar acesso total
            if (isAdmin) {
                html += `
                    <div class="permission-item">
                        <input type="checkbox" id="perm_all" checked disabled>
                        <label for="perm_all" style="color: var(--primary); font-weight: 600;">
                            * Acesso total ao sistema (Administrador)
                        </label>
                    </div>
                `;
            }
            
            // Adicionar todas as permiss√µes por categoria
            for (const [category, perms] of Object.entries(ALL_PERMISSIONS)) {
                if (isAdmin && category === 'all') continue; // J√° adicionado acima
                
                for (const [key, label] of Object.entries(perms)) {
                    const isChecked = isAdmin || currentEditingPermissions.includes(key);
                    const isDisabled = isAdmin && key !== '*';
                    
                    html += `
                        <div class="permission-item">
                            <input type="checkbox" id="perm_${key}" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} 
                                   ${!isAdmin ? `onchange="updatePermissionState('${key}')"` : ''}>
                            <label for="perm_${key}" ${!isAdmin ? `onclick="toggleCheckbox('perm_${key}')" style="cursor: pointer;"` : ''}>${label}</label>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
        }
        
        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id);
            if (checkbox && !checkbox.disabled) {
                checkbox.checked = !checkbox.checked;
                updatePermissionState(id.replace('perm_', ''));
            }
        }
        
        function updatePermissionState(permission) {
            const checkbox = document.getElementById(`perm_${permission}`);
            if (checkbox && checkbox.checked) {
                if (!currentEditingPermissions.includes(permission)) {
                    currentEditingPermissions.push(permission);
                }
            } else {
                const index = currentEditingPermissions.indexOf(permission);
                if (index > -1) {
                    currentEditingPermissions.splice(index, 1);
                }
            }
        }
        
        function closeEditProfileModal() {
            document.getElementById('editProfilePermissionsModal').classList.remove('active');
            currentEditingRoleName = null;
            currentEditingPermissions = [];
        }
        
        async function saveProfilePermissions() {
            if (!currentEditingRoleName) return;
            
            try {
                console.log('üíæ Salvando permiss√µes do perfil:', currentEditingRoleName);
                
                // Gerar array de permiss√µes baseado nos checkboxes
                const permissions = [];
                
                // N√£o processar se for admin (sempre tem acesso total)
                if (currentEditingRoleName !== 'admin') {
                    Object.values(ALL_PERMISSIONS).forEach(categoryPerms => {
                        Object.keys(categoryPerms).forEach(perm => {
                            const checkbox = document.getElementById(`perm_${perm}`);
                            if (checkbox && checkbox.checked && !checkbox.disabled) {
                                permissions.push(perm);
                            }
                        });
                    });
                } else {
                    permissions.push('*');
                }
                
                console.log('üìã Permiss√µes selecionadas:', permissions);
                
                // Garantir que o Supabase est√° inicializado
                if (window.supabaseClient) {
                    if (!window.supabaseClient.initialized) {
                        await window.supabaseClient.init();
                    }
                }
                
                if (!window.supabaseClient || !window.supabaseClient.supabase) {
                    alert('‚ùå Supabase n√£o dispon√≠vel');
                    return;
                }
                
                // Preparar dados para atualiza√ß√£o
                const updateData = {
                    permissions: permissions, // Passar array diretamente, Supabase far√° a convers√£o
                    updated_at: new Date().toISOString()
                };
                
                console.log('üîÑ Dados para atualizar:', updateData);
                
                // Verificar se o perfil existe
                const { data: existingRole, error: checkError } = await window.supabaseClient.supabase
                    .from('role_definitions')
                    .select('*')
                    .eq('role_name', currentEditingRoleName)
                    .single();
                
                if (checkError && checkError.code === 'PGRST116') {
                    console.log('‚ÑπÔ∏è Perfil n√£o existe, criando...');
                    
                    // Criar o perfil se n√£o existir
                    const { data: newRole, error: insertError } = await window.supabaseClient.supabase
                        .from('role_definitions')
                        .insert({
                            role_name: currentEditingRoleName,
                            display_name: getRoleDisplayName(currentEditingRoleName),
                            description: getRoleDescription(currentEditingRoleName),
                            permissions: permissions,
                            is_system_role: true,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .select()
                        .single();
                    
                    if (insertError) {
                        console.error('‚ùå Erro ao criar perfil:', insertError);
                        throw insertError;
                    }
                    
                    console.log('‚úÖ Perfil criado:', newRole);
                    alert('‚úÖ Perfil criado e permiss√µes salvos com sucesso!');
                } else if (checkError) {
                    console.error('‚ùå Erro ao verificar perfil:', checkError);
                    throw checkError;
                } else {
                    console.log('‚ÑπÔ∏è Perfil existe, atualizando...');
                    console.log('üîÑ Update query:', { role_name: currentEditingRoleName, updateData });
                    
                    // Atualizar perfil existente
                    const { data, error } = await window.supabaseClient.supabase
                        .from('role_definitions')
                        .update(updateData)
                        .eq('role_name', currentEditingRoleName)
                        .select();
                    
                    if (error) {
                        console.error('‚ùå Erro do Supabase:', error);
                        throw error;
                    }
                    
                    console.log('‚úÖ Resposta da atualiza√ß√£o:', { data, errorCount: error ? 1 : 0 });
                    
                    if (!data || data.length === 0) {
                        console.warn('‚ö†Ô∏è Nenhuma linha atualizada.');
                        console.warn('‚ö†Ô∏è RLS bloqueando UPDATE, tentando via servidor...');
                        
                        // Tentar atualizar via servidor (Service Role Key)
                        try {
                            const serverUpdate = await fetch('/api/roles/update-permissions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include',
                                body: JSON.stringify({
                                    role_name: currentEditingRoleName,
                                    permissions: permissions
                                })
                            });
                            
                            const serverResult = await serverUpdate.json();
                            
                            if (serverUpdate.ok && serverResult.success) {
                                console.log('‚úÖ Atualizado via servidor:', serverResult);
                                alert('‚úÖ Permiss√µes do perfil atualizadas com sucesso!');
                            } else {
                                throw new Error(serverResult.error || 'Erro desconhecido');
                            }
                        } catch (serverError) {
                            console.error('‚ùå Erro ao atualizar via servidor:', serverError);
                            alert('‚ùå Erro ao atualizar permiss√µes. Verifique as pol√≠ticas RLS ou contacte o administrador.');
                        }
                    } else {
                        alert('‚úÖ Permiss√µes do perfil atualizadas com sucesso!');
                    }
                }
                
                // Recarregar lista de perfis
                closeEditProfileModal();
                await loadRoles();
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar permiss√µes do perfil:', error);
                alert('‚ùå Erro ao atualizar permiss√µes: ' + (error.message || error));
            }
        }
        
        function getRoleDisplayName(roleName) {
            const names = {
                'admin': 'Administrador',
                'moderator': 'Moderador',
                'user': 'Utilizador'
            };
            return names[roleName] || roleName;
        }
        
        function getRoleDescription(roleName) {
            const descriptions = {
                'admin': 'Acesso completo ao sistema',
                'moderator': 'Gest√£o de eventos e participantes',
                'user': 'Acesso b√°sico ao sistema'
            };
            return descriptions[roleName] || '';
        }
        
        function logout() {
            if (window.authSystem) {
                window.authSystem.signOut();
            }
        }
    </script>
</body>
</html>

